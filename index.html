<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE SHED | The Musician's Workstation</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['Merriweather', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'shed-black': '#1a1a1a',
                        'shed-orange': '#ea580c',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-serif { font-family: 'Merriweather', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .drop-cap::first-letter {
            float: left;
            font-size: 3.5rem;
            line-height: 0.8;
            font-weight: 900;
            margin-right: 0.5rem;
            margin-top: -0.2rem;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: #ea580c;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: #e5e7eb; border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #44403c;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-900 dark:bg-stone-950 dark:text-stone-100 transition-colors duration-300 pb-24">

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col relative">
        <!-- Content injected via JS -->
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // THE SHED - v2.0 (Studio Upgrade)
        // --- AUDIO ENGINE (Web Audio API) ---
        class SoundEngine {
            constructor() {
                this.ctx = null;
                // Audio Graph
                this.masterGain = null;
                this.compressor = null;
                this.reverbNode = null;
                this.reverbGain = null;
                this.impulseBuffer = null;

                // Parameters
                this.reverbAmount = 0.4;
                this.strumSpeed = 0.05;
                this.brightness = 5000;

                // Drone
                this.droneOsc = null;
                this.droneGain = null;
                // Metronome
                this.metronomeInterval = null;
                this.nextNoteTime = 0;
                this.tempo = 100;
                // Backing Track
                this.trackInterval = null;
                this.currentChordIndex = 0;
                this.beatsInCurrentChord = 0;
                this.beatCount = 0;
                this.nextChordTime = 0;
                this.isPlayingMetronome = false;
                this.isPlayingDrone = false;
                this.isPlayingTrack = false;
                this.isScaleDisplayPaused = false;
                this.droneNote = 'A2';
                this.activeTrack = null;
                this.instrument = 'triangle'; // Default instrument
                this.workletReady = false;

                // Global Recording State
                this.globalRecorder = null;
                this.globalChunks = [];
                this.isGlobalRecording = false;
                this.recordingStreamDest = null;
            }

            async init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.setupAudioGraph();
                    await this.setupWorklet();
                }
                if (this.ctx.state === 'suspended') {
                    await this.ctx.resume();
                }
            }

            async setupWorklet() {
                try {
                    // Try to load the worklet. If running on file:// this may fail.
                    await this.ctx.audioWorklet.addModule('src/worklet.js');
                    this.workletReady = true;
                    console.log("SHED High-Quality Audio Engine Loaded.");
                } catch (e) {
                    console.warn("Worklet failed to load (CORS/file://?), using standard engine.", e);
                    this.workletReady = false;
                }
            }

            setupAudioGraph() {
                // Create a destination for the global recorder
                this.recordingStreamDest = this.ctx.createMediaStreamDestination();

                // Master Bus -> Compressor -> Destination
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.6; 

                this.compressor = this.ctx.createDynamicsCompressor();
                this.compressor.threshold.value = -20;
                this.compressor.knee.value = 30;
                this.compressor.ratio.value = 12;
                this.compressor.attack.value = 0.003;
                this.compressor.release.value = 0.25;

                // Reverb Chain
                this.reverbGain = this.ctx.createGain();
                this.reverbGain.gain.value = this.reverbAmount; 
                this.reverbNode = this.ctx.createConvolver();
                this.reverbNode.buffer = this.createImpulseResponse();

                // Connections
                this.masterGain.connect(this.compressor);
                this.compressor.connect(this.ctx.destination);
                
                // ALSO connect compressor to our recording destination
                this.compressor.connect(this.recordingStreamDest);
                
                // Reverb Send (Parallel)
                this.reverbGain.connect(this.reverbNode);
                this.reverbNode.connect(this.compressor); 
            }

            toggleGlobalRecording() {
                this.init();
                if (this.isGlobalRecording) {
                    this.stopGlobalRecording();
                } else {
                    this.startGlobalRecording();
                }
            }

            startGlobalRecording() {
                this.globalChunks = [];
                this.globalRecorder = new MediaRecorder(this.recordingStreamDest.stream);
                this.globalRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) this.globalChunks.push(e.data);
                };
                this.globalRecorder.onstop = () => {
                    const blob = new Blob(this.globalChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TheShed_Session_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
                    a.click();
                };
                this.globalRecorder.start();
                this.isGlobalRecording = true;
                render();
            }

            stopGlobalRecording() {
                if (this.globalRecorder && this.isGlobalRecording) {
                    this.globalRecorder.stop();
                    this.isGlobalRecording = false;
                    render();
                }
            }

            setReverb(val) {
                this.reverbAmount = parseFloat(val);
                if (this.reverbGain) {
                    this.reverbGain.gain.cancelScheduledValues(this.ctx.currentTime);
                    this.reverbGain.gain.linearRampToValueAtTime(this.reverbAmount, this.ctx.currentTime + 0.1);
                }
            }

            setStrum(val) {
                this.strumSpeed = parseFloat(val);
            }

            setBrightness(val) {
                this.brightness = parseFloat(val);
            }

            createImpulseResponse() {
                const rate = this.ctx.sampleRate;
                const length = rate * 2.5; // Longer tail
                const decay = 2.0;
                const impulse = this.ctx.createBuffer(2, length, rate);
                const impulseL = impulse.getChannelData(0);
                const impulseR = impulse.getChannelData(1);

                for (let i = 0; i < length; i++) {
                    const n = i / length;
                    const env = Math.pow(1 - n, decay);
                    // Stereo noise
                    impulseL[i] = (Math.random() * 2 - 1) * env;
                    impulseR[i] = (Math.random() * 2 - 1) * env;
                }
                return impulse;
            }

            // --- DRONE ---
            getFreq(note) {
                const notes = { 
                    'C2': 65.41, 'D2': 73.42, 'E2': 82.41, 'F2': 87.31, 'G2': 98.00, 'A2': 110.00, 'B2': 123.47,
                    'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
                    'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88
                };
                return notes[note] || 110.00;
            }

            async toggleDrone(note) {
                await this.init();
                if (this.isPlayingDrone) {
                    this.stopDrone();
                    if (this.droneNote !== note) {
                        this.droneNote = note;
                        this.startDrone();
                    }
                } else {
                    this.droneNote = note;
                    this.startDrone();
                }
            }

            startDrone() {
                if (this.workletReady) {
                    // --- HIGH QUALITY RUST-STYLE ENGINE ---
                    this.droneOsc = new AudioWorkletNode(this.ctx, 'shed-processor', {
                        parameterData: {
                            frequency: this.getFreq(this.droneNote),
                            cutoff: 400,
                            resonance: 0.6
                        }
                    });
                    this.droneGain = this.ctx.createGain();
                    this.droneGain.gain.value = 0.15;
                    this.droneOsc.connect(this.droneGain);
                    this.droneGain.connect(this.ctx.destination);
                } else {
                    // --- FALLBACK TO STANDARD ---
                    this.droneOsc = this.ctx.createOscillator();
                    this.droneOsc.type = 'sawtooth';
                    this.droneOsc.frequency.value = this.getFreq(this.droneNote);
                    
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 400;

                    this.droneGain = this.ctx.createGain();
                    this.droneGain.gain.value = 0.15;

                    this.droneOsc.connect(filter);
                    filter.connect(this.droneGain);
                    this.droneGain.connect(this.ctx.destination); 
                }
                
                this.droneOsc.start();
                this.isPlayingDrone = true;
                renderToolbar();
            }

            stopDrone() {
                if (this.droneOsc) {
                    const now = this.ctx.currentTime;
                    this.droneGain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                    
                    if (this.droneOsc.stop) {
                        this.droneOsc.stop(now + 0.5);
                    } else {
                        // For AudioWorkletNode, just disconnect after ramp
                        setTimeout(() => {
                            if (this.droneOsc) this.droneOsc.disconnect();
                            this.droneOsc = null;
                        }, 500);
                    }
                    
                    if (this.droneOsc && this.droneOsc.stop) this.droneOsc = null;
                }
                this.isPlayingDrone = false;
                renderToolbar();
            }

            // --- METRONOME ---
            toggleMetronome() {
                this.init();
                this.isPlayingMetronome = !this.isPlayingMetronome;
                if (this.isPlayingMetronome) {
                    this.nextNoteTime = this.ctx.currentTime;
                    this.scheduler();
                } else {
                    clearTimeout(this.metronomeInterval);
                }
                renderToolbar();
            }

            scheduler() {
                const lookahead = 25.0; 
                const scheduleAheadTime = 0.1;

                while (this.nextNoteTime < this.ctx.currentTime + scheduleAheadTime) {
                    this.scheduleMetronomeNote(this.nextNoteTime);
                    this.nextNote();
                }
                this.metronomeInterval = setTimeout(() => this.scheduler(), lookahead);
            }

            nextNote() {
                const secondsPerBeat = 60.0 / this.tempo;
                this.nextNoteTime += secondsPerBeat;
            }

            scheduleMetronomeNote(time) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.value = 1000;
                gain.gain.value = 0.1; 
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(time);
                osc.stop(time + 0.05);
            }

            setTempo(bpm) {
                this.tempo = bpm;
                renderToolbar();
                if (appState.view === 'jam') render(); 
            }

            setInstrument(type) {
                this.instrument = type;
            }

            // --- JAM STATION (Backing Tracks) ---
            playBackingTrack(track) {
                this.init();
                // If switching tracks, stop current
                if (this.isPlayingTrack) {
                    this.stopBackingTrack();
                    if (this.activeTrack && this.activeTrack.id === track.id) {
                        return; // Just stop if it was same track
                    }
                }
                
                this.activeTrack = track;
                this.isPlayingTrack = true;
                this.currentChordIndex = 0;
                this.beatsInCurrentChord = 0;
                this.beatCount = 0;
                this.nextChordTime = this.ctx.currentTime + 0.1;
                this.tempo = track.bpm;
                
                render(); 
                this.trackScheduler();
            }

            stopBackingTrack() {
                clearTimeout(this.trackInterval);
                this.isPlayingTrack = false;
                this.activeTrack = null;
                this.isScaleDisplayPaused = false;
                render();
            }

            toggleScalePause() {
                this.isScaleDisplayPaused = !this.isScaleDisplayPaused;
                render();
            }

            trackScheduler() {
                const lookahead = 50.0;
                const scheduleAheadTime = 0.1;

                while (this.nextChordTime < this.ctx.currentTime + scheduleAheadTime) {
                    if (!this.activeTrack) return;

                    // Calculate total beats elapsed to determine chord changes
                    const totalBeatsInProgression = this.activeTrack.progression.reduce((sum, chord) => sum + chord.beats, 0);
                    const beatInProgression = this.beatCount % totalBeatsInProgression;

                    // Calculate which chord we should be on
                    let beatsAccumulated = 0;
                    let newChordIndex = 0;
                    for (let i = 0; i < this.activeTrack.progression.length; i++) {
                        beatsAccumulated += this.activeTrack.progression[i].beats;
                        if (beatInProgression < beatsAccumulated) {
                            newChordIndex = i;
                            break;
                        }
                    }

                    // Update current chord index if changed
                    if (newChordIndex !== this.currentChordIndex) {
                        this.currentChordIndex = newChordIndex;
                        if (!this.isScaleDisplayPaused) render(); // Re-render to update scale panel
                    }

                    const chord = this.activeTrack.progression[this.currentChordIndex];
                    this.scheduleNote(chord, this.nextChordTime); // renamed from scheduleChord to keep it consistent
                    
                    if (!this.isScaleDisplayPaused) {
                        const drawTime = (this.nextChordTime - this.ctx.currentTime) * 1000;
                        const idx = this.currentChordIndex;
                        setTimeout(() => {
                            updateJamVisualizer(chord, idx);
                        }, Math.max(0, drawTime));
                    }

                    const beats = chord.beats; 
                    const secondsPerBeat = 60.0 / this.tempo;
                    this.nextChordTime += beats * secondsPerBeat;
                    this.beatCount += beats;
                }
                
                if(this.isPlayingTrack) {
                    this.trackInterval = setTimeout(() => this.trackScheduler(), lookahead);
                }
            }

            scheduleNote(chordObj, time) {
                const duration = (chordObj.beats * (60.0 / this.tempo)) - 0.1; 
                const notes = chordObj.notes; 

                // --- 10x SOUND UPGRADES ---
                
                notes.forEach((n, i) => {
                    const noteTime = time + (i * this.strumSpeed); // Dynamic Strum
                    const freq = this.getFreq(n);
                    
                    // Humanize Velocity
                    const velocity = 0.8 + (Math.random() * 0.4); 
                    const baseVol = i === 0 ? 0.2 : 0.15; // Root note louder
                    const finalVol = baseVol * velocity;

                    // Dual Oscillator for Thickness (Detuned Chorus)
                    this.createVoice(freq, noteTime, duration, finalVol, 0); // Center
                    this.createVoice(freq * 1.004, noteTime, duration, finalVol * 0.5, -0.4); // Left-ish
                    this.createVoice(freq * 0.996, noteTime, duration, finalVol * 0.5, 0.4);  // Right-ish
                });
            }

            createVoice(freq, time, duration, vol, pan) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const panner = this.ctx.createStereoPanner();

                osc.type = this.instrument; 
                osc.frequency.value = freq;
                panner.pan.value = pan;

                // Envelope (ADSR-ish)
                const attack = 0.02;
                const decay = 0.1;
                const sustain = 0.7;
                const release = 0.2;

                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(vol, time + attack);
                gain.gain.exponentialRampToValueAtTime(vol * sustain, time + attack + decay);
                gain.gain.exponentialRampToValueAtTime(0.001, time + duration + release);

                // Filter for warmer sound (Dynamic Brightness)
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(this.brightness, time); 
                filter.frequency.exponentialRampToValueAtTime(800, time + duration); // Sweeps down

                // Connections
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(panner);
                
                // Route to Master Effects Chain
                panner.connect(this.masterGain); // Dry path
                panner.connect(this.reverbGain); // Wet path

                osc.start(time);
                osc.stop(time + duration + release + 0.1);
            }
        }

        // --- STUDIO CONSTANTS ---
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const FREQUENCIES = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63, 'F': 349.23,
            'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
        };

        function getNoteFrequency(noteName) {
            // Parse note name: last character is octave, rest is note
            const note = noteName.slice(0, -1);  // e.g., "C", "C#", "A"
            const octave = parseInt(noteName.slice(-1));  // e.g., 3, 4, 5

            if (!FREQUENCIES[note]) {
                console.warn(`Unknown note: ${note}`);
                return 440; // fallback to A4
            }

            const baseFreq = FREQUENCIES[note];
            // FREQUENCIES are defined for octave 4, so adjust for other octaves
            const octaveMultiplier = Math.pow(2, octave - 4);
            return baseFreq * octaveMultiplier;
        }

        function transposeNote(noteName, semitones) {
            // Helper to transpose a note string (e.g. "C3") by semitones
            const note = noteName.slice(0, -1);
            const octave = parseInt(noteName.slice(-1));
            
            let idx = NOTES.indexOf(note);
            if (idx === -1) return noteName; // fallback

            let newIdx = idx + semitones;
            let octaveShift = Math.floor(newIdx / 12);
            newIdx = ((newIdx % 12) + 12) % 12; // handle negative wrap correctly

            return NOTES[newIdx] + (octave + octaveShift);
        }

        function getTransposedTrack(track, targetKey) {
            if (!track || !targetKey || track.key === targetKey) return track;

            const startIdx = NOTES.indexOf(track.key);
            const targetIdx = NOTES.indexOf(targetKey);
            if (startIdx === -1 || targetIdx === -1) return track;

            const semitones = targetIdx - startIdx;
            
            // Deep copy structure
            const newTrack = JSON.parse(JSON.stringify(track));
            newTrack.key = targetKey; // Update key

            // Transpose Progression
            newTrack.progression.forEach(chord => {
                // Transpose Name (heuristic: replace root)
                // Assumes chord name starts with root note
                const rootMatch = chord.name.match(/^([A-G][#b]?)/);
                if (rootMatch) {
                    const oldRoot = rootMatch[1];
                    const newRoot = NOTES[((NOTES.indexOf(oldRoot) + semitones) % 12 + 12) % 12];
                    chord.name = chord.name.replace(oldRoot, newRoot);
                }

                // Transpose Notes
                chord.notes = chord.notes.map(n => transposeNote(n, semitones));

                // Transpose Recommended Scales roots
                if (chord.recommendedScales) {
                    chord.recommendedScales.forEach(scale => {
                        const rIdx = NOTES.indexOf(scale.root);
                        if (rIdx !== -1) {
                            scale.root = NOTES[((rIdx + semitones) % 12 + 12) % 12];
                        }
                    });
                }
            });

            // Transpose Overall Scales
            if (newTrack.overallScales) {
                newTrack.overallScales.forEach(scale => {
                    const rIdx = NOTES.indexOf(scale.root);
                    if (rIdx !== -1) {
                        const newRoot = NOTES[((rIdx + semitones) % 12 + 12) % 12];
                        scale.root = newRoot;
                        // Update label if it starts with the root
                        if (scale.label.startsWith(scale.root)) {
                             // This part is tricky if label was "C Major", scale.root is now D... 
                             // regex replace first word?
                             scale.label = scale.label.replace(NOTES[rIdx], newRoot);
                        }
                    }
                });
            }

            return newTrack;
        }

        // --- STUDIO TOOLS ENGINE ---
        class StudioTools {
            constructor() {
                // Tuner State
                this.tunerActive = false;
                this.audioCtx = null;
                this.analyser = null;
                this.micSource = null;
                this.rafId = null;
                this.currentPitch = { note: '-', cents: 0 };
                
                // Looper State
                this.isRecording = false;
                this.loopBuffers = []; // Array of AudioBuffers
                this.loopDuration = 0; // Length in seconds
                this.looperNodes = []; // Playing source nodes
                this.masterStartTime = 0;
                this.recordSamples = [];
                this.processor = null;
                this.looperStream = null;
                this.looperGain = null; // Master gain for loops
                this.loopVolume = 0.8;
                this.isMonitoring = false;
                this.monitorNode = null;

                // Visualizer State
                this.rootKey = 'E';
                this.scaleType = 'minor';
                this.viewMode = 'guitar'; // 'guitar' or 'piano'
                this.pianoDisplayMode = 'accent'; // 'accent' or 'gradient'
                this.visualizerTrackId = null;
                this.visualizerMode = 'key'; // 'key' or 'chord'
                this.showCommonNotes = false;

                // Mixer State
                this.bpm = 110;
                this.isPlaying = false;
                this.currentBeat = 0;
                this.volumes = { kick: 0.8, snare: 0.4, hihat: 0.15, bass: 0.5 };
                this.nextNoteTime = 0;
                this.beatCount = 0;
                this.timerID = null;
                this.jamCtx = null;

                // Bass Synth Parameters
                this.bassNote = 'C';
                this.bassWaveform = 'sawtooth';
                this.bassAttack = 0.01;
                this.bassDecay = 0.1;
                this.bassSustain = 0.7;
                this.bassRelease = 0.3;
                this.bassFilterCutoff = 800;
                this.bassFilterResonance = 5;
                this.bassDistortion = 0;
                this.bassSubOscLevel = 0.3;

                // Drum Parameters
                this.kickPitch = 150;
                this.kickDecay = 0.5;
                this.snarePitch = 200;
                this.snareDecay = 0.2;
                this.snareNoiseBalance = 0.8;
                this.hihatPitch = 8000;
                this.hihatDecay = 0.1;

                // Bassline Pattern
                this.bassPattern = 'root'; // 'root', 'octave', 'walking', 'arpeggio', 'jazz'
                this.selectedProgression = null; // Will hold a backing track progression
                this.currentChordIndex = 0;
                this.beatsInCurrentChord = 0;

                // Creative Spark State
                this.spark = {
                    progression: null,
                    mood: null,
                    constraint: null
                };

                // Note Hunt State
                this.noteHuntActive = false;
                this.targetNote = null;
                this.huntScore = 0;
                this.lastHuntTime = 0;
            }

            // --- MIXER LOGIC ---
            togglePlay() {
                if (this.isPlaying) {
                    clearTimeout(this.timerID);
                    this.isPlaying = false;
                    this.beatCount = 0;
                    // Reset chord progression
                    this.currentChordIndex = 0;
                    this.beatsInCurrentChord = 0;
                    render();
                } else {
                    if (!this.jamCtx) {
                        this.jamCtx = new (window.AudioContext || window.webkitAudioContext)();
                        // Connect to global recorder if possible
                        if (audio.recordingStreamDest) {
                            const source = this.jamCtx.createMediaStreamDestination();
                            // This is tricky because contexts are separate. 
                            // Actually, let's just make sure jamCtx output is captured.
                            // Better way: capture all destination nodes.
                        }
                    }
                    this.nextNoteTime = this.jamCtx.currentTime + 0.1;
                    this.isPlaying = true;
                    // Reset chord progression
                    this.currentChordIndex = 0;
                    this.beatsInCurrentChord = 0;
                    this.scheduler();
                    render();
                }
            }

            scheduler() {
                while (this.nextNoteTime < this.jamCtx.currentTime + 0.1) {
                    this.scheduleNote(this.beatCount, this.nextNoteTime);
                    this.nextNoteTime += 60.0 / this.bpm;
                    this.beatCount++;
                }
                if (this.isPlaying) {
                    this.timerID = setTimeout(() => this.scheduler(), 25);
                }
            }

            getRootNoteFromChord(chordName) {
                // Extract root note from chord name (e.g., "C Major" → "C", "Dm7" → "D", "A7" → "A")
                const match = chordName.match(/^([A-G][#b]?)/);
                if (match) {
                    let root = match[1];
                    // Convert flats to sharps for consistency
                    const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
                    root = flatToSharp[root] || root;
                    return root;
                }
                return this.bassNote; // Fallback to manual setting
            }

            getCurrentBassNote() {
                if (this.selectedProgression && this.selectedProgression.length > 0) {
                    const currentChord = this.selectedProgression[this.currentChordIndex];
                    return this.getRootNoteFromChord(currentChord.name);
                }
                return this.bassNote; // Use manual bass note if no progression
            }

            getBassNoteForBeat(beatIndex) {
                const currentRoot = this.getCurrentBassNote();
                const rootFreq = FREQUENCIES[currentRoot];

                // Calculate intervals (in semitones)
                const intervals = {
                    root: 0,
                    minor3rd: 3,
                    major3rd: 4,
                    perfect5th: 7,
                    minor7th: 10,
                    octave: 12
                };

                // Pattern definitions
                switch(this.bassPattern) {
                    case 'root':
                        // Just root on beat 1
                        return beatIndex === 0 ? rootFreq / 4 : null;

                    case 'octave':
                        // Root on 1, octave up on 3
                        if (beatIndex === 0) return rootFreq / 4;
                        if (beatIndex === 2) return rootFreq / 2; // One octave up
                        return null;

                    case 'walking':
                        // Classic walking bass: root, 3rd, 5th, 7th
                        const walkingPattern = [0, 4, 7, 10]; // Root, Major 3rd, 5th, Minor 7th
                        const semitones = walkingPattern[beatIndex];
                        return (rootFreq / 4) * Math.pow(2, semitones / 12);

                    case 'arpeggio':
                        // Arpeggio: root, 3rd, 5th, 3rd (back down)
                        const arpeggioPattern = [0, 4, 7, 4]; // Root, 3rd, 5th, 3rd
                        const arpeggioSemitones = arpeggioPattern[beatIndex];
                        return (rootFreq / 4) * Math.pow(2, arpeggioSemitones / 12);

                    case 'jazz':
                        // Jazz walking: root, 2nd, 3rd, chromatic approach to next root
                        const jazzPattern = [0, 2, 4, 11]; // Root, Whole step, 3rd, Half step below next root
                        const jazzSemitones = jazzPattern[beatIndex];
                        return (rootFreq / 4) * Math.pow(2, jazzSemitones / 12);

                    default:
                        return beatIndex === 0 ? rootFreq / 4 : null;
                }
            }

            scheduleNote(beatNumber, time) {
                // Update chord progression tracking
                if (this.selectedProgression && this.selectedProgression.length > 0) {
                    const currentChord = this.selectedProgression[this.currentChordIndex];
                    this.beatsInCurrentChord++;

                    // Move to next chord when we've played all beats
                    if (this.beatsInCurrentChord >= currentChord.beats) {
                        this.currentChordIndex = (this.currentChordIndex + 1) % this.selectedProgression.length;
                        this.beatsInCurrentChord = 0;
                    }
                }

                // UI Beat Update (Visual only)
                const beatIndex = beatNumber % 4;
                // We use a slight delay for UI sync or just update state and hope render catches it?
                // For vanilla JS, direct DOM manipulation is best for high freq updates like this to avoid full re-renders
                setTimeout(() => {
                    const dots = document.querySelectorAll('.beat-dot');
                    dots.forEach((d, i) => {
                        if (i === beatIndex) d.classList.add('bg-cyan-400', 'shadow-[0_0_10px_rgba(34,211,238,1)]');
                        else d.classList.remove('bg-cyan-400', 'shadow-[0_0_10px_rgba(34,211,238,1)]');
                    });
                }, Math.max(0, (time - this.jamCtx.currentTime) * 1000));

                const vol = this.volumes;
                if (beatIndex === 0 && vol.kick > 0) this.playKick(time, vol.kick);
                if (beatIndex === 2 && vol.snare > 0) this.playSnare(time, vol.snare);
                if (vol.hihat > 0) { 
                    this.playHiHat(time, vol.hihat); 
                    this.playHiHat(time + (60 / this.bpm) / 2, vol.hihat); 
                }
                
                // Bass Note (Pattern-based)
                const bassFreq = this.getBassNoteForBeat(beatIndex);
                if (bassFreq && vol.bass > 0) this.playBass(time, bassFreq, 0.2, vol.bass);
            }

            playBass(time, freq, duration, vol) {
                // Main Oscillator
                const osc = this.jamCtx.createOscillator();
                osc.type = this.bassWaveform;
                osc.frequency.value = freq;

                // Sub Oscillator (one octave down)
                const subOsc = this.jamCtx.createOscillator();
                subOsc.type = 'sine';
                subOsc.frequency.value = freq / 2;

                // Filter
                const filter = this.jamCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = this.bassFilterCutoff;
                filter.Q.value = this.bassFilterResonance;

                // Distortion (if enabled)
                let distortion = null;
                if (this.bassDistortion > 0) {
                    distortion = this.jamCtx.createWaveShaper();
                    distortion.curve = this.makeDistortionCurve(this.bassDistortion * 100);
                }

                // Gain nodes
                const mainGain = this.jamCtx.createGain();
                const subGain = this.jamCtx.createGain();
                const masterGain = this.jamCtx.createGain();

                // ADSR Envelope
                masterGain.gain.setValueAtTime(0, time);
                masterGain.gain.linearRampToValueAtTime(vol, time + this.bassAttack);
                masterGain.gain.linearRampToValueAtTime(vol * this.bassSustain, time + this.bassAttack + this.bassDecay);
                masterGain.gain.linearRampToValueAtTime(0.001, time + duration + this.bassRelease);

                // Sub oscillator level
                subGain.gain.value = this.bassSubOscLevel;

                // Connect audio graph
                osc.connect(mainGain);
                subOsc.connect(subGain);

                if (distortion) {
                    mainGain.connect(distortion);
                    subGain.connect(distortion);
                    distortion.connect(filter);
                } else {
                    mainGain.connect(filter);
                    subGain.connect(filter);
                }

                filter.connect(masterGain);
                masterGain.connect(this.jamCtx.destination);

                // Start and stop
                osc.start(time);
                subOsc.start(time);
                osc.stop(time + duration + this.bassRelease + 0.1);
                subOsc.stop(time + duration + this.bassRelease + 0.1);
            }

            makeDistortionCurve(amount) {
                const samples = 44100;
                const curve = new Float32Array(samples);
                const deg = Math.PI / 180;
                for (let i = 0; i < samples; i++) {
                    const x = (i * 2) / samples - 1;
                    curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
                }
                return curve;
            }

            playKick(time, vol) {
                const osc = this.jamCtx.createOscillator();
                const gain = this.jamCtx.createGain();
                osc.frequency.setValueAtTime(this.kickPitch, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + this.kickDecay);
                gain.gain.setValueAtTime(vol, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + this.kickDecay);
                osc.connect(gain);
                gain.connect(this.jamCtx.destination);
                osc.start(time);
                osc.stop(time + this.kickDecay);
            }

            playSnare(time, vol) {
                // Noise component
                const noiseBuffer = this.jamCtx.createBuffer(1, this.jamCtx.sampleRate * 0.1, this.jamCtx.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < noiseBuffer.length; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                const noise = this.jamCtx.createBufferSource();
                noise.buffer = noiseBuffer;
                const noiseGain = this.jamCtx.createGain();
                noiseGain.gain.setValueAtTime(vol * this.snareNoiseBalance, time);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, time + this.snareDecay);

                // Tone component (for body)
                const osc = this.jamCtx.createOscillator();
                osc.frequency.value = this.snarePitch;
                const toneGain = this.jamCtx.createGain();
                toneGain.gain.setValueAtTime(vol * (1 - this.snareNoiseBalance), time);
                toneGain.gain.exponentialRampToValueAtTime(0.01, time + this.snareDecay);

                // Mix both
                const mixGain = this.jamCtx.createGain();
                noise.connect(noiseGain);
                osc.connect(toneGain);
                noiseGain.connect(mixGain);
                toneGain.connect(mixGain);
                mixGain.connect(this.jamCtx.destination);

                noise.start(time);
                osc.start(time);
                osc.stop(time + this.snareDecay);
            }

            playHiHat(time, vol) {
                const osc = this.jamCtx.createOscillator();
                const gain = this.jamCtx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(this.hihatPitch, time);
                const filter = this.jamCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = this.hihatPitch * 0.875;
                gain.gain.setValueAtTime(vol, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + this.hihatDecay);
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.jamCtx.destination);
                osc.start(time);
                osc.stop(time + this.hihatDecay);
            }

            playSynthSound(type, time, freq, duration, vol) {
                const osc = this.jamCtx.createOscillator();
                const gain = this.jamCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, time);
                gain.gain.setValueAtTime(vol, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
                osc.connect(gain);
                gain.connect(this.jamCtx.destination);
                osc.start(time);
                osc.stop(time + duration);
            }

            // --- TUNER LOGIC ---
            async startTuner() {
                try {
                    if (!this.audioCtx) {
                        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.analyser = this.audioCtx.createAnalyser();
                    this.analyser.fftSize = 2048;
                    this.micSource = this.audioCtx.createMediaStreamSource(stream);
                    this.micSource.connect(this.analyser);
                    this.tunerActive = true;
                    this.updatePitch();
                    render(); // Re-render to show active state
                } catch (err) {
                    console.error("Microphone access denied", err);
                    alert("Microphone access denied. Please allow microphone access to use the Tuner.");
                }
            }

            stopTuner() {
                this.tunerActive = false;
                if (this.rafId) cancelAnimationFrame(this.rafId);
                if (this.micSource) {
                    this.micSource.disconnect();
                    // Stop stream tracks
                    this.micSource.mediaStream.getTracks().forEach(t => t.stop());
                }
                this.currentPitch = { note: '-', cents: 0 };
                render();
            }

            updatePitch() {
                if (!this.tunerActive) return;
                
                const buf = new Float32Array(2048);
                this.analyser.getFloatTimeDomainData(buf);
                const ac = this.autoCorrelate(buf, this.audioCtx.sampleRate);

                if (ac !== -1) {
                    const noteNum = 12 * (Math.log(ac / 440) / Math.log(2)) + 69;
                    const roundedNote = Math.round(noteNum);
                    const value = NOTES[roundedNote % 12];
                    const centDiff = Math.floor((noteNum - roundedNote) * 100);
                    this.currentPitch = { note: value, cents: centDiff };
                    
                    if (this.noteHuntActive) {
                        this.checkHuntMatch(value);
                    }
                } else {
                    // Optional: Decay old note or keep last known?
                    // keeping last known makes it less jittery, but '-' is clearer for silence
                }
                
                // Optimized: Only re-render the tuner display part if possible, 
                // but for simplicity we can just update the DOM elements directly if they exist
                this.updateTunerDOM();
                
                this.rafId = requestAnimationFrame(() => this.updatePitch());
            }

            updateTunerDOM() {
                const noteEl = document.getElementById('tuner-note');
                const centsEl = document.getElementById('tuner-cents');
                const barEl = document.getElementById('tuner-bar');
                const ringEl = document.getElementById('tuner-ring');
                
                if (noteEl && this.currentPitch.note !== '-') {
                    noteEl.innerText = this.currentPitch.note;
                    centsEl.innerText = (this.currentPitch.cents > 0 ? '+' : '') + this.currentPitch.cents + ' ct';
                    
                    const isInTune = Math.abs(this.currentPitch.cents) < 5;
                    barEl.style.left = `calc(50% + ${this.currentPitch.cents}px)`;
                    barEl.className = `absolute top-0 bottom-0 w-2 rounded-full transition-all duration-100 ${isInTune ? 'bg-green-500' : 'bg-red-500'}`;
                    
                    ringEl.className = `w-40 h-40 rounded-full border-8 flex items-center justify-center transition-colors duration-200 ${isInTune ? 'border-green-500 shadow-[0_0_30px_rgba(34,197,94,0.3)]' : 'border-stone-600'}`;
                }
            }

            autoCorrelate(buf, sampleRate) {
                let SIZE = buf.length;
                let rms = 0;
                for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
                rms = Math.sqrt(rms / SIZE);
                if (rms < 0.01) return -1;

                let r1 = 0, r2 = SIZE - 1, thres = 0.2;
                for (let i = 0; i < SIZE / 2; i++) { if (Math.abs(buf[i]) < thres) { r1 = i; break; } }
                for (let i = 1; i < SIZE / 2; i++) { if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; } }
                buf = buf.slice(r1, r2);
                SIZE = buf.length;

                let c = new Array(SIZE).fill(0);
                for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
                let d = 0; while (c[d] > c[d + 1]) d++;
                let maxval = -1, maxpos = -1;
                for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
                let T0 = maxpos;
                let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
                let a = (x1 + x3 - 2 * x2) / 2;
                let b = (x3 - x1) / 2;
                if (a) T0 = T0 - b / (2 * a);
                return sampleRate / T0;
            }

            // --- LOOPER LOGIC (HIGH PRECISION) ---
            async startRecording() {
                try {
                    if (!this.audioCtx) {
                        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (this.audioCtx.state === 'suspended') await this.audioCtx.resume();

                    if (!this.looperGain) {
                        this.looperGain = this.audioCtx.createGain();
                        this.looperGain.gain.value = this.loopVolume;
                        this.looperGain.connect(this.audioCtx.destination);
                        // Connect to global recorder if possible
                        if (audio.recordingStreamDest) {
                            this.looperGain.connect(audio.recordingStreamDest);
                        }
                    }

                    if (this.loopDuration > 0 && this.looperNodes.length === 0) {
                        this.startPlayback();
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.looperStream = stream;
                    const source = this.audioCtx.createMediaStreamSource(stream);
                    
                    if (this.isMonitoring) {
                        this.monitorNode = this.audioCtx.createGain();
                        this.monitorNode.gain.value = 0.5;
                        source.connect(this.monitorNode);
                        this.monitorNode.connect(this.audioCtx.destination);
                    }

                    this.processor = this.audioCtx.createScriptProcessor(4096, 1, 1);
                    this.recordSamples = [];
                    this.isRecording = true;
                    this.recordStartTime = this.audioCtx.currentTime;
                    
                    source.connect(this.processor);
                    
                    const silentGain = this.audioCtx.createGain();
                    silentGain.gain.value = 0; 
                    this.processor.connect(silentGain);
                    silentGain.connect(this.audioCtx.destination); 

                    this.processor.onaudioprocess = (e) => {
                        if (this.isRecording) {
                            const input = e.inputBuffer.getChannelData(0);
                            this.recordSamples.push(new Float32Array(input));
                        }
                    };

                    render();
                    this.updateLooperProgress();
                } catch (err) {
                    console.error("Mic Error", err);
                    alert("Could not access microphone.");
                }
            }

            stopRecording() {
                this.isRecording = false;
                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }
                if (this.monitorNode) {
                    this.monitorNode.disconnect();
                    this.monitorNode = null;
                }
                if (this.looperStream) {
                    this.looperStream.getTracks().forEach(t => t.stop());
                    this.looperStream = null;
                }

                const totalSamples = this.recordSamples.reduce((acc, val) => acc + val.length, 0);
                if (totalSamples === 0) return;

                const buffer = this.audioCtx.createBuffer(1, totalSamples, this.audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                let offset = 0;
                for (const chunk of this.recordSamples) {
                    data.set(chunk, offset);
                    offset += chunk.length;
                }

                if (this.loopDuration === 0) {
                    this.loopDuration = buffer.duration;
                    this.loopBuffers.push(buffer);
                    this.masterStartTime = this.audioCtx.currentTime;
                    this.startPlayback();
                } else {
                    const targetLength = Math.floor(this.loopDuration * this.audioCtx.sampleRate);
                    const syncedBuffer = this.audioCtx.createBuffer(1, targetLength, this.audioCtx.sampleRate);
                    const syncedData = syncedBuffer.getChannelData(0);
                    
                    const startOffset = (this.recordStartTime - this.masterStartTime) % this.loopDuration;
                    const startSample = Math.floor(startOffset * this.audioCtx.sampleRate);
                    
                    for (let i = 0; i < data.length; i++) {
                        const targetIdx = (startSample + i) % targetLength;
                        syncedData[targetIdx] += data[i];
                    }
                    
                    this.loopBuffers.push(syncedBuffer);
                    this.startPlayback();
                }
                render();
            }

            startPlayback() {
                this.stopPlayback();
                if (!this.looperGain) {
                    this.looperGain = this.audioCtx.createGain();
                    this.looperGain.gain.value = this.loopVolume;
                    this.looperGain.connect(this.audioCtx.destination);
                }
                this.loopBuffers.forEach(buffer => {
                    this.addBufferToPlayback(buffer);
                });
                this.updateLooperProgress();
            }

            addBufferToPlayback(buffer) {
                if (!this.audioCtx) return;
                const source = this.audioCtx.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                
                const now = this.audioCtx.currentTime;
                const elapsed = now - this.masterStartTime;
                const offset = elapsed % this.loopDuration;
                
                source.connect(this.looperGain);
                source.start(0, offset);
                this.looperNodes.push(source);
            }

            stopPlayback() {
                this.looperNodes.forEach(n => {
                    try { n.stop(); } catch(e) {}
                });
                this.looperNodes = [];
            }

            undoLastLayer() {
                if (this.loopBuffers.length > 0) {
                    this.loopBuffers.pop();
                    if (this.loopBuffers.length === 0) {
                        this.clearLoop();
                    } else {
                        this.startPlayback();
                    }
                    render();
                }
            }

            setLoopVolume(val) {
                this.loopVolume = parseFloat(val);
                if (this.looperGain) {
                    this.looperGain.gain.setTargetAtTime(this.loopVolume, this.audioCtx.currentTime, 0.05);
                }
            }

            toggleMonitoring() {
                this.isMonitoring = !this.isMonitoring;
                render();
            }

            updateLooperProgress() {
                if (this.loopDuration === 0 || (this.looperNodes.length === 0 && !this.isRecording)) return;
                
                const progressEl = document.getElementById('loop-progress-bar');
                if (progressEl) {
                    const now = this.audioCtx.currentTime;
                    const elapsed = now - this.masterStartTime;
                    const percent = ((elapsed % this.loopDuration) / this.loopDuration) * 100;
                    progressEl.style.width = percent + '%';
                }
                
                requestAnimationFrame(() => this.updateLooperProgress());
            }

            clearLoop() {
                this.stopPlayback();
                this.loopBuffers = [];
                this.loopDuration = 0;
                this.masterStartTime = 0;
                render();
            }

            // --- CREATIVE SPARK LOGIC ---
            generateSpark() {
                const progressions = [
                    { name: "The Standard", pattern: "I - IV - V - I", desc: "Solid and reliable foundation.", chords: ['C Major', 'F Major', 'G Major', 'C Major'] },
                    { name: "The Emotional", pattern: "vi - IV - I - V", desc: "The 'Axis of Awesome' emotional curve.", chords: ['A Minor', 'F Major', 'C Major', 'G Major'] },
                    { name: "The Jazz Turn", pattern: "ii - V - I - vi", desc: "A smooth, cycling turnaround.", chords: ['D Minor 7', 'G Dominant 7', 'C Major 7', 'A Minor 7'] },
                    { name: "The Modal Drift", pattern: "I - bVII - IV - I", desc: "Mixolydian rock vibes.", chords: ['C Major', 'Bb Major', 'F Major', 'C Major'] },
                    { name: "The Dark Descender", pattern: "i - bVII - bVI - V", desc: "Classic minor key tension.", chords: ['C Minor', 'Bb Major', 'Ab Major', 'G Major'] }
                ];
                const moods = [
                    "Cinematic Noir", "Late Night Neo-Soul", "Gritty Garage Rock", 
                    "Ethereal Dream-Pop", "Sun-Drenched Funk", "Cyberpunk Industrial"
                ];
                const constraints = [
                    "No using the Root note in your melody.",
                    "All rhythms must be strictly 16th notes.",
                    "You must include a wide interval jump (5th or Octave) in every phrase.",
                    "Only play on the 'off-beats'.",
                    "Limit yourself to only 3 notes for the entire idea.",
                    "One string only for the melody."
                ];

                this.spark = {
                    progression: progressions[Math.floor(Math.random() * progressions.length)],
                    mood: moods[Math.floor(Math.random() * moods.length)],
                    constraint: constraints[Math.floor(Math.random() * constraints.length)]
                };
                render();
            }

            loadSparkToJam(destination = 'studio') {
                if (!this.spark.progression) return;

                // Create a temporary track object
                const sparkTrack = {
                    id: 'spark-' + Date.now(),
                    title: `Spark: ${this.spark.mood}`,
                    genre: 'Spark',
                    bpm: 100,
                    key: 'C',
                    isSpark: true,
                    sparkData: JSON.parse(JSON.stringify(this.spark)), // Deep copy
                    overallScales: [{ root: 'C', type: 'major', label: 'C Major' }],
                    description: `${this.spark.constraint} | ${this.spark.progression.name}`,
                    progression: this.spark.progression.chords.map(c => {
                        // Simple note mapping for Spark
                        let notes = ['C3', 'E3', 'G3'];
                        if (c.includes('F')) notes = ['F2', 'A2', 'C3'];
                        if (c.includes('G')) notes = ['G2', 'B2', 'D3'];
                        if (c.includes('A')) notes = ['A2', 'C3', 'E3'];
                        if (c.includes('Bb')) notes = ['Bb2', 'D3', 'F3'];
                        if (c.includes('Ab')) notes = ['Ab2', 'C3', 'Eb3'];
                        if (c.includes('D')) notes = ['D3', 'F3', 'A3'];
                        
                        return { name: c, beats: 4, notes: notes, theory: 'Spark Chord' };
                    })
                };

                if (destination === 'jam') {
                    audio.playBackingTrack(sparkTrack);
                } else {
                    this.selectedProgression = sparkTrack.progression;
                    this.currentChordIndex = 0;
                    this.beatsInCurrentChord = 0;
                    setStudioModule('jamstation');
                    if (!this.isPlaying) this.togglePlay();
                }
            }

            generateAndPlaySpark() {
                this.generateSpark();
                this.loadSparkToJam('jam');
            }

            saveCurrentSpark() {
                const active = audio.activeTrack;
                if (!active || !active.isSpark) {
                    if (this.spark.progression) {
                        // If no active track, save the currently generated spark in state
                        const newSpark = {
                            id: 'spark-' + Date.now(),
                            title: `Spark: ${this.spark.mood}`,
                            isSpark: true,
                            sparkData: JSON.parse(JSON.stringify(this.spark))
                        };
                        appState.savedSparks.push(newSpark);
                        localStorage.setItem('theshed_sparks', JSON.stringify(appState.savedSparks));
                        render();
                    }
                    return;
                }
                
                // Save the active track
                appState.savedSparks.push(active);
                localStorage.setItem('theshed_sparks', JSON.stringify(appState.savedSparks));
                render();
            }

            deleteSpark(id) {
                appState.savedSparks = appState.savedSparks.filter(s => s.id !== id);
                localStorage.setItem('theshed_sparks', JSON.stringify(appState.savedSparks));
                render();
            }

            // --- NOTE HUNT LOGIC ---
            async toggleNoteHunt() {
                if (this.noteHuntActive) {
                    this.noteHuntActive = false;
                    this.stopTuner(); // Reuse tuner's pitch detection
                } else {
                    this.noteHuntActive = true;
                    this.huntScore = 0;
                    this.generateTargetNote();
                    await this.startTuner();
                }
                render();
            }

            generateTargetNote() {
                const scaleNotes = this.getScaleNotes();
                this.targetNote = scaleNotes[Math.floor(Math.random() * scaleNotes.length)];
                this.lastHuntTime = Date.now();
            }

            checkHuntMatch(detectedNote) {
                if (!this.noteHuntActive || !this.targetNote) return;
                
                if (detectedNote === this.targetNote) {
                    this.huntScore++;
                    this.generateTargetNote();
                    render(); // Re-render to show new target and score
                }
            }

            // --- VISUALIZER HELPER ---
            getCommonNotes(track) {
                if (!track || !track.progression) return [];
                
                // Get the set of notes for the first chord's recommended scale
                // to initialize the intersection set
                const getNotesForChord = (chord) => {
                    if (chord.recommendedScales && chord.recommendedScales.length > 0) {
                        return this.getScaleNotes(chord.recommendedScales[0].root, chord.recommendedScales[0].type);
                    }
                    return []; // Or maybe chord.notes?
                };

                let common = getNotesForChord(track.progression[0]);

                for (let i = 1; i < track.progression.length; i++) {
                    const nextNotes = getNotesForChord(track.progression[i]);
                    // Intersection
                    common = common.filter(n => nextNotes.includes(n));
                }
                return common;
            }

            getScaleNotes(root = this.rootKey, type = this.scaleType) {
                const rootIdx = NOTES.indexOf(root);
                let intervals = [];
                // Intervals in semitones
                if (this.scaleType === 'major') intervals = [0, 2, 4, 5, 7, 9, 11];
                else if (this.scaleType === 'minor') intervals = [0, 2, 3, 5, 7, 8, 10];
                else if (this.scaleType === 'pentatonic_maj') intervals = [0, 2, 4, 7, 9];
                else if (this.scaleType === 'pentatonic_min') intervals = [0, 3, 5, 7, 10];
                
                return intervals.map(i => NOTES[(rootIdx + i) % 12]);
            }
        }

        const studio = new StudioTools();

        const audio = new SoundEngine();

        // --- DATA: BACKING TRACKS ---
        const BACKING_TRACKS = [
            {
                id: 'pop-anthem',
                title: 'Pop Anthem',
                genre: 'Pop',
                bpm: 110,
                key: 'C',
                overallScales: [
                    { root: 'C', type: 'major', label: 'C Major (works for entire progression)' },
                    { root: 'C', type: 'pentatonic_maj', label: 'C Major Pentatonic' }
                ],
                description: 'The classic "Axis of Awesome" progression. Use the Major Pentatonic scale.',
                progression: [
                    { name: 'C Major', beats: 4, notes: ['C3', 'E3', 'G3'], theory: 'I - The Home',
                      recommendedScales: [
                          { root: 'C', type: 'major' },
                          { root: 'C', type: 'pentatonic_maj' }
                      ]
                    },
                    { name: 'G Major', beats: 4, notes: ['G3', 'B3', 'D4'], theory: 'V - The Tension',
                      recommendedScales: [
                          { root: 'G', type: 'major' },
                          { root: 'C', type: 'major' }
                      ]
                    },
                    { name: 'A Minor', beats: 4, notes: ['A2', 'C3', 'E3'], theory: 'vi - The Twist',
                      recommendedScales: [
                          { root: 'A', type: 'minor' },
                          { root: 'A', type: 'pentatonic_min' },
                          { root: 'C', type: 'major' }
                      ]
                    },
                    { name: 'F Major', beats: 4, notes: ['F2', 'A2', 'C3'], theory: 'IV - The Lift',
                      recommendedScales: [
                          { root: 'F', type: 'major' },
                          { root: 'C', type: 'major' }
                      ]
                    }
                ]
            },
            {
                id: 'dirty-blues',
                title: 'Dirty Blues',
                genre: 'Blues',
                bpm: 80,
                key: 'A',
                overallScales: [
                    { root: 'A', type: 'pentatonic_min', label: 'A Minor Pentatonic (blues box)' },
                    { root: 'A', type: 'pentatonic_maj', label: 'A Major Pentatonic (for brightness)' }
                ],
                description: 'A standard 12-bar shuffle. Switch between Major and Minor Pentatonic.',
                progression: [
                    { name: 'A7', beats: 4, notes: ['A2', 'C#3', 'G3'], theory: 'I7 - Tonic',
                      recommendedScales: [
                          { root: 'A', type: 'pentatonic_min' },
                          { root: 'A', type: 'pentatonic_maj' }
                      ]
                    },
                    { name: 'D7', beats: 4, notes: ['D3', 'F#3', 'C4'], theory: 'IV7 - Subdominant',
                      recommendedScales: [
                          { root: 'D', type: 'pentatonic_maj' },
                          { root: 'A', type: 'pentatonic_min' }
                      ]
                    },
                    { name: 'A7', beats: 4, notes: ['A2', 'C#3', 'G3'], theory: 'I7 - Tonic',
                      recommendedScales: [
                          { root: 'A', type: 'pentatonic_min' },
                          { root: 'A', type: 'pentatonic_maj' }
                      ]
                    },
                    { name: 'E7', beats: 2, notes: ['E3', 'G#3', 'D4'], theory: 'V7 - Turnaround',
                      recommendedScales: [
                          { root: 'E', type: 'pentatonic_maj' },
                          { root: 'A', type: 'pentatonic_min' }
                      ]
                    },
                    { name: 'D7', beats: 2, notes: ['D3', 'F#3', 'C4'], theory: 'IV7 - Resolution',
                      recommendedScales: [
                          { root: 'D', type: 'pentatonic_maj' },
                          { root: 'A', type: 'pentatonic_min' }
                      ]
                    }
                ]
            },
            {
                id: 'jazz-cafe',
                title: 'Jazz Café',
                genre: 'Jazz',
                bpm: 130,
                key: 'C',
                overallScales: [
                    { root: 'C', type: 'major', label: 'C Major (parent scale for ii-V-I)' }
                ],
                description: 'The DNA of Jazz. Focus on landing on the 3rd and 7th of each chord.',
                progression: [
                    { name: 'Dm7', beats: 4, notes: ['D3', 'F3', 'A3', 'C4'], theory: 'ii - Pre-Dominant',
                      recommendedScales: [
                          { root: 'D', type: 'minor' },
                          { root: 'C', type: 'major' }
                      ]
                    },
                    { name: 'G7', beats: 4, notes: ['G2', 'B2', 'D3', 'F3'], theory: 'V - Dominant',
                      recommendedScales: [
                          { root: 'G', type: 'major' },
                          { root: 'C', type: 'major' }
                      ]
                    },
                    { name: 'Cmaj7', beats: 4, notes: ['C3', 'E3', 'G3', 'B3'], theory: 'I - Tonic',
                      recommendedScales: [
                          { root: 'C', type: 'major' }
                      ]
                    },
                    { name: 'A7alt', beats: 4, notes: ['A2', 'C#3', 'G3', 'A#3'], theory: 'VI - Turnaround',
                      recommendedScales: [
                          { root: 'A', type: 'minor' },
                          { root: 'C', type: 'major' }
                      ]
                    }
                ]
            },
            {
                id: 'rock-ballad',
                title: 'Rock Ballad',
                genre: 'Rock',
                bpm: 75,
                key: 'A',
                overallScales: [
                    { root: 'A', type: 'minor', label: 'A Natural Minor (Aeolian mode)' },
                    { root: 'A', type: 'pentatonic_min', label: 'A Minor Pentatonic' }
                ],
                description: 'Emotional descending progression (Andalusian vibes). Use Natural Minor.',
                progression: [
                    { name: 'Am', beats: 4, notes: ['A2', 'C3', 'E3'], theory: 'i - Minor Tonic',
                      recommendedScales: [
                          { root: 'A', type: 'minor' },
                          { root: 'A', type: 'pentatonic_min' }
                      ]
                    },
                    { name: 'G Major', beats: 4, notes: ['G2', 'B2', 'D3'], theory: 'VII - Step Down',
                      recommendedScales: [
                          { root: 'G', type: 'major' },
                          { root: 'A', type: 'minor' }
                      ]
                    },
                    { name: 'F Major', beats: 4, notes: ['F2', 'A2', 'C3'], theory: 'VI - Step Down',
                      recommendedScales: [
                          { root: 'F', type: 'major' },
                          { root: 'A', type: 'minor' }
                      ]
                    },
                    { name: 'E Major', beats: 4, notes: ['E2', 'G#2', 'B2'], theory: 'V - Major Lift',
                      recommendedScales: [
                          { root: 'E', type: 'major' },
                          { root: 'A', type: 'minor' }
                      ]
                    }
                ]
            }
        ];

        const PRODUCER_VOLUMES = [
            {
                id: 'prod_vol1',
                title: 'Volume I: The Architects of Pop',
                subtitle: 'Structure, Melody, and "The Math"',
                musicians: [
                    {
                        id: 'maxmartin',
                        name: 'Max Martin',
                        archetype: 'The Scientist',
                        theme: 'cyan',
                        quote: "It’s all about the math. A song is a mathematical formula of tension and release.",
                        origin: "The Swedish genius behind Taylor Swift and The Weeknd. He treats songwriting like architecture, prioritizing melody above all else.",
                        lessons: [
                            {
                                id: 'maxmartin-1',
                                title: 'Melodic Math (Syllables)',
                                theoryLabel: 'The Rule',
                                theory: "If a melody line has 7 notes, the lyric must have 7 syllables. It must be perfectly percussive.",
                                drillLabel: 'The Drill',
                                drill: "Write a melody on a synth first. Then write lyrics that match the rhythm exactly. Do not cram extra words in.",
                                duration: 15
                            },
                            {
                                id: 'maxmartin-2',
                                title: 'The "Chorus First" Arrangement',
                                theoryLabel: 'The Technique',
                                theory: "Introduce the melody of the chorus within the first 10 seconds (often as an intro synth line or vocal chop).",
                                drillLabel: 'The Why',
                                drill: "Familiarity breeds affection. Hint at the chorus melody in the intro so the brain recognizes it later.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'quincy',
                        name: 'Quincy Jones',
                        archetype: 'The Orchestrator',
                        theme: 'purple',
                        quote: "God is in the details. I don't care if it's 4 notes or 400 notes, leave space for the diva.",
                        origin: "The man behind Thriller. He thought in terms of frequency spectrums and dynamics.",
                        lessons: [
                            {
                                id: 'quincy-1',
                                title: 'Frequency Slotting',
                                theoryLabel: 'The Rule',
                                theory: "No two instruments should fight for the same frequency range.",
                                drillLabel: 'The Fix',
                                drill: "If piano is low, guitar must be high. Give every instrument its own 'lane' on the EQ spectrum.",
                                duration: 10
                            },
                            {
                                id: 'quincy-2',
                                title: 'The "Ear Candy" Fills',
                                theoryLabel: 'The Technique',
                                theory: "Tiny, unique sounds (shakers, vocal chops) that happen only once reset the listener's attention.",
                                drillLabel: 'The Drill',
                                drill: "Every 4 or 8 bars, add a tiny, unique sound that never repeats.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'ronson',
                        name: 'Mark Ronson',
                        archetype: 'The Retro-Futurist',
                        theme: 'orange',
                        quote: "I like taking a live performance and sampling it, so it sounds like a breakbeat but it breathes like a human.",
                        origin: "Known for blending vintage soul textures with modern pop production.",
                        lessons: [
                            {
                                id: 'ronson-1',
                                title: 'The "Dirty" Clean',
                                theoryLabel: 'The Technique',
                                theory: "Record instruments clean (DI), then run them out into a guitar amp or cassette deck to re-record them.",
                                drillLabel: 'The Result',
                                drill: "Re-amp a clean digital sound through a physical speaker or cheap tape recorder to add 'air' and grit.",
                                duration: 15
                            },
                            {
                                id: 'ronson-2',
                                title: 'The Clap Stack',
                                theoryLabel: 'The Sound',
                                theory: "Ronson rarely uses just one clap sample. He stacks them for a 'Motown' feel.",
                                drillLabel: 'The Drill',
                                drill: "Record 4 different people clapping. Pan them L/R and offset timing by milliseconds.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol2',
                title: 'Volume II: The Hip Hop Scientists',
                subtitle: 'Drums, Sampling, and The "Swing"',
                musicians: [
                    {
                        id: 'drdre',
                        name: 'Dr. Dre',
                        archetype: 'The Sonic Perfectionist',
                        theme: 'stone',
                        quote: "You can't polish a turd. The sound has to be right at the source.",
                        origin: "The master of G-Funk who treats the snare drum as the most important instrument.",
                        lessons: [
                            {
                                id: 'drdre-1',
                                title: 'Drums are the Lead',
                                theoryLabel: 'The Hierarchy',
                                theory: "In Dre’s production, the Kick and Snare are often the loudest elements, even louder than vocals.",
                                drillLabel: 'The Drill',
                                drill: "Start your mix with only Kick and Snare. Get them perfect. Bring everything else in around them.",
                                duration: 15
                            },
                            {
                                id: 'drdre-2',
                                title: 'Sample Layering',
                                theoryLabel: 'The Technique',
                                theory: "Use three layers for a snare: Body (low thud), Snap (high attack), and Tail (noise/reverb).",
                                drillLabel: 'The Drill',
                                drill: "Layer a low 808 snare with a high acoustic rimshot to create a composite sound.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'jdilla',
                        name: 'J Dilla',
                        archetype: 'The Time Traveler',
                        theme: 'amber',
                        quote: "I don't use the grid. I play the MPC like a drummer.",
                        origin: "Pioneered the 'drunk' unquantized swing that defined Neo-Soul and Lo-Fi.",
                        lessons: [
                            {
                                id: 'jdilla-1',
                                title: 'Turn Off Quantize',
                                theoryLabel: 'The Concept',
                                theory: "Quantize snaps notes to a grid. Dilla turned it off for a human feel.",
                                drillLabel: 'The Feel',
                                drill: "Play hi-hats by hand. Let them be late. Let the snare be early. Resist the urge to 'fix' it.",
                                duration: 15
                            },
                            {
                                id: 'jdilla-2',
                                title: 'Filter Movement',
                                theoryLabel: 'The Technique',
                                theory: "Don't let a sample loop statically. Map a Low Pass Filter to an LFO.",
                                drillLabel: 'The Drill',
                                drill: "Slowly open and close a filter over a 2-bar loop to make it feel alive.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'pharrell',
                        name: 'Pharrell Williams',
                        archetype: 'The Minimalist',
                        theme: 'yellow',
                        quote: "I start loops. That's usually the intro. Just four counts of the loop.",
                        origin: "The Neptune who creates infectious, dry, minimal funk beats.",
                        lessons: [
                            {
                                id: 'pharrell-1',
                                title: 'The "Four-Count" Start',
                                theoryLabel: 'The Signature',
                                theory: "Start the song with a 4-beat loop of the first beat.",
                                drillLabel: 'The Drill',
                                drill: "Take the first beat of your track. Loop it 4 times rapidly as an intro tag.",
                                duration: 5
                            },
                            {
                                id: 'pharrell-2',
                                title: 'Sound Dryness',
                                theoryLabel: 'The Aesthetic',
                                theory: "Pharrell often uses zero reverb. The sounds are 'in your face'.",
                                drillLabel: 'The Application',
                                drill: "Mute all reverb. If the groove sounds bad dry, the arrangement is bad.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol3',
                title: 'Volume III: The Reducers & Visionaries',
                subtitle: 'Vibe, Reduction, and Psychology',
                musicians: [
                    {
                        id: 'rubin',
                        name: 'Rick Rubin',
                        archetype: 'The Guru',
                        theme: 'stone',
                        quote: "The mute button is the best plugin in your DAW.",
                        origin: "The producer who doesn't touch knobs but acts as a 'reducer', stripping songs to their essence.",
                        lessons: [
                            {
                                id: 'rubin-1',
                                title: 'Subtractive Arrangement',
                                theoryLabel: 'The Concept',
                                theory: "Make the track huge, then remove elements until it breaks.",
                                drillLabel: 'The Drill',
                                drill: "Mute two main elements (e.g., rhythm guitar and pad). Can the song survive with just bass and vocals?",
                                duration: 10
                            },
                            {
                                id: 'rubin-2',
                                title: 'Genre Blindness',
                                theoryLabel: 'The Philosophy',
                                theory: "Treat a metal song like funk. Treat hip-hop like rock.",
                                drillLabel: 'The Assignment',
                                drill: "Take a riff from one genre and put a beat from a completely opposite genre under it.",
                                duration: 15
                            }
                        ]
                    },
                    {
                        id: 'finneas',
                        name: 'Finneas',
                        archetype: 'The Foley Artist',
                        theme: 'green',
                        quote: "I want sounds that feel like you can touch them. Intimacy is the scariest texture.",
                        origin: "Known for using everyday sounds (foley) to create organic, textured pop.",
                        lessons: [
                            {
                                id: 'finneas-1',
                                title: 'Found Sound Percussion',
                                theoryLabel: 'The Technique',
                                theory: "Use real-world sounds (matches, crosswalks) as percussion.",
                                drillLabel: 'The Drill',
                                drill: "Record a door slam or apple bite. Use it as your snare. It adds subconscious texture.",
                                duration: 15
                            },
                            {
                                id: 'finneas-2',
                                title: 'The Whisper Vocal',
                                theoryLabel: 'The Mix',
                                theory: "Compress a whisper vocal heavily to bring up mouth noises and breath.",
                                drillLabel: 'The Drill',
                                drill: "Record a whisper. Compress 10:1. Turn up gain. It sounds like singing into the listener's ear.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'eno_prod',
                        name: 'Brian Eno',
                        archetype: 'The Soundscaper',
                        theme: 'sky',
                        quote: "Repetition is a form of change.",
                        origin: "The father of Ambient music and generative composition.",
                        lessons: [
                            {
                                id: 'eno-prod-1',
                                title: 'Generative Music',
                                theoryLabel: 'The Technique',
                                theory: "Use loops of different lengths (e.g., 4 bars vs 5 bars) to create phasing patterns.",
                                drillLabel: 'The Drill',
                                drill: "Set up two loops of unequal length. Let them cycle to create ever-changing combinations.",
                                duration: 15
                            },
                            {
                                id: 'eno-prod-2',
                                title: 'The EQ "Horizon"',
                                theoryLabel: 'The Drill',
                                theory: "High-pass everything except Kick and Bass to create a clear 'horizon'.",
                                drillLabel: 'The Drill',
                                drill: "Cut everything below 200Hz on guitars, vocals, and snares. Clear the mud.",
                                duration: 5
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol4',
                title: 'Volume IV: The Mix Engineers',
                subtitle: 'Balance, Space, and Translation',
                musicians: [
                    {
                        id: 'ghenea',
                        name: 'Serban Ghenea',
                        archetype: 'The Invisible Man',
                        theme: 'blue',
                        quote: "I don't use much compression on the master bus. I want the transients to punch through.",
                        origin: "The world's most successful mixer, known for preserving dynamics and punch.",
                        lessons: [
                            {
                                id: 'ghenea-1',
                                title: 'Automation over Compression',
                                theoryLabel: 'The Secret',
                                theory: "Manually automate volume faders instead of smashing vocals with compression.",
                                drillLabel: 'The Drill',
                                drill: "Spend 15 minutes drawing volume automation on a vocal track. It sounds more natural.",
                                duration: 15
                            },
                            {
                                id: 'ghenea-2',
                                title: 'The "Translation" Check',
                                theoryLabel: 'The Test',
                                theory: "Check the mix on a phone speaker in Mono.",
                                drillLabel: 'The Fix',
                                drill: "If bass disappears on a phone, add saturation/distortion to generate upper harmonics.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'clearmountain',
                        name: 'Bob Clearmountain',
                        archetype: 'The Reverb King',
                        theme: 'red',
                        quote: "Reverb shouldn't be heard; it should be felt. If you notice it, it's too loud.",
                        origin: "Famous for his lush, clean mixes and specific reverb techniques.",
                        lessons: [
                            {
                                id: 'clearmountain-1',
                                title: 'The "Abbey Road" EQ',
                                theoryLabel: 'The Technique',
                                theory: "EQ your reverb. Cut lows up to 600Hz and highs down to 6kHz.",
                                drillLabel: 'The Result',
                                drill: "Place an EQ before your reverb plugin. Band-pass the reverb so it doesn't muddy the mix.",
                                duration: 10
                            },
                            {
                                id: 'clearmountain-2',
                                title: 'Delay Throws',
                                theoryLabel: 'The Drill',
                                theory: "Don't leave delay on. Automate it to 'throw' only on specific words.",
                                drillLabel: 'The Drill',
                                drill: "Automate a delay send to unmute only for the last word of a phrase.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol6',
                title: 'Volume VI: The Sound Designers',
                subtitle: 'Synthesis, Glitch, and "The Growl"',
                musicians: [
                    {
                        id: 'skrillex',
                        name: 'Skrillex',
                        archetype: 'The FM Alchemist',
                        theme: 'purple',
                        quote: "I treat sounds like characters. They have to speak, scream, and breathe.",
                        origin: "Revolutionized bass music with FM synthesis and vocal-like growls.",
                        lessons: [
                            {
                                id: 'skrillex-1',
                                title: 'The "Talking" Bass',
                                theoryLabel: 'The Concept',
                                theory: "Use Formant Filters to make synths mimic human vowels (A-E-I-O-U).",
                                drillLabel: 'The Drill',
                                drill: "Map a Formant Filter cutoff to an LFO on your bass track to create 'Yoi-Yoi' sounds.",
                                duration: 15
                            },
                            {
                                id: 'skrillex-2',
                                title: 'Resampling to Audio',
                                theoryLabel: 'The Technique',
                                theory: "Record your synth tweaking to raw audio, then chop it up.",
                                drillLabel: 'The Edit',
                                drill: "Don't keep MIDI. Record a wild synth jam to audio. Find the best split-second slice and use that.",
                                duration: 15
                            }
                        ]
                    },
                    {
                        id: 'flume',
                        name: 'Flume',
                        archetype: 'The Granular Architect',
                        theme: 'pink',
                        quote: "I got bored of standard drums. I wanted to make beats out of glass and metal.",
                        origin: "Known for granular synthesis and future-bass textures.",
                        lessons: [
                            {
                                id: 'flume-1',
                                title: 'Granular Synthesis',
                                theoryLabel: 'The Concept',
                                theory: "Break samples into tiny grains to create clouds of sound.",
                                drillLabel: 'The Drill',
                                drill: "Put a vocal sample in a Granular Sampler. Freeze one moment to create a metallic synth pad.",
                                duration: 15
                            },
                            {
                                id: 'flume-2',
                                title: 'Silence as Heavy Drop',
                                theoryLabel: 'The Arrange',
                                theory: "Heaviness comes from contrast. Use absolute silence right before the bass hits.",
                                drillLabel: 'The Lesson',
                                drill: "Insert a bar of silence before your chorus drop.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'sophie',
                        name: 'SOPHIE',
                        archetype: 'The Materialist',
                        theme: 'cyan',
                        quote: "I try to make sounds that resemble materials—latex, metal, bubbles.",
                        origin: "Pioneer of Hyperpop and physical modeling synthesis.",
                        lessons: [
                            {
                                id: 'sophie-1',
                                title: 'Physical Modeling',
                                theoryLabel: 'The Concept',
                                theory: "Use synths that mathematically model how objects vibrate (metal, glass).",
                                drillLabel: 'The Drill',
                                drill: "Create a percussion sound that mimics water using pitch envelopes and sine waves.",
                                duration: 15
                            },
                            {
                                id: 'sophie-2',
                                title: 'The Hyper-Real Transient',
                                theoryLabel: 'The Technique',
                                theory: "Use a Transient Shaper to max out Attack and kill Sustain for snapping sounds.",
                                drillLabel: 'The Drill',
                                drill: "Make a snare sound impossibly short (milliseconds) but punchy.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol7',
                title: 'Volume VII: The Cinematic Composers',
                subtitle: 'Score, Tension, and The Orchestra',
                musicians: [
                    {
                        id: 'zimmer',
                        name: 'Hans Zimmer',
                        archetype: 'The Maximalist',
                        theme: 'stone',
                        quote: "If you talk to a director, don't talk about music. Talk about the story.",
                        origin: "Film score legend known for massive, hybrid orchestral sounds.",
                        lessons: [
                            {
                                id: 'zimmer-1',
                                title: 'The "Shepard Tone" Illusion',
                                theoryLabel: 'The Concept',
                                theory: "An audio illusion that sounds like pitch is infinitely rising.",
                                drillLabel: 'The Drill',
                                drill: "Layer three octaves of a rising synth. Fade high layers out as low layers fade in.",
                                duration: 15
                            },
                            {
                                id: 'zimmer-2',
                                title: 'The "Braaam" Horn',
                                theoryLabel: 'The Sound',
                                theory: "It's not just brass. It's Brass + Distorted Synth + Slow Piano.",
                                drillLabel: 'The Recipe',
                                drill: "Layer a distorted Sawtooth wave under your orchestral brass section for growl.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'goransson',
                        name: 'Ludwig Göransson',
                        archetype: 'The Organic Looper',
                        theme: 'green',
                        quote: "Take something real—a breath, a footstep—and make that the engine.",
                        origin: "Composer for Mandalorian and Oppenheimer, using found sounds.",
                        lessons: [
                            {
                                id: 'goransson-1',
                                title: 'Found-Sound Rhythm',
                                theoryLabel: 'The Technique',
                                theory: "Use organic noises (footsteps, Geiger counters) as rhythmic grids.",
                                drillLabel: 'The Drill',
                                drill: "Record a rhythmic noise like a spinning coin. Loop and quantize it as a hi-hat.",
                                duration: 15
                            },
                            {
                                id: 'goransson-2',
                                title: 'Tempo Variation',
                                theoryLabel: 'The Concept',
                                theory: "Automate tempo to breathe. Speed up for climax, slow down for resolution.",
                                drillLabel: 'The Automation',
                                drill: "Automate master tempo from 120 to 124 BPM during a build-up.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'williams',
                        name: 'John Williams',
                        archetype: 'The Melodist',
                        theme: 'yellow',
                        quote: "I have to write themes that you can whistle after hearing them once.",
                        origin: "The master of the leitmotif (Star Wars, Jaws).",
                        lessons: [
                            {
                                id: 'williams-1',
                                title: 'The Leitmotif',
                                theoryLabel: 'The Concept',
                                theory: "Assign a specific melody or sound to a character or feeling.",
                                drillLabel: 'The Application',
                                drill: "Create a 'Hook' sound (whistle, synth) that plays every time the chorus is hinted at.",
                                duration: 10
                            },
                            {
                                id: 'williams-2',
                                title: 'Interval Jumping',
                                theoryLabel: 'The Theory',
                                theory: "Heroic themes use large jumps (5ths, Octaves). Sad themes use small steps.",
                                drillLabel: 'The Drill',
                                drill: "Write a melody using only large interval jumps for an uplifting feel.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol8',
                title: 'Volume VIII: The Vocal Architects',
                subtitle: 'Tuning, Stacking, and Booth Psychology',
                musicians: [
                    {
                        id: 'lange',
                        name: 'Mutt Lange',
                        archetype: 'The Stack Master',
                        theme: 'red',
                        quote: "The background vocals should sound like a synthesizer made of human voices.",
                        origin: "Producer for Def Leppard and Shania Twain, known for massive vocal stacks.",
                        lessons: [
                            {
                                id: 'lange-1',
                                title: 'The "Mutt" Stack',
                                theoryLabel: 'The Recipe',
                                theory: "Record 2x Melody, 2x High Harmony, 2x Low Harmony, 2x Whispers.",
                                drillLabel: 'The Result',
                                drill: "Record a chorus with at least 8 layers of vocals. Align timing perfectly.",
                                duration: 20
                            },
                            {
                                id: 'lange-2',
                                title: 'EQing the Stack',
                                theoryLabel: 'The Mix',
                                theory: "Backing vocals don't need body. High-pass them up to 500Hz.",
                                drillLabel: 'The Drill',
                                drill: "Filter all bass out of backing vocals so they float like air.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'eilish',
                        name: 'Billie Eilish (Finneas)',
                        archetype: 'The ASMR Producer',
                        theme: 'green',
                        quote: "I want the vocal to sound like she is sitting next to you on the bed.",
                        origin: "Known for intimate, dry, whisper-quiet vocals.",
                        lessons: [
                            {
                                id: 'eilish-1',
                                title: 'The Dry Vocal',
                                theoryLabel: 'The Technique',
                                theory: "Record in a dead room. Zero reverb. Heavy compression.",
                                drillLabel: 'The Mix',
                                drill: "Remove all reverb. Compress vocal 10:1. Enjoy the intimacy.",
                                duration: 10
                            },
                            {
                                id: 'eilish-2',
                                title: 'Comping Breaths',
                                theoryLabel: 'The Edit',
                                theory: "Don't delete breaths. Turn them up or process them separately.",
                                drillLabel: 'The Drill',
                                drill: "Cut breaths to a separate track and make them louder for emotion.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'harrell',
                        name: 'Kuk Harrell',
                        archetype: 'The Vocal Coach',
                        theme: 'blue',
                        quote: "It’s not about pitch. It’s about attitude.",
                        origin: "Vocal producer for Rihanna and Beyoncé.",
                        lessons: [
                            {
                                id: 'harrell-1',
                                title: 'The "Money" Take',
                                theoryLabel: 'The Psychology',
                                theory: "Don't sing the whole song. Loop one phrase and sing it 10 times fast.",
                                drillLabel: 'The Method',
                                drill: "Loop a difficult phrase. Sing it repeatedly until muscle memory takes over.",
                                duration: 15
                            },
                            {
                                id: 'harrell-2',
                                title: 'Melodyne as Instrument',
                                theoryLabel: 'The Tool',
                                theory: "Use Melodyne to fix timing and length, not just pitch.",
                                drillLabel: 'The Drill',
                                drill: "Tighten the rhythm of a vocal performance as if it were a drum track.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol9',
                title: 'Volume IX: The Workflow Warriors',
                subtitle: 'Speed, Templates, and Executive Decision',
                musicians: [
                    {
                        id: 'kennybeats',
                        name: 'Kenny Beats',
                        archetype: 'The Sprinter',
                        theme: 'orange',
                        quote: "Don't overthink sh*t. If you spend 20 minutes on a hi-hat, you've lost the vibe.",
                        origin: "Modern hip-hop producer known for speed and 'The Cave'.",
                        lessons: [
                            {
                                id: 'kennybeats-1',
                                title: 'The 10-Minute Timer',
                                theoryLabel: 'The Challenge',
                                theory: "Creativity is a faucet. You have to run the brown water to get clear water.",
                                drillLabel: 'The Rules',
                                drill: "Set a timer for 10 minutes. Make a beat using loops/presets. Stop when time is up.",
                                duration: 10
                            },
                            {
                                id: 'kennybeats-2',
                                title: '"Type Beat" Psychology',
                                theoryLabel: 'The Strategy',
                                theory: "Limit choices. If you want a Drake sound, use a Drake kit.",
                                drillLabel: 'The Drill',
                                drill: "Pick a specific style before starting. Use only sounds that fit that style.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'kanye',
                        name: 'Kanye West',
                        archetype: 'The Executive',
                        theme: 'stone',
                        quote: "I'm not a rapper; I'm a curator. I put the pieces together.",
                        origin: "Hip-hop mogul known for sampling and curation.",
                        lessons: [
                            {
                                id: 'kanye-1',
                                title: 'Sampling the Room',
                                theoryLabel: 'The Method',
                                theory: "Layer imperfect human sounds (claps, hums) over digital drums.",
                                drillLabel: 'The Texture',
                                drill: "Record friends clapping or humming. Layer it over your beat for a 'choir' effect.",
                                duration: 10
                            },
                            {
                                id: 'kanye-2',
                                title: 'Voice Memos as Samples',
                                theoryLabel: 'The Source',
                                theory: "Phone mics add natural grit.",
                                drillLabel: 'The Drill',
                                drill: "Record an idea on your phone. Import it and use it as a sample.",
                                duration: 10
                            }
                        ]
                    },
                    {
                        id: 'grimes',
                        name: 'Grimes',
                        archetype: 'The DIY Icon',
                        theme: 'pink',
                        quote: "Limitations force you to be creative.",
                        origin: "Produced acclaimed albums in her bedroom.",
                        lessons: [
                            {
                                id: 'grimes-1',
                                title: 'Learn One Synth Perfectly',
                                theoryLabel: 'The Philosophy',
                                theory: "Don't buy 50 plugins. Master one.",
                                drillLabel: 'The Drill',
                                drill: "Make a kick, bass, pad, and lead using ONLY one synth plugin.",
                                duration: 20
                            },
                            {
                                id: 'grimes-2',
                                title: '"Bedroom" Acoustics',
                                theoryLabel: 'The Reality',
                                theory: "Performance matters more than fidelity.",
                                drillLabel: 'The Drill',
                                drill: "Record vocals under a blanket. Embrace the lo-fi texture.",
                                duration: 10
                            }
                        ]
                    }
                ]
            },
            {
                id: 'prod_vol10',
                title: 'Volume X: The Science Lab',
                subtitle: 'Mastering, Acoustics, and Physics',
                musicians: [
                    {
                        id: 'mastering',
                        name: 'Mastering Engineers',
                        archetype: 'The Scientists',
                        theme: 'slate',
                        quote: "Loudness is the difference between the Peak and the RMS.",
                        origin: "Techniques from Bob Ludwig and Emily Lazar.",
                        lessons: [
                            {
                                id: 'mastering-1',
                                title: 'The "Crest Factor"',
                                theoryLabel: 'The Concept',
                                theory: "To get a loud track, you must clip peaks (snare/kick) before the master.",
                                drillLabel: 'The Drill',
                                drill: "Use a clipper on your Snare track to shave off 2dB of peaks.",
                                duration: 10
                            },
                            {
                                id: 'mastering-2',
                                title: 'Mono Compatibility',
                                theoryLabel: 'The Science',
                                theory: "If L/R channels are out of phase, they vanish in Mono (phones).",
                                drillLabel: 'The Check',
                                drill: "Check your mix with a Correlation Meter. Ensure it stays positive.",
                                duration: 5
                            }
                        ]
                    },
                    {
                        id: 'acoustics',
                        name: 'Acoustic Scientists',
                        archetype: 'The Physicists',
                        theme: 'stone',
                        quote: "The room lies to you.",
                        origin: "Understanding how sound behaves in physical spaces.",
                        lessons: [
                            {
                                id: 'acoustics-1',
                                title: 'The "Bass Trap" Myth',
                                theoryLabel: 'The Truth',
                                theory: "Egg cartons and thin foam do not stop bass. Bass goes right through.",
                                drillLabel: 'The Fix',
                                drill: "Mix at low volumes to minimize room reflections if you don't have treatment.",
                                duration: 5
                            },
                            {
                                id: 'acoustics-2',
                                title: 'The "Car Test" Physics',
                                theoryLabel: 'The Why',
                                theory: "Cars amplify bass (60-100Hz) and treble.",
                                drillLabel: 'The Drill',
                                drill: "Check mix in car. If vocals hurt, cut 2k-4kHz. If doors rattle, cut sub bass.",
                                duration: 10
                            }
                        ]
                    }
                ]
            }
        ];

        // --- EXISTING DATA (Volumes, Musicians, etc.) ---
        const VOLUMES = [
          {
            id: 'vol1',
            title: 'Volume I: The Masters of Self-Invention',
            subtitle: 'The Foundations: Rock, Jazz, and the Oral Tradition',
            musicians: [
              {
                id: 'clapton',
                name: 'Eric Clapton',
                archetype: 'The Disciple',
                theme: 'amber',
                quote: "I would practice blues chords for hours... noting weak spots in my performance... until the performance was perfect.",
                origin: "Clapton didn’t want to be a guitarist; he wanted to be a blues singer. Because he was shy about his voice, he forced his guitar to carry the melody. He treated the instrument as a vocal substitute, learning to \"breathe\" with his hands.",
                lessons: [
                  {
                    id: 'clapton-1',
                    title: 'The "Woman Tone" (Sonic Engineering)',
                    theoryLabel: 'The Setup',
                    theory: "Clapton’s Cream-era sound was thick and sustaining, mimicking a cello or voice.",
                    drillLabel: 'The Hack',
                    drill: "Turn your guitar's Tone Knob all the way down to 0 on the neck pickup. Crank the amp volume to compensate. This rolls off sharp highs, forcing legato playing.",
                    duration: 5
                  },
                  {
                    id: 'clapton-2',
                    title: 'The "Vocal" Breath (Phrasing)',
                    theoryLabel: 'The Concept',
                    theory: "Singers have to stop to breathe. Guitarists don't, which is why many sound like typewriters.",
                    drillLabel: 'The Practice',
                    drill: "Play a short lick (The Call). Say out loud: \"Answer me.\" (Creates a mandatory rest). Play a responding lick. No breath = no count.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Tape Loop" Critic',
                    description: 'Record yourself improvising for 2 minutes. Listen back immediately. Identify one specific weakness. Record the same 2 minutes again, fixing only that one thing.'
                }
              },
              {
                id: 'hendrix',
                name: 'Jimi Hendrix',
                archetype: 'The Voodoo Child',
                theme: 'purple',
                quote: "I realized I was able to memorize the notes... I heard that 'G' on the guitar and then I was listening to the radio in the car and I could remember that that was a 'G'.",
                origin: "Hendrix was a \"hanger-on\" who learned by watching. Because he often played in trios (Guitar, Bass, Drums), he had to sound like two people at once. He couldn't just play chords or solos; he merged them.",
                lessons: [
                  {
                    id: 'hendrix-1',
                    title: 'The Thumb-Over Grip (Rhythm/Lead Integration)',
                    theoryLabel: 'The Mechanics',
                    theory: "Wrap your thumb over the top of the neck to fret the Root Note on the Low E string.",
                    drillLabel: 'The Freedom',
                    drill: "This leaves your four fingers free to add \"embellishments\" (hammer-ons and pull-offs) on the high strings while the chord is ringing.",
                    duration: 5
                  },
                  {
                    id: 'hendrix-2',
                    title: 'Double Stops (The R&B Sweetener)',
                    theoryLabel: 'The Texture',
                    theory: "Instead of playing single notes, play two adjacent strings together (usually 4ths or 3rds).",
                    drillLabel: 'The Riff',
                    drill: "In the A Minor Pentatonic scale (5th fret), flatten your index finger across the B and E strings. Play them together. Now hammer your ring finger onto the G string (7th fret). This mimics the sound of an R&B horn section.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Radio" Memory',
                    description: 'Turn on a random playlist, pause a melody, and try to find it on your instrument within three tries.'
                }
              },
              {
                id: 'page',
                name: 'Jimmy Page',
                archetype: 'The Session Master',
                theme: 'zinc',
                quote: "I’d listen to records at 33 rpm instead of 45 rpm... It was the only way to figure out what they were doing.",
                origin: "Before Zeppelin, Page was a 'musical mercenary'. He treated records like blueprints, slowing them down to analyze the construction of every riff. He viewed the studio as an instrument itself.",
                lessons: [
                  {
                    id: 'page-1',
                    title: 'Rhythmic Displacement (The Swagger)',
                    theoryLabel: 'The Groove',
                    theory: "Page often took a simple blues lick but started it on the 'and' of beat 2 instead of beat 1.",
                    drillLabel: 'The Shift',
                    drill: "Take a simple pentatonic lick. Play it starting on Beat 1. Now, force yourself to start the exact same lick on the 'and' of Beat 1.",
                    duration: 10
                  },
                  {
                    id: 'page-2',
                    title: 'Light & Shade (Dynamics)',
                    theoryLabel: 'The Contrast',
                    theory: "Heavy music only sounds heavy if it is contrasted with something quiet.",
                    drillLabel: 'The Application',
                    drill: "Never play at '10' for the whole song. Use volume knob swells or switch to a clean tone for verses.",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "33 RPM" Microscope',
                    description: 'Find a fast riff you love. Use YouTube playback speed to slow it to 0.5x. Learn not just the notes, but the "micro-timing" and articulation of each note.'
                }
              },
              {
                id: 'scofield',
                name: 'John Scofield',
                archetype: 'The Modernist',
                theme: 'teal',
                quote: "If you play a wrong note, it's only wrong if you don't resolve it.",
                origin: "Scofield bridged the gap between funk and intellectual jazz. He obsessed over how to play notes that didn't belong in the key, using them to create tension and then 'slipping' back into safety.",
                lessons: [
                  {
                    id: 'scofield-1',
                    title: '"Outside" Playing (Side-Slipping)',
                    theoryLabel: 'The Tension',
                    theory: "You can approach any 'target note' from a half-step above or below.",
                    drillLabel: 'The Resolution',
                    drill: "Soloing in A Minor? Play a lick in Bb Minor (maximum tension), then immediately repeat the same lick in A Minor (resolution).",
                    duration: 15
                  },
                  {
                    id: 'scofield-2',
                    title: 'Legato Phrasing',
                    theoryLabel: 'The Articulation',
                    theory: "Scofield avoids picking every note to sound less like a guitar.",
                    drillLabel: 'The Flow',
                    drill: "Pick the first note of a string, then use hammer-ons and pull-offs for the rest. Creates a 'slippery' fluid sound.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Wrong Note" Resolution',
                    description: 'Play a backing track. Intentionally play a "wrong" note (outside the scale). Hold it. Do not stop. Find a way to slide it up or down by one fret to make it "right" again.'
                }
              },
              {
                id: 'liebman',
                name: 'David Liebman',
                archetype: 'The Sage',
                theme: 'indigo',
                quote: "Technique is the ability to do what you want to do, when you want to do it.",
                origin: "A saxophone legend who taught generations of musicians how to practice. He views music as a discipline of 'Tone, Technique, and Spirit,' emphasizing that deep listening is more important than fast fingers.",
                lessons: [
                  {
                    id: 'liebman-1',
                    title: 'The Drone (Intonation)',
                    theoryLabel: 'The Reference',
                    theory: "Deep listening requires a reference point. You can't tune if you don't know what you are tuning against.",
                    drillLabel: 'The Ear Training',
                    drill: "Play a continuous low drone note (e.g., Low A). Play slow scales over it. Listen to how every interval feels against that bass note.",
                    duration: 20
                  },
                  {
                    id: 'liebman-2',
                    title: 'Chromatic Enclosure',
                    theoryLabel: 'The Approach',
                    theory: "Never hit a target note directly. Surround it to create gravity.",
                    drillLabel: 'The Target',
                    drill: "Play the Upper Neighbor -> Lower Neighbor -> Target Note. (e.g., to hit C, play Db -> B -> C).",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Singing" Drone',
                    description: 'Play a drone note. Sing a specific interval above it (e.g., a Major 3rd). Only after you sing it and lock the pitch, play the note on your instrument to verify.'
                }
              },
              {
                id: 'vai',
                name: 'Steve Vai',
                archetype: 'The Scientist',
                theme: 'lime',
                quote: "The 10-hour workout was just what I put in the magazine at the time, but for me it was every waking moment.",
                origin: "Vai didn't rely on talent; he relied on data. He is the patron saint of 'The Grid.' He believed that anything physical could be mastered if you broke it down slowly enough and tracked your progress religiously.",
                lessons: [
                  {
                    id: 'vai-1',
                    title: 'The "Finger Independence" Grid',
                    theoryLabel: 'The Physics',
                    theory: "Make awkward movements sound as smooth as easy ones by removing the brain's bias for the index finger.",
                    drillLabel: 'The Permutation',
                    drill: "Play patterns on every string non-stop: 1-2-3-4 (Easy), 1-3-2-4 (Tricky), 4-1-3-2 (The Finger Twister).",
                    duration: 15
                  },
                  {
                    id: 'vai-2',
                    title: 'Audiation (Mental Practice)',
                    theoryLabel: 'The Mind',
                    theory: "If you can't hear it, you can't play it. The hands follow the ear.",
                    drillLabel: 'The Visualization',
                    drill: "Lie in bed. Visualize the fretboard. 'Hear' the pitch of every note in your mind before you see the finger move.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The 10-Hour Mental Grid',
                    description: 'Set a timer for 5 minutes. Close your eyes. Visualize yourself playing your most difficult song perfectly. If your mind wanders or you make a "mental mistake," start the timer over.'
                }
              },
              {
                id: 'django',
                name: 'Django Reinhardt',
                archetype: 'The Survivor',
                theme: 'red',
                quote: "Practice implies that you are struggling with something. I just play.",
                origin: "After the fire that crippled his hand (fusing two fingers), Django had to reinvent the geometry of the fretboard. He couldn't play horizontal scales easily, so he played vertically, changing the vocabulary of jazz guitar forever.",
                lessons: [
                  {
                    id: 'django-1',
                    title: 'Vertical Arpeggios',
                    theoryLabel: 'The Constraint',
                    theory: "Constraint breeds creativity. By losing two fingers, he gained a new sound.",
                    drillLabel: 'The Slide',
                    drill: "Play arpeggios up and down the neck on just the top two strings. Forces rapid shifts and creates that 'Gypsy Jazz' whoosh.",
                    duration: 10
                  },
                  {
                    id: 'django-2',
                    title: 'The Rest Stroke',
                    theoryLabel: 'The Attack',
                    theory: "Maximum energy transfer is needed for acoustic projection.",
                    drillLabel: 'The Technique',
                    drill: "When picking, drive the pick through the string so it comes to rest on the next string below it.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Two-Finger" Constraint',
                    description: 'Tape your ring and pinky fingers together (or just don\'t use them). Play your favorite song using only your index and middle fingers.'
                }
              },
              {
                id: 'bbking',
                name: 'B.B. King',
                archetype: 'The Minimalist',
                theme: 'blue',
                quote: "Notes are expensive. Spend them wisely.",
                origin: "The King of the Blues who proved that one note, played with the right intention, is worth a thousand notes played without it. He treated the guitar like a singer, using vibrato and space to tell a story rather than speed.",
                lessons: [
                  {
                    id: 'bbking-1',
                    title: 'The "B.B. Box"',
                    theoryLabel: 'The Sweet Spot',
                    theory: "The major pentatonic sound with the root on the B string creates a singing quality.",
                    drillLabel: 'The Shape',
                    drill: "Key of A: Index on High E (10th), Ring on B (12th), Index on B (10th). That High E note is magic.",
                    duration: 10
                  },
                  {
                    id: 'bbking-2',
                    title: 'The Butterfly Vibrato',
                    theoryLabel: 'The Touch',
                    theory: "The hand must be free. Unlike rock vibrato (wrist rotation), B.B. shakes his hand like fanning himself.",
                    drillLabel: 'The Motion',
                    drill: "Fret a note with index. Remove thumb from back of neck. Shake entire hand/wrist rapidly. Do not bend the pitch too wide, keep it fast.",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "One Note" Solo',
                    description: 'Put on a 12-bar blues backing track. Play a solo using ONLY the root note. You must create interest using only rhythm, dynamics, and articulation.'
                }
              }
            ]
          },
          // ... (Rest of volumes can stay same, abridged here for cleaner code, but logic supports all)
           {
            id: 'vol2',
            title: 'Volume II: The Architects of Sound',
            subtitle: 'Groove, Texture, and Physics',
            musicians: [
              {
                id: 'nile',
                name: 'Nile Rodgers',
                archetype: 'The Hitmaker',
                theme: 'pink',
                quote: "It's not about how many notes you play, it's about how many notes you don't let ring.",
                origin: "The master of funk guitar who turned rhythm playing into a lead instrument.",
                lessons: [
                  {
                    id: 'nile-1',
                    title: 'The "Chuck" (Percussive Muting)',
                    theory: "Constant motion creates the groove.",
                    drill: "Keep right hand moving in 16th notes (down-up). Squeeze chord only for accents. Relax instantly for the rest.",
                    duration: 10
                  },
                  {
                    id: 'nile-2',
                    title: 'Triad Inversions',
                    theory: "Big chords clutter the mix.",
                    drill: "Play only top 3 strings (G, B, E). Take a D Major chord and find three different places to play it up the neck.",
                    duration: 10
                  }
                ],
                 artistChallenge: {
                    title: 'The "16th Note" Marathon',
                    description: 'Set metronome to 100 BPM. Mute strings with left hand. Strum continuous 16th notes for 3 minutes without stopping or losing the groove.'
                }
              },
               {
                id: 'keith',
                name: 'Keith Richards',
                archetype: 'The Human Riff',
                theme: 'stone',
                quote: "5 strings, 3 fingers, 2 notes, 1 asshole.",
                origin: "The rolling stone who redefined rock rhythm by removing the clutter.",
                lessons: [
                  {
                    id: 'keith-1',
                    title: 'Open G Tuning',
                    theory: "Remove the low E to create a pure drone.",
                    drill: "Tune to D-G-D-G-B-D. Remove low E string. Play major chords with one finger.",
                    duration: 10
                  },
                  {
                    id: 'keith-2',
                    title: 'The "Weaving" Art',
                    theory: "Two guitars should never play the same thing.",
                    drill: "If partner plays low (open position), you must play high (capo or inversions).",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "Drone" Riff',
                    description: 'Create a riff where one string rings open continuously (a drone) while you change notes on the other strings.'
                }
              },
              {
                id: 'vanhalen',
                name: 'Eddie Van Halen',
                archetype: 'The Innovator',
                theme: 'rose',
                quote: "I didn't really know what scales were... I just heard it in my head and ran my fingers until it matched.",
                origin: "A tinkerer who built his own guitars and reinvented the vocabulary of the instrument.",
                lessons: [
                  {
                    id: 'vh-1',
                    title: 'Two-Handed Tapping',
                    theory: "Transferring piano technique to guitar.",
                    drill: "Tap note (Right Hand) -> Pull off to fretted note (Left Index) -> Hammer on second note (Left Ring).",
                    duration: 15
                  },
                  {
                    id: 'vh-2',
                    title: 'The "Brown Sound"',
                    theory: "Voltage starvation for warmer tone.",
                    drill: "Eddie lowered amp voltage with a Variac for 'spongy' distortion. (Simulate with 'Sag' on modelers).",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "Hummingbird" Pick',
                    description: 'Tremolo pick a single note as fast as physically possible for 60 seconds. Focus on relaxing the wrist, not tensing it.'
                }
              },
              {
                id: 'holdsworth',
                name: 'Allan Holdsworth',
                archetype: 'The Alien',
                theme: 'sky',
                quote: "I wanted to play the saxophone, but I couldn't afford one.",
                origin: "He approached the guitar with a complete disregard for its physical limitations, seeking a fluid, breath-like sound.",
                lessons: [
                  {
                    id: 'holdsworth-1',
                    title: 'Four-Note-Per-String Scales',
                    theory: "Wide intervals create fluid lines.",
                    drill: "Stretch hand to play 4 notes per string instead of standard 3. Allows massive interval jumps.",
                    duration: 20
                  },
                  {
                    id: 'holdsworth-2',
                    title: 'Volume Swells',
                    theory: "Removing the attack.",
                    drill: "Pick note with volume at 0, swell up. Removes 'pick attack', sounds like violin/synth.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "No Pick" Solo',
                    description: 'Play a solo using only hammer-ons and pull-offs (legato). If you must pick, pick softly. Aim for a saxophone-like fluid sound.'
                }
              }
            ]
          },
          {
            id: 'vol3',
            title: 'Volume III: The Wind & The Keys',
            subtitle: 'Learning from Non-Guitarists',
            musicians: [
              {
                id: 'coltrane',
                name: 'John Coltrane',
                archetype: 'The High Priest',
                theme: 'emerald',
                quote: "I start in the middle of a sentence and move both directions at once.",
                origin: "The saxophonist who pushed harmony to its absolute limit.",
                lessons: [
                  {
                    id: 'coltrane-1',
                    title: '"Sheets of Sound"',
                    theory: "Superimposing arpeggios.",
                    drill: "Over C Major, play an E Minor 7 arpeggio (E-G-B-D). Layers 9ths, 11ths, 13ths.",
                    duration: 20
                  },
                  {
                    id: 'coltrane-2',
                    title: 'The "3-on-1" Practice',
                    theory: "Exhausting the possibilities.",
                    drill: "Take one note (e.g., Root). Find every way to approach it from above/below before landing on it.",
                    duration: 15
                  }
                ],
                artistChallenge: {
                    title: 'The "Giant Steps" cycle',
                    description: 'Play a Major 7 arpeggio. Move it up by a Major 3rd. Play it again. Move up another Major 3rd. Repeat until you are back to start.'
                }
              },
              {
                id: 'davis',
                name: 'Miles Davis',
                archetype: 'The Prince of Darkness',
                theme: 'cyan',
                quote: "Don't play what's there; play what's not there.",
                origin: "The master of space and cool.",
                lessons: [
                  {
                    id: 'davis-1',
                    title: 'The "Eggshells" (Dynamics)',
                    theory: "Restrained power is magnetic.",
                    drill: "Amp loud, play incredibly lightly. Audience leans in.",
                    duration: 10
                  },
                  {
                    id: 'davis-2',
                    title: 'The "Cool" Note Choice',
                    theory: "Ambiguity creates mood.",
                    drill: "End phrase on the 9th (e.g., in C Major, end on D). Sounds unresolved and floating.",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "Negative Space" Solo',
                    description: 'Play a phrase. You must then rest for a duration EQUAL to the length of that phrase before playing again.'
                }
              },
              {
                id: 'monk',
                name: 'Thelonious Monk',
                archetype: 'The Maverick',
                theme: 'slate',
                quote: "The piano ain't got no wrong notes.",
                origin: "He used dissonance and percussive attacks to make the piano speak differently.",
                lessons: [
                  {
                    id: 'monk-1',
                    title: 'The Whole Tone Scale',
                    theory: "A scale of only whole steps. No gravity.",
                    drill: "Use over Dominant chords (e.g., G7). Sounds floaty and unanchored.",
                    duration: 10
                  },
                  {
                    id: 'monk-2',
                    title: 'Rhythmic Displacement',
                    theory: "Make the melody stumble.",
                    drill: "Take a simple melody. Delay every other note by an 8th note.",
                    duration: 15
                  }
                ],
                artistChallenge: {
                    title: 'The "Elbow" Cluster',
                    description: 'Play a chord, but intentionally mash two adjacent keys (a cluster) for one of the notes to create percussive tension.'
                }
              }
            ]
          },
          {
            id: 'vol4',
            title: 'Volume IV: The Voice & The Engine',
            subtitle: 'Vocals, Bass, and Drums',
            musicians: [
              {
                id: 'sinatra',
                name: 'Frank Sinatra',
                archetype: 'The Chairman',
                theme: 'orange',
                quote: "I was fascinated by how Tommy Dorsey could sneak a breath without breaking the note.",
                origin: "The master of phrasing and breath control.",
                lessons: [
                  {
                    id: 'sinatra-1',
                    title: 'The "Underwater" Lung',
                    theory: "Breath control equals tone control.",
                    drill: "Take deep breath. Play single note. Hold for 30 seconds without wavering.",
                    duration: 5
                  },
                  {
                    id: 'sinatra-2',
                    title: 'The Dorsey Slur',
                    theory: "Connecting the dots.",
                    drill: "Don't play Note-Note. Play Line___. Connect end of one note exactly to start of next.",
                    duration: 10
                  }
                ],
                artistChallenge: {
                    title: 'The "One Breath" Verse',
                    description: 'Try to play/sing an entire verse of a song in a single breath. If you run out of air, stop. Work on extending your capacity.'
                }
              },
              {
                id: 'jamerson',
                name: 'James Jamerson',
                archetype: 'The Shadow',
                theme: 'yellow',
                quote: "If you don't feel it, don't play it.",
                origin: "The Motown genius who played the most complex basslines with one finger.",
                lessons: [
                  {
                    id: 'jamerson-1',
                    title: '"The Hook" (One-Finger Technique)',
                    theory: "Limitation creates groove.",
                    drill: "Play basslines using ONLY right index finger. Forces use of ghost notes and syncopation.",
                    duration: 15
                  },
                  {
                    id: 'jamerson-2',
                    title: 'Chromatic Walk-Ups',
                    theory: "Leading the listener.",
                    drill: "Going G to C? Don't jump. Play G -> A -> Bb -> B -> C.",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "Ghost Note" Groove',
                    description: 'Play a groove where you play twice as many "ghost notes" (muted percussive hits) as actual pitched notes.'
                }
              },
              {
                id: 'bonham',
                name: 'John Bonham',
                archetype: 'The Heavyweight',
                theme: 'zinc',
                quote: "I've always liked the drums to be the lead instrument.",
                origin: "The thunder of Led Zeppelin.",
                lessons: [
                  {
                    id: 'bonham-1',
                    title: 'The "Lazy" Snare',
                    theory: "Stretching the time.",
                    drill: "Kick drum slightly ahead (anxious), Snare slightly behind (lazy). Creates massive groove.",
                    duration: 10
                  },
                  {
                    id: 'bonham-2',
                    title: 'Tuning High',
                    theory: "Projection cuts through sludge.",
                    drill: "Bonham tuned drums high, not low, to cut through the guitars.",
                    duration: 5
                  }
                ],
                artistChallenge: {
                    title: 'The "Triplet" Hand-Foot',
                    description: 'Play triplets between your hands and right foot (R-L-Foot). Speed it up until it sounds like a rolling thunder.'
                }
              }
            ]
          },
          {
            id: 'vol5',
            title: 'Volume V: The Soul of the Note',
            subtitle: 'Blues, Hard Bop, and Classic Rock',
            musicians: [
              {
                id: 'king-albert',
                name: 'Albert King',
                archetype: 'The Velvet Bulldozer',
                theme: 'purple',
                quote: "I play the blues because I'm happy, I play the blues because I'm sad... but mostly, I play to make YOU feel it.",
                origin: "A left-handed player who played a right-handed guitar upside down, creating a unique bending style.",
                lessons: [
                  {
                    id: 'king-albert-1',
                    title: 'The "Over-Bend"',
                    theoryLabel: 'The Signature',
                    theory: "Albert didn't just bend one step; he bent 1.5 or even 2 full steps (a minor third).",
                    drillLabel: 'The Drill',
                    drill: "Play a note on the B string. Bend it up until it matches the pitch of the note 3 frets higher.",
                    duration: 15
                  },
                  {
                    id: 'king-albert-2',
                    title: 'The "Squeeze"',
                    theoryLabel: 'The Technique',
                    theory: "Don't just hit a note dead on. \"Squeeze\" it slightly sharp (quarter tone) immediately upon attack.",
                    drillLabel: 'The Drill',
                    drill: "Practice hitting a note and immediately squeezing it sharp for expression.",
                    duration: 5
                  }
                ]
              },
              {
                id: 'king-freddie',
                name: 'Freddie King',
                archetype: 'The Texas Cannonball',
                theme: 'red',
                quote: "You gotta have that drive. If you lose the drive, you lose the people.",
                origin: "A powerhouse bluesman known for his energetic stage presence and hybrid picking.",
                lessons: [
                  {
                    id: 'king-freddie-1',
                    title: 'The "Hybrid" Attack',
                    theoryLabel: 'The Technique',
                    theory: "Use a heavy pick for the bass strings (downstrokes) and your middle/ring fingers to snap the treble strings (upstrokes).",
                    drillLabel: 'The Drill',
                    drill: "Practice alternating bass downstrokes with finger snaps on the high strings.",
                    duration: 15
                  },
                  {
                    id: 'king-freddie-2',
                    title: 'The Turnaround',
                    theoryLabel: 'The Concept',
                    theory: "If you play the same turnaround every time, the audience stops listening.",
                    drillLabel: 'The Drill',
                    drill: "Learn 5 distinct ways to get from the I chord back to the V chord.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'rollins',
                name: 'Sonny Rollins',
                archetype: 'The Colossus',
                theme: 'yellow',
                quote: "I don't just play the chords. I play the song.",
                origin: "A saxophone colossus who focuses on thematic improvisation.",
                lessons: [
                  {
                    id: 'rollins-1',
                    title: 'The "Motif" Challenge',
                    theoryLabel: 'The Assignment',
                    theory: "Improvising on a theme rather than just scales.",
                    drillLabel: 'The Drill',
                    drill: "Play a simple 3-note rhythm (e.g., \"Da-Da-DA\"). Improvise a 12-bar solo using only that rhythm. You can change the notes, but you cannot change the rhythm.",
                    duration: 20
                  },
                  {
                    id: 'rollins-2',
                    title: 'Staccato Articulation',
                    theoryLabel: 'The Sound',
                    theory: "Practice your scales playing every note short and punchy. It creates a \"strutting\" feeling.",
                    drillLabel: 'The Drill',
                    drill: "Play a major scale with extreme staccato articulation.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'gilmour',
                name: 'David Gilmour',
                archetype: 'The Tone Bender',
                theme: 'cyan',
                quote: "I can’t play fast, so I have to make every note count.",
                origin: "The voice of Pink Floyd, master of touch and tone.",
                lessons: [
                  {
                    id: 'gilmour-1',
                    title: 'The "Step-and-a-Half" Bend',
                    theoryLabel: 'The Challenge',
                    theory: "Accuracy is everything.",
                    drillLabel: 'The Drill',
                    drill: "Play a note. Your target is the note 3 semitones higher. Bend up to it. Check your pitch against a tuner.",
                    duration: 15
                  },
                  {
                    id: 'gilmour-2',
                    title: 'The "Violin" Sustain',
                    theoryLabel: 'The Technique',
                    theory: "Add vibrato only at the end of the note, not the beginning. Let the note bloom first, then shake it.",
                    drillLabel: 'The Drill',
                    drill: "Hold a bent note perfectly still for 2 seconds, then add vibrato.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'may',
                name: 'Brian May',
                archetype: 'The Orchestrator',
                theme: 'orange',
                quote: "I wanted the guitar to be a voice, but not just one voice... a choir.",
                origin: "The Queen guitarist who built his own guitar and created distinct orchestral layers.",
                lessons: [
                  {
                    id: 'may-1',
                    title: 'The "Sixpence" Tone',
                    theoryLabel: 'The Hack',
                    theory: "Use a coin (or a rigid metal pick) with a serrated edge. It creates a metallic \"rasp\" that cuts through the mix.",
                    drillLabel: 'The Drill',
                    drill: "Try picking with a coin or very hard pick to hear the difference in attack.",
                    duration: 5
                  },
                  {
                    id: 'may-2',
                    title: 'Harmonized Thirds',
                    theoryLabel: 'The Concept',
                    theory: "Creating a choir of guitars.",
                    drillLabel: 'The Drill',
                    drill: "Record a melody. Record a second track playing the exact same rhythm, but a third higher.",
                    duration: 15
                  }
                ]
              }
            ]
          },
          {
            id: 'vol6',
            title: 'Volume VI: The Acoustic Alchemists',
            subtitle: 'Tunings, Percussion, and The "Piano" Approach',
            musicians: [
              {
                id: 'mitchell',
                name: 'Joni Mitchell',
                archetype: 'The Painter',
                theme: 'amber',
                quote: "I didn't like standard tuning. It sounded like a starved horse. I tuned the guitar to chords I heard in my head.",
                origin: "Joni weakened her left hand due to childhood polio. She couldn't form standard barre chords easily. To compensate, she invented over 50 different open tunings. She treated the fretboard like a canvas, focusing on \"Chords of Inquiry\"—chords that didn't resolve, asking a question instead.",
                lessons: [
                  {
                    id: 'mitchell-1',
                    title: 'Tuning as Composition',
                    theoryLabel: 'The Concept',
                    theory: "Don't write a song in Standard Tuning (EADGBE).",
                    drillLabel: 'The Assignment',
                    drill: "Tune your guitar to a random Open Chord (e.g., Open D: D-A-D-F#-A-D). Now, find shapes using only one or two fingers. You will instantly break your muscle memory and write something unique because your \"old tricks\" won't work.",
                    duration: 15
                  },
                  {
                    id: 'mitchell-2',
                    title: 'The "Suspended" Strum',
                    theoryLabel: 'The Sound',
                    theory: "Joni rarely played straight major/minor chords. She played \"Sus2\" or \"Sus4\" chords that felt suspended in mid-air.",
                    drillLabel: 'The Drill',
                    drill: "Lift the \"3rd\" out of your chords. If you are playing A Major, lift your finger off the C# to make it Asus2. Keep the harmony ambiguous.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'hedges',
                name: 'Michael Hedges',
                archetype: 'The Percussionist',
                theme: 'stone',
                quote: "The guitar is a drum with strings.",
                origin: "He revolutionized acoustic guitar by using the body as a percussion instrument and using both hands on the fretboard.",
                lessons: [
                  {
                    id: 'hedges-1',
                    title: 'The Left-Hand Hammer',
                    theoryLabel: 'The Technique',
                    theory: "Hammer-ons aren't just for trills. Hedges used his left hand to hammer bass lines on the low strings while his right hand played percussion on the guitar body.",
                    drillLabel: 'The Drill',
                    drill: "Tap a rhythm on the wood of your guitar with your right hand. Without strumming, try to hammer a bass note (Low E) with your left hand hard enough to make it ring out.",
                    duration: 15
                  },
                  {
                    id: 'hedges-2',
                    title: 'Slap Harmonics',
                    theoryLabel: 'The Move',
                    theory: "Slap the strings exactly over the 12th fret wire with your right middle finger. Pull away instantly (like touching a hot stove). This creates a massive, ringing harmonic chord.",
                    drillLabel: 'The Drill',
                    drill: "Practice hitting the 12th fret harmonic with a slap motion until it rings clear.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'drake',
                name: 'Nick Drake',
                archetype: 'The Ghost',
                theme: 'slate',
                quote: "I don't think I have a 'style'. I just play the notes I hear.",
                origin: "A solitary figure who created hypnotic, trance-like folk music using complex fingerpicking and strange tunings.",
                lessons: [
                  {
                    id: 'drake-1',
                    title: 'The "Dead" Thumb',
                    theoryLabel: 'The Feel',
                    theory: "Unlike the bouncy Travis Picking of Chet Atkins, Drake played a steady, thumping, hypnotic bass line with his thumb that rarely syncopated. It created a trance-like state.",
                    drillLabel: 'The Drill',
                    drill: "Play a fingerstyle pattern where the thumb plays strict quarter notes (1-2-3-4) with zero accent. It should sound like a metronome, not a melody.",
                    duration: 15
                  },
                  {
                    id: 'drake-2',
                    title: 'The Cluster Chord',
                    theoryLabel: 'The Voicing',
                    theory: "Drake used tunings like BEBEBE. He would play \"clusters\"—notes that are right next to each other (semitones) ringing out together.",
                    drillLabel: 'The Drill',
                    drill: "Tune to an open tuning and find adjacent notes on adjacent strings to create dissonant clusters.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol7',
            title: 'Volume VII: The High-Velocity Technicians',
            subtitle: 'Economy, Efficiency, and "The Sweep"',
            musicians: [
              {
                id: 'malmsteen',
                name: 'Yngwie Malmsteen',
                archetype: 'The Neoclassical',
                theme: 'red',
                quote: "Less is more? No. More is more.",
                origin: "Malmsteen didn't want to play blues; he wanted to play Paganini (violin) on the Stratocaster. He pioneered \"Sweep Picking.\"",
                lessons: [
                  {
                    id: 'malmsteen-1',
                    title: 'Economy Picking (The Sweep)',
                    theoryLabel: 'The Physics',
                    theory: "If you are moving from the Low E string to the A string, why pick Up? You are already moving Down.",
                    drillLabel: 'The Drill',
                    drill: "When changing strings, continue the stroke direction. Down-stroke on E, push through to Down-stroke on A. Do not alternate pick when changing strings.",
                    duration: 20
                  },
                  {
                    id: 'malmsteen-2',
                    title: 'The Harmonic Minor Scale',
                    theoryLabel: 'The Sound',
                    theory: "The \"Vampire\" sound. Take the Natural Minor scale and raise the 7th note by one half-step. (In A Minor: A-B-C-D-E-F-G#-A). That G# creates the tension that screams \"Classical Music.\"",
                    drillLabel: 'The Scale',
                    drill: "Play A Harmonic Minor up and down one string.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'govan',
                name: 'Guthrie Govan',
                archetype: 'The Professor',
                theme: 'sky',
                quote: "If you learn a scale, learn it on one string first. If you learn a box shape, you're just learning geography, not music.",
                origin: "The master of modern fusion and technique.",
                lessons: [
                  {
                    id: 'govan-1',
                    title: 'Bending with the Wrist',
                    theoryLabel: 'The Anatomy',
                    theory: "Don't push the string with your fingers (muscles are small). Lock your fingers and rotate your wrist (muscles are big). This gives you total control over the pitch and vibrato of a bend.",
                    drillLabel: 'The Drill',
                    drill: "Practice bending a whole step using only wrist rotation.",
                    duration: 15
                  },
                  {
                    id: 'govan-2',
                    title: 'Knowing the Note',
                    theoryLabel: 'The Concept',
                    theory: "Audiation is key.",
                    drillLabel: 'The Drill',
                    drill: "Pick a random note on the fretboard. Before you play it, sing the pitch. If you are wrong, you don't know the fretboard; you are guessing.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'becker',
                name: 'Jason Becker',
                archetype: 'The Prodigy',
                theme: 'purple',
                quote: "I just wanted to make the guitar sound like a symphony.",
                origin: "A virtuoso who pushed arpeggios beyond simple triads.",
                lessons: [
                  {
                    id: 'becker-1',
                    title: 'Serrated Arpeggios',
                    theoryLabel: 'The Concept',
                    theory: "Instead of sweeping a simple major triad (1-3-5), Becker would skip strings or add the 7th to make the sweep sound jagged and unpredictable.",
                    drillLabel: 'The Drill',
                    drill: "Play a sweep arpeggio but skip the middle string.",
                    duration: 15
                  },
                  {
                    id: 'becker-2',
                    title: 'The Yo-Yo Effect',
                    theoryLabel: 'The Technique',
                    theory: "Use the whammy bar to dip the pitch before you hit the note, then release it as you pick. It creates a \"scoop\" sound.",
                    drillLabel: 'The Drill',
                    drill: "Practice pre-dipping the bar, picking, and releasing to pitch.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol8',
            title: 'Volume VIII: The Funk & Soul Architects',
            subtitle: 'The Pocket, The Stab, and The "One"',
            musicians: [
              {
                id: 'prince',
                name: 'Prince',
                archetype: 'The Purple One',
                theme: 'purple',
                quote: "The space between the notes is where the funk lives.",
                origin: "Prince was arguably the most underrated rhythm guitarist ever. He treated the guitar like a percussion instrument, locking in with the hi-hat.",
                lessons: [
                  {
                    id: 'prince-1',
                    title: 'The 16th Note Scratch',
                    theoryLabel: 'The Groove',
                    theory: "The funk is in the scratching, not the chord.",
                    drillLabel: 'The Drill',
                    drill: "Mute all strings. Strum constant 16th notes. Randomly squeeze a chord (E9) for a single 16th note accent.",
                    duration: 10
                  },
                  {
                    id: 'prince-2',
                    title: 'The "Spanky" Tone',
                    theoryLabel: 'The Sound',
                    theory: "Bridge pickup + Compressor = Dry, upfront sound that cuts.",
                    drillLabel: 'The Drill',
                    drill: "Use a clean tone with a compressor. Practice playing staccato chords that don't ring out.",
                    duration: 5
                  }
                ]
              },
              {
                id: 'benson',
                name: 'George Benson',
                archetype: 'The Jazz-Pop King',
                theme: 'yellow',
                quote: "I play what I sing. It keeps me honest.",
                origin: "A master of scat singing in unison with his guitar lines.",
                lessons: [
                  {
                    id: 'benson-1',
                    title: 'Scat-Unison',
                    theoryLabel: 'The Technique',
                    theory: "Singing your solo note-for-note forces your fingers to be melodic.",
                    drillLabel: 'The Drill',
                    drill: "Play a scale. Sing every note out loud as you play it. If you can't sing it, don't play it.",
                    duration: 15
                  },
                  {
                    id: 'benson-2',
                    title: 'The "Thumb" Sweep',
                    theoryLabel: 'The Attack',
                    theory: "Angling the pick (or using the thumb) creates a smoother attack.",
                    drillLabel: 'The Drill',
                    drill: "Practice playing runs using the side of the pick or your thumb for a softer jazz tone.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'chinna',
                name: 'Earl "Chinna" Smith',
                archetype: 'The Skank Master',
                theme: 'green',
                quote: "The guitar is the chop. It is the heartbeat.",
                origin: "Reggae legend who defined the 'skank' rhythm.",
                lessons: [
                  {
                    id: 'chinna-1',
                    title: 'The "Chop" (The Skank)',
                    theoryLabel: 'The Role',
                    theory: "In Reggae, the guitar plays on the 'and' of the beat (1 and 2 and).",
                    drillLabel: 'The Drill',
                    drill: "Play a short, staccato downstroke on the off-beat. Mute it instantly.",
                    duration: 10
                  },
                  {
                    id: 'chinna-2',
                    title: 'The Double-Chop',
                    theoryLabel: 'The Variation',
                    theory: "Add a muted upstroke before the downstroke (ch-CHOP) to add a shuffle feel.",
                    drillLabel: 'The Drill',
                    drill: "Practice the 'ch-CHOP' motion with a shuffle feel.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol9',
            title: 'Volume IX: The "Anti-Heroes"',
            subtitle: 'Simplicity, Effects, and Songwriting',
            musicians: [
              {
                id: 'cobain',
                name: 'Kurt Cobain',
                archetype: 'The Punk',
                theme: 'stone',
                quote: "I’m the first to admit that I’m no virtuoso. I can’t play like Segovia.",
                origin: "He focused on Power Chords and visceral emotion over technical proficiency.",
                lessons: [
                  {
                    id: 'cobain-1',
                    title: 'The "Sloppy" Double',
                    theoryLabel: 'The Technique',
                    theory: "When playing power chords, intentionally let the open strings ring out to create a massive wall of sound.",
                    drillLabel: 'The Drill',
                    drill: "Play power chords but don't mute the high E and B strings. Let them ring open against the chord.",
                    duration: 10
                  },
                  {
                    id: 'cobain-2',
                    title: 'Quiet/Loud Dynamics',
                    theoryLabel: 'The Formula',
                    theory: "Clean verse, Distorted chorus. The shock value is the hook.",
                    drillLabel: 'The Drill',
                    drill: "Practice switching from a whisper-quiet clean tone to full distortion instantly on the downbeat.",
                    duration: 5
                  }
                ]
              },
              {
                id: 'edge',
                name: 'The Edge',
                archetype: 'The Scientist of Delay',
                theme: 'cyan',
                quote: "I found that by using echo, I could play fewer notes and have them sound huge.",
                origin: "The U2 guitarist who uses delay as a rhythmic instrument.",
                lessons: [
                  {
                    id: 'edge-1',
                    title: 'Dotted 8th Note Delay',
                    theoryLabel: 'The Secret',
                    theory: "Set delay to Dotted 8th. Playing straight 8th notes creates a galloping rhythm.",
                    drillLabel: 'The Drill',
                    drill: "Set delay to ~350-450ms. Play steady 8th notes. Let the pedal fill the gaps.",
                    duration: 15
                  },
                  {
                    id: 'edge-2',
                    title: 'Two-Note Chords',
                    theoryLabel: 'The Concept',
                    theory: "Play only the Root and 5th, or Root and Octave. Let the delay fill the frequency.",
                    drillLabel: 'The Drill',
                    drill: "Compose a riff using only 2-note intervals.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'morello',
                name: 'Tom Morello',
                archetype: 'The DJ',
                theme: 'red',
                quote: "My guitar is a turntable.",
                origin: "He creates DJ-like scratch effects using the guitar.",
                lessons: [
                  {
                    id: 'morello-1',
                    title: 'The Kill Switch',
                    theoryLabel: 'The Gear Hack',
                    theory: "Turn one pickup to 0, one to 10. Flip the switch rapidly for a stutter effect.",
                    drillLabel: 'The Drill',
                    drill: "Fret a note and toggle the pickup switch rhythmically.",
                    duration: 10
                  },
                  {
                    id: 'morello-2',
                    title: 'Scratching the Strings',
                    theoryLabel: 'The Technique',
                    theory: "Rub the hand or pick along wound strings like a DJ scratching vinyl.",
                    drillLabel: 'The Drill',
                    drill: "Use a Wah pedal and scratch the strings to create rhythmic noise.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol10',
            title: 'Volume X: The Bass & Drums Expanded',
            subtitle: 'Virtuosity in the Engine Room',
            musicians: [
              {
                id: 'jaco',
                name: 'Jaco Pastorius',
                archetype: 'The Fretless Wonder',
                theme: 'orange',
                quote: "I play the bass like I'm playing with human voices.",
                origin: "The electric bass virtuoso who used a fretless bass to sing melodies.",
                lessons: [
                  {
                    id: 'jaco-1',
                    title: 'Bridge Pickup Focus',
                    theoryLabel: 'The Tone',
                    theory: "Plucking close to the bridge gives a tight, mid-range 'burp' sound.",
                    drillLabel: 'The Drill',
                    drill: "Play a scale plucking exclusively right next to the bridge saddles.",
                    duration: 10
                  },
                  {
                    id: 'jaco-2',
                    title: 'False Harmonics',
                    theoryLabel: 'The Technique',
                    theory: "Artificial harmonics allow you to play bell-like melodies.",
                    drillLabel: 'The Drill',
                    drill: "Fret a note, touch the string 12 frets higher with your thumb, and pluck with your index.",
                    duration: 15
                  }
                ]
              },
              {
                id: 'copeland',
                name: 'Stewart Copeland',
                archetype: 'The Poly-Rhythmic Punk',
                theme: 'blue',
                quote: "The hi-hat is an instrument, not just a timekeeper.",
                origin: "The Police drummer known for his intricate hi-hat work and avoiding the backbeat.",
                lessons: [
                  {
                    id: 'copeland-1',
                    title: 'The "Anti-Backbeat"',
                    theoryLabel: 'The Concept',
                    theory: "Accent the hi-hat on off-beats and delay the snare hit.",
                    drillLabel: 'The Drill',
                    drill: "Play a groove where you don't hit the snare on 2 and 4.",
                    duration: 10
                  },
                  {
                    id: 'copeland-2',
                    title: 'The Delay Effect (Acoustic)',
                    theoryLabel: 'The Technique',
                    theory: "Hit a drum loud, then two soft hits to mimic a delay pedal.",
                    drillLabel: 'The Drill',
                    drill: "Practice the LOUD-soft-soft sticking pattern.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'flea',
                name: 'Flea',
                archetype: 'The Punk-Funk',
                theme: 'lime',
                quote: "You have to beat the instrument into submission.",
                origin: "Brought slap bass to the masses with punk energy.",
                lessons: [
                  {
                    id: 'flea-1',
                    title: 'The Slap & Pop',
                    theoryLabel: 'The Mechanics',
                    theory: "Thumb slap low, Index pop high.",
                    drillLabel: 'The Drill',
                    drill: "Practice Octaves (Low E slap, High D pop) in a rhythmic grid.",
                    duration: 15
                  },
                  {
                    id: 'flea-2',
                    title: 'Punk Downpicking',
                    theoryLabel: 'The Stamina',
                    theory: "All downstrokes for driving aggression.",
                    drillLabel: 'The Drill',
                    drill: "Play 8th notes as fast as possible using only downstrokes.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol11',
            title: 'Volume XI: The Studio Sorcerers',
            subtitle: 'The Studio as an Instrument',
            musicians: [
              {
                id: 'parker',
                name: 'Kevin Parker',
                archetype: 'The Auteur',
                theme: 'pink',
                quote: "I want the drums to sound like they are being played in a different room, underwater.",
                origin: "The mastermind behind Tame Impala.",
                lessons: [
                  {
                    id: 'parker-1',
                    title: 'The "Crunch" Loop',
                    theoryLabel: 'The Concept',
                    theory: "Compress and distort drums, then loop them.",
                    drillLabel: 'The Drill',
                    drill: "Record a chord progression. Add a Phaser to the entire mix. Play a clean solo over it.",
                    duration: 15
                  },
                  {
                    id: 'parker-2',
                    title: 'Bass as Melody',
                    theoryLabel: 'The Technique',
                    theory: "Use fuzz bass for the hook, guitar for rhythm.",
                    drillLabel: 'The Drill',
                    drill: "Write a riff where the bass plays the melody.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'eno',
                name: 'Brian Eno',
                archetype: 'The Oblique Strategist',
                theme: 'teal',
                quote: "Stop thinking about art works as objects, and start thinking about them as triggers for experiences.",
                origin: "Ambient pioneer and producer.",
                lessons: [
                  {
                    id: 'eno-1',
                    title: 'Oblique Strategies',
                    theoryLabel: 'The Method',
                    theory: "Use random prompts to break creative blocks.",
                    drillLabel: 'The Assignment',
                    drill: "Use a prompt like 'Honor thy error as a hidden intention' to guide your practice.",
                    duration: 10
                  },
                  {
                    id: 'eno-2',
                    title: 'Ambient Texture',
                    theoryLabel: 'The Drill',
                    theory: "Slow down recordings to create pads.",
                    drillLabel: 'The Drill',
                    drill: "Record a note, slow it down 50%, add reverb. Play over it.",
                    duration: 15
                  }
                ]
              },
              {
                id: 'reznor',
                name: 'Trent Reznor',
                archetype: 'The Industrialist',
                theme: 'stone',
                quote: "I like the idea of organic sounds being destroyed by digital ones.",
                origin: "Nine Inch Nails founder.",
                lessons: [
                  {
                    id: 'reznor-1',
                    title: 'The "Bitcrushed" Piano',
                    theoryLabel: 'The Texture',
                    theory: "Beauty rotting. Run acoustic instruments through distortion.",
                    drillLabel: 'The Drill',
                    drill: "Record something pretty. Destroy it with a bitcrusher effect.",
                    duration: 10
                  },
                  {
                    id: 'reznor-2',
                    title: 'Silence as Violence',
                    theoryLabel: 'The Arrangement',
                    theory: "Cut everything instantly for impact.",
                    drillLabel: 'The Drill',
                    drill: "Create a loop that builds to a peak and then cuts to absolute silence.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol12',
            title: 'Volume XII: The Mental Masters',
            subtitle: 'Psychology, Anxiety, and Flow',
            musicians: [
              {
                id: 'werner',
                name: 'Kenny Werner',
                archetype: 'The Zen Master',
                theme: 'indigo',
                quote: "There are no wrong notes, only the wrong state of mind.",
                origin: "Author of 'Effortless Mastery'.",
                lessons: [
                  {
                    id: 'werner-1',
                    title: 'Effortless Mastery',
                    theoryLabel: 'The Mantra',
                    theory: "Train your body that touching the instrument equals relaxation.",
                    drillLabel: 'The Drill',
                    drill: "Touch the instrument. If tense, stop. Breathe. Touch again. Play nothing until relaxed.",
                    duration: 10
                  },
                  {
                    id: 'werner-2',
                    title: 'The "Space"',
                    theoryLabel: 'The Concept',
                    theory: "Play simple things with the reverence of a masterpiece.",
                    drillLabel: 'The Drill',
                    drill: "Play a C Major scale with total focus and zero judgment.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'gallwey',
                name: 'Timothy Gallwey',
                archetype: 'The Inner Game',
                theme: 'emerald',
                quote: "Performance = Potential - Interference.",
                origin: "Author of 'The Inner Game of Music'.",
                lessons: [
                  {
                    id: 'gallwey-1',
                    title: 'Self 1 vs. Self 2',
                    theoryLabel: 'The Concept',
                    theory: "Distract the critic (Self 1) to let the doer (Self 2) perform.",
                    drillLabel: 'The Drill',
                    drill: "Focus entirely on a non-judgmental variable (e.g., finger pressure) while playing.",
                    duration: 10
                  },
                  {
                    id: 'gallwey-2',
                    title: 'The "Playback" Mode',
                    theoryLabel: 'The Visualization',
                    theory: "Pretend you are miming to a perfect recording.",
                    drillLabel: 'The Drill',
                    drill: "Visualize the perfect sound and just let your hands follow.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol13',
            title: 'Volume XIII: The Global Rhythm',
            subtitle: 'Non-Western Scales and Polyrhythms',
            musicians: [
              {
                id: 'shankar',
                name: 'Ravi Shankar',
                archetype: 'The Guru',
                theme: 'amber',
                quote: "The raga is a living soul.",
                origin: "Sitar virtuoso.",
                lessons: [
                  {
                    id: 'shankar-1',
                    title: 'The Drone (Tanpura)',
                    theoryLabel: 'The Foundation',
                    theory: "Indian classical music explores one key deeply against a drone.",
                    drillLabel: 'The Drill',
                    drill: "Tune Low E to D (Drone). Solo on D string using Lydian mode.",
                    duration: 20
                  },
                  {
                    id: 'shankar-2',
                    title: 'The "Tihai"',
                    theoryLabel: 'The Concept',
                    theory: "A rhythmic phrase repeated three times that lands on the '1'.",
                    drillLabel: 'The Assignment',
                    drill: "Create a 3-beat phrase. Play it 3 times. Calculate where to start so it resolves on the 1.",
                    duration: 15
                  }
                ]
              },
              {
                id: 'fela',
                name: 'Fela Kuti',
                archetype: 'The President',
                theme: 'orange',
                quote: "Music is the weapon of the future.",
                origin: "Afrobeat pioneer.",
                lessons: [
                  {
                    id: 'fela-1',
                    title: 'The Independent Limb',
                    theoryLabel: 'The Groove',
                    theory: "Interlocking parts. Guitar plays a single-note pattern locking with the snare.",
                    drillLabel: 'The Drill',
                    drill: "Play a single-note funk line. Repeat for 5 minutes without variation.",
                    duration: 10
                  },
                  {
                    id: 'fela-2',
                    title: 'Call and Response',
                    theoryLabel: 'The Structure',
                    theory: "Instruments talk. Horns question, guitar answers.",
                    drillLabel: 'The Drill',
                    drill: "Record a 'question' phrase. Practice playing the 'answer'.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'paco',
                name: 'Paco de Lucía',
                archetype: 'The Fire',
                theme: 'red',
                quote: "The hands must be like 10 soldiers.",
                origin: "Flamenco master.",
                lessons: [
                  {
                    id: 'paco-1',
                    title: 'Picado',
                    theoryLabel: 'The Technique',
                    theory: "Alternating index and middle fingers using rest strokes.",
                    drillLabel: 'The Rule',
                    drill: "Play scales with staccato precision using i-m alternation.",
                    duration: 15
                  },
                  {
                    id: 'paco-2',
                    title: 'Compás',
                    theoryLabel: 'The Count',
                    theory: "Flamenco often uses a 12-beat cycle.",
                    drillLabel: 'The Drill',
                    drill: "Clap the 12-beat accent pattern. Play a phrase that fits it.",
                    duration: 10
                  }
                ]
              }
            ]
          },
          {
            id: 'vol14',
            title: 'Volume XIV: The Classical Titans',
            subtitle: 'Discipline, Articulation, and Architecture',
            musicians: [
              {
                id: 'gould',
                name: 'Glenn Gould',
                archetype: 'The Eccentric',
                theme: 'slate',
                quote: "The purpose of art is... the gradual, lifelong construction of a state of wonder.",
                origin: "Classical pianist known for his humming and detached style.",
                lessons: [
                  {
                    id: 'gould-1',
                    title: 'Non-Legato Practice',
                    theoryLabel: 'The Technique',
                    theory: "Practice fast runs slowly and detached (staccato) to reveal flaws.",
                    drillLabel: 'The Benefit',
                    drill: "Play a scale as staccato as possible. Every note must be a pearl.",
                    duration: 15
                  },
                  {
                    id: 'gould-2',
                    title: 'Singing the Contrapuntal Line',
                    theoryLabel: 'The Drill',
                    theory: "Play melody, sing bass.",
                    drillLabel: 'The Drill',
                    drill: "Play a melody. Sing a counter-melody or bass line simultaneously.",
                    duration: 10
                  }
                ]
              },
              {
                id: 'paganini',
                name: 'Niccolò Paganini',
                archetype: 'The Devil',
                theme: 'red',
                quote: "I am not handsome, but when women hear me play, they come crawling to my feet.",
                origin: "Violin virtuoso who revolutionized technique.",
                lessons: [
                  {
                    id: 'paganini-1',
                    title: 'The "Caprice" Challenge',
                    theoryLabel: 'The Concept',
                    theory: "Write a piece specifically to target your weakness.",
                    drillLabel: 'The Assignment',
                    drill: "Identify a weakness. Write a musical etude that forces you to do it.",
                    duration: 20
                  },
                  {
                    id: 'paganini-2',
                    title: 'Extreme Dynamics',
                    theoryLabel: 'The Drama',
                    theory: "Whisper to scream in a single bar.",
                    drillLabel: 'The Drill',
                    drill: "Play a scale with sawtooth dynamics: Note 1 (ff), Note 2 (pp), Note 3 (ff).",
                    duration: 10
                  }
                ]
              }
            ]
          }
        ];

        const MUSICIAN_CHALLENGES = [
          { id: 1, title: 'The "Audiation" Night Shift', artist: 'Vai', text: 'Lie in bed for 15 minutes before sleep. Visualize your fretboard. "Play" a C Major scale in your mind. You must vividly hear the pitch of every note before you visualize your finger moving to it.' },
          { id: 2, title: 'The "Tape Loop" Critic', artist: 'Clapton', text: 'Record yourself improvising for 2 minutes. Listen back immediately. Identify one specific weakness. Record the same 2 minutes again, fixing only that one thing.' },
          { id: 3, title: 'The "Radio" Memory', artist: 'Hendrix', text: 'Turn on a random playlist. When a melody plays, pause it. Find that melody on your instrument within 3 tries.' },
          { id: 4, title: 'The "Drone" Test', artist: 'Liebman', text: 'Put on a continuous low drone note (e.g., Low A) for 10 minutes. Play a slow scale over it. Feel how the 3rd is warm and the 7th is tense.' },
          { id: 5, title: 'The "2 and 4" Click', artist: 'Kaye', text: 'Set your metronome to half-speed. The click is now only the snare drum (beats 2 and 4). You are responsible for the "1."' },
          { id: 6, title: 'The "Lazy Snare" Drag', artist: 'Bonham', text: 'Record a simple riff. Play the first take "on the grid." Play the second take intentionally "behind" the beat. Imagine your hands are heavy.' },
          { id: 7, title: 'The "Finger Grid"', artist: 'Vai', text: 'Play the "Linear Permutations" on every string: 1-2-3-4, then 1-3-2-4, then 4-3-2-1 (The hardest).' },
          { id: 8, title: 'The "Hook" Constraint', artist: 'Jamerson', text: 'Play an entire song using only one finger (index finger). You will naturally play fewer notes and more syncopated rhythms.' },
          { id: 9, title: 'The "Vertical" Limit', artist: 'Django', text: 'Solo over a backing track using only one string. You must slide up and down the neck to find the notes.' },
          { id: 10, title: 'The "No Attack" Zone', artist: 'Holdsworth', text: 'Play a solo where the listener cannot hear the pick strike the string. Use hammer-ons, pull-offs, slides, or volume swells.' },
          { id: 11, title: 'The "Sinatra" Breath', artist: 'Sinatra', text: 'Play a phrase. Physically inhale a deep breath. Play the next phrase. You are not allowed to play while you are inhaling.' },
          { id: 12, title: 'The "Sing It First"', artist: 'Ella', text: 'Put down the instrument. Play a backing track. Sing a solo over it (record it). Pick up the instrument and learn to play exactly what you just sang.' },
          { id: 13, title: 'The "Dynamics" Drop', artist: 'Buddy Guy', text: 'Play a 12-bar blues. Bars 1-4: Normal Volume. Bars 5-8: Whisper quiet. Bars 9-12: Full Explosion.' },
          { id: 14, title: 'The "Side-Slip"', artist: 'Scofield', text: 'Play a lick in the "correct" key (A Minor). Shift your hand up one fret (Bb Minor) and play the same lick. Shift back down to A Minor.' },
          { id: 15, title: 'The "Butter" Ban', artist: 'Hancock', text: 'Comp through a standard progression. You are banned from playing the Root or the 5th. You can only play the 3rd and the 7th.' },
          { id: 16, title: 'The "Whole Tone" Dream', artist: 'Monk', text: 'Whenever you see a Dominant 7 chord resolving to C, play a Whole Tone scale (move strictly by 2 frets).' }
        ];

        const PRODUCER_CHALLENGES = [
          { id: 17, title: 'The "Dr. Dre" Drum Day', artist: 'Dr. Dre', text: 'Spend one full session (2 hours) creating one drum loop. Layer 3 snares. EQ the kick. Get it perfect. Do not add melodies. Save it as a template.' },
          { id: 18, title: 'The "Rick Rubin" Mute', artist: 'Rubin', text: 'Open an old project that feels "cluttered." Mute 50% of the tracks. Hit play. Does the song still work? If yes, delete the muted tracks.' },
          { id: 19, title: 'The "Max Martin" Melody', artist: 'Max Martin', text: 'Write a melody using a synth lead. Record it. Now write lyrics that match the rhythm perfectly. If the syllable count is off, change the lyric.' },
          { id: 20, title: 'The "Foley" Hunt', artist: 'Finneas', text: 'Walk around your house with your phone/recorder. Record 10 sounds (door slam, blender, footsteps). Put them in your DAW. Create a beat using only these sounds.' },
          { id: 21, title: 'The "Mono" Mix', artist: 'Serban', text: 'Put a plugin on your master bus that forces the output to Mono. Mix the entire song in mono. If you can make everything heard clearly without panning, your mix is perfect.' },
          { id: 22, title: 'The "Timer" Limit', artist: 'Kenny Beats', text: 'Set a timer for 30 minutes. You must arrange the entire song structure (Intro, Verse, Chorus, Bridge, Outro) using placeholder clips. Do not tweak a single sound until the structure is done.' },
          { id: 23, title: 'The "Reference" Match', artist: 'Engineering', text: 'Import a professional song you love into your session. Turn its volume down to match your track. A/B test them. Is your snare as bright? Is your bass as loud? Adjust your EQ to match.' },
          { id: 24, title: 'The "Resample" Day', artist: 'Skrillex', text: 'Spend 30 minutes tweaking a synth and recording the audio. Then spend 30 minutes chopping that audio into a new drum kit or bass patch.' },
          { id: 25, title: 'The "Hans Zimmer" Loop', artist: 'Zimmer', text: 'Create a 4-bar loop that keeps building tension but never drops. Use rising pitch (Shepard Tone) or increasing velocity on strings.' },
          { id: 26, title: 'The "Mutt Lange" Stack', artist: 'Mutt Lange', text: 'Record a chorus. Record 8 layers of backing vocals (High L/R, Low L/R, Unison L/R, Whisper L/R). Mix them until they sound like a synth pad.' },
          { id: 27, title: 'The "10-Minute" Beat', artist: 'Kenny Beats', text: 'Set a timer. Finish a beat arrangement in 10 minutes. If the timer goes off, you must stop. Render it. Move on.' },
          { id: 28, title: 'The "Phase" Police', artist: 'Mastering', text: 'Open an old mix. Put a "Utility" plugin on the master and set width to 0% (Mono). Listen to the whole song. Fix every element that disappears or sounds weak.' },
          { id: 29, title: 'The "Found Sound" Kit', artist: 'Göransson', text: 'Record 3 sounds in your kitchen. Use only those 3 sounds to make a rhythm track. (e.g., Pot Lid = Gong, Coffee Grinder = Bass texture).' }
        ];

        // --- STATE & UTILS ---
        let appState = {
            view: 'home', // 'home', 'musician', 'challenge', 'practice', 'myshed', 'jam', 'studio'
            mode: 'musician', // 'musician' or 'producer'
            studioModule: 'jamstation', // 'jamstation', 'tuner', 'looper', 'visualizer'
            jamViewMode: 'guitar', // 'guitar', 'piano'
            scaleDisplayMode: 'sidebar',
            data: null, 
            theme: 'light',
            menuOpen: false,
            savedLessons: JSON.parse(localStorage.getItem('theshed_saved') || '[]'),
            savedSparks: JSON.parse(localStorage.getItem('theshed_sparks') || '[]'),
            timer: null,
            timeLeft: 0,
            timerActive: false,
            isRoutineActive: false,
            routineIndex: 0
        };

        const app = document.getElementById('app');

        function toggleMode() {
            appState.mode = appState.mode === 'musician' ? 'producer' : 'musician';
            // If viewing a musician, maybe go home to avoid confusion? or stay if id exists?
            // Safer to go home or just re-render and let user navigate.
            // If the current view is 'musician' and the musician is not in the new mode, go home.
            if (appState.view === 'musician') {
                const currentId = appState.data ? appState.data.id : null;
                const relevantList = appState.mode === 'musician' ? VOLUMES : PRODUCER_VOLUMES;
                const exists = relevantList.flatMap(v => v.musicians).some(m => m.id === currentId);
                if (!exists) setView('home');
            } else if (appState.view === 'challenge') {
                // Restart spin with new list
                startSpin(); 
            }
            render();
        }

        function getCurrentChallenges() {
            const staticList = appState.mode === 'musician' ? MUSICIAN_CHALLENGES : PRODUCER_CHALLENGES;
            const relevantVolumes = appState.mode === 'musician' ? VOLUMES : PRODUCER_VOLUMES;
            
            // Extract challenges from artist objects
            const dynamicList = relevantVolumes.flatMap(vol => 
                vol.musicians
                    .filter(m => m.artistChallenge)
                    .map(m => ({
                        id: `ART-${m.id}`,
                        title: m.artistChallenge.title,
                        artist: m.name,
                        text: m.artistChallenge.description
                    }))
            );

            // Combine and remove duplicates based on title
            const combined = [...staticList, ...dynamicList];
            const unique = combined.filter((v, i, a) => a.findIndex(t => t.title === v.title) === i);
            
            return unique;
        }

        function toggleTheme() {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.className = appState.theme;
            render();
            renderToolbar();
        }

        function toggleMenu() {
            appState.menuOpen = !appState.menuOpen;
            render();
        }

        function toggleSaveLesson(lesson) {
            const idx = appState.savedLessons.findIndex(l => l.id === lesson.id);
            if (idx > -1) {
                appState.savedLessons.splice(idx, 1);
            } else {
                appState.savedLessons.push(lesson);
            }
            localStorage.setItem('theshed_saved', JSON.stringify(appState.savedLessons));
            render(); 
        }

        function isSaved(lessonId) {
            return appState.savedLessons.some(l => l.id === lessonId);
        }

        function setView(view, data = null) {
            // Stop things if changing view
            if (appState.view === 'practice' && view !== 'practice') stopTimer();
            if (appState.view === 'jam' && view !== 'jam') audio.stopBackingTrack();
            
            appState.view = view;
            appState.data = data;
            appState.menuOpen = false;
            window.scrollTo(0,0);
            render();
            renderToolbar();
        }

        function getAllMusicians() {
            const musicians = VOLUMES.flatMap(v => v.musicians);
            const producers = PRODUCER_VOLUMES.flatMap(v => v.musicians);
            return [...musicians, ...producers];
        }

        function getNeighborMusician(currentId, direction) {
            const all = getAllMusicians();
            const idx = all.findIndex(m => m.id === currentId);
            if (idx === -1) return null;
            if (direction === 'next') return all[idx + 1] || null;
            if (direction === 'prev') return all[idx - 1] || null;
        }

        function renderJamInstrument(chordNotes, mode) {
             const notesToHighlight = chordNotes.map(n => {
                 // Handle both 'C3' and 'C' formats
                 return /[\d]$/.test(n) ? n.slice(0, -1) : n;
             });
             const rootNote = notesToHighlight[0];

             if (mode === 'guitar') {
                 const renderString = (startNote) => {
                     const startIdx = NOTES.indexOf(startNote);
                     const openNote = NOTES[startIdx];
                     const isOpenHighlight = notesToHighlight.includes(openNote);
                     const isOpenRoot = openNote === rootNote;

                     let html = `<div class="flex border-b border-stone-700/50 last:border-0 relative">
                        <!-- Open Note Area (Left of Nut) -->
                        <div class="w-10 bg-stone-900 flex items-center justify-center relative z-20 shrink-0">
                            ${isOpenHighlight ? `<div class="z-10 w-5 h-5 rounded-full flex items-center justify-center text-[8px] font-bold shadow-sm ${isOpenRoot ? 'bg-orange-500 text-white scale-125' : 'bg-stone-200 text-stone-900'}">${openNote}</div>` : `<span class="text-[10px] text-stone-500 font-bold">${startNote}</span>`}
                        </div>
                        <!-- The Nut -->
                        <div class="w-2 border-r-4 border-stone-500 bg-stone-700 z-20 shrink-0"></div>`;
                     
                     // Loop through actual frets (1-12)
                     for (let i = 1; i < 13; i++) {
                         const currentNote = NOTES[(startIdx + i) % 12];
                         const isHighlight = notesToHighlight.includes(currentNote);
                         const isRoot = currentNote === rootNote;
                         html += `
                             <div class="flex-1 border-r border-stone-600 relative h-7 flex items-center justify-center">
                                 <div class="absolute w-full h-[1px] bg-stone-500 z-0 top-1/2"></div>
                                 ${isHighlight ? `<div class="z-10 w-5 h-5 rounded-full flex items-center justify-center text-[8px] font-bold shadow-sm ${isRoot ? 'bg-orange-500 text-white scale-125' : 'bg-stone-200 text-stone-900'}">${currentNote}</div>` : ''}
                             </div>`;
                     }
                     html += `</div>`;
                     return html;
                 };
                 return `
                     <div class="w-full bg-stone-900 border border-stone-700 rounded-lg p-2 overflow-x-auto shadow-inner">
                          <div class="min-w-[300px] flex flex-col">
                             ${['E','B','G','D','A','E'].map(n => renderString(n)).join('')}
                          </div>
                     </div>`;
             } else {
                 // Piano
                 const startOctave = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                 const fullRange = [...startOctave, ...startOctave.slice(0, 5)];
                 let html = `<div class="w-full bg-stone-900 border border-stone-700 rounded-lg p-4 overflow-x-auto shadow-inner flex justify-center"><div class="flex relative h-32 pt-2 select-none">`;
                 fullRange.forEach((note, idx) => {
                      const isBlack = note.includes('#');
                      const isHighlight = notesToHighlight.includes(note);
                      const isRoot = note === rootNote;
                      const nextIsBlack = fullRange[idx + 1] && fullRange[idx + 1].includes('#');
                      if (isBlack) return;
                      html += `
                         <div class="relative group shrink-0">
                             <div class="w-8 h-28 border border-stone-400 rounded-b-sm flex flex-col justify-end items-center pb-1 ${isHighlight ? (isRoot ? 'bg-orange-200' : 'bg-stone-100') : 'bg-stone-300'}">
                                 ${isHighlight ? `<span class="text-[8px] font-bold text-stone-900">${note}</span>` : ''}
                             </div>
                             ${nextIsBlack ? `<div class="absolute top-0 -right-2 w-5 h-16 z-10 rounded-b-sm border border-stone-800 ${notesToHighlight.includes(fullRange[idx+1]) ? (fullRange[idx+1] === rootNote ? 'bg-orange-600' : 'bg-stone-600') : 'bg-stone-900'}"></div>` : ''}
                         </div>`;
                 });
                 html += `</div></div>`;
                 return html;
             }
        }

        function updateJamVisualizer(chord, idx) {
             const viz = document.getElementById('jam-visualizer');
             const instContainer = document.getElementById('jam-instrument-display');
             
             if(viz) {
                 viz.innerHTML = `
                    <div class="text-center animate-fade-in">
                        <div class="text-sm font-bold uppercase tracking-widest text-orange-500 mb-2">Current Chord</div>
                        <div class="text-6xl font-black font-serif text-white mb-2">${chord.name}</div>
                        <div class="text-xl text-stone-400 italic font-serif">${chord.theory}</div>
                    </div>
                 `;
             }

             if(instContainer) {
                instContainer.innerHTML = renderJamInstrument(chord.notes, appState.jamViewMode);
             }
             
             // Update Chord List Highlighting
             const listItems = document.querySelectorAll('.progression-item');
             listItems.forEach((item, i) => {
                 if (i === idx) {
                     item.classList.add('bg-orange-600', 'text-white', 'border-orange-500', 'scale-105', 'shadow-lg');
                     item.classList.remove('bg-stone-800', 'text-stone-400', 'border-stone-700');
                     item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                 } else {
                     item.classList.remove('bg-orange-600', 'text-white', 'border-orange-500', 'scale-105', 'shadow-lg');
                     item.classList.add('bg-stone-800', 'text-stone-400', 'border-stone-700');
                 }
             });
        }

        // --- RENDER FUNCTIONS ---
        function Icon(name, classes="") {
            return `<i class="ph ph-${name} ${classes}"></i>`;
        }

        function renderHeader() {
            const isDark = appState.theme === 'dark';
            return `
                <header class="fixed top-0 left-0 right-0 z-50 bg-white/95 dark:bg-stone-900/95 backdrop-blur border-b border-stone-200 dark:border-stone-800 h-16 flex items-center justify-between px-4 transition-colors duration-300">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMenu()" class="p-2 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-full transition-colors text-stone-800 dark:text-stone-100">
                            ${Icon('list', 'text-2xl')}
                        </button>
                        <div onclick="setView('home')" class="cursor-pointer flex items-center gap-2">
                            <div class="bg-orange-600 text-white p-1 rounded font-bold text-xs tracking-tighter">TS</div>
                            <h1 class="text-xl font-serif font-black tracking-tighter text-stone-900 dark:text-white">THE SHED</h1>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="audio.toggleGlobalRecording()" class="flex items-center gap-2 px-3 py-1.5 ${audio.isGlobalRecording ? 'bg-red-600 text-white animate-pulse' : 'bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-300'} rounded-full text-sm font-bold uppercase tracking-widest hover:opacity-90 transition-all">
                            ${Icon('record', 'text-lg')}
                            <span class="hidden lg:inline">${audio.isGlobalRecording ? 'Recording...' : 'Global Rec'}</span>
                        </button>
                        <button onclick="toggleMode()" class="hidden md:flex items-center gap-2 px-3 py-1.5 ${appState.mode === 'musician' ? 'bg-orange-600 text-white' : 'bg-cyan-600 text-white'} rounded-full text-sm font-bold uppercase tracking-widest hover:opacity-90 transition-all shadow-lg">
                            ${appState.mode === 'musician' ? Icon('guitar', 'text-lg') : Icon('faders', 'text-lg')}
                            <span>${appState.mode === 'musician' ? 'Musician Mode' : 'Producer Mode'}</span>
                        </button>
                        <button onclick="setView('studio')" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-stone-900 dark:bg-white text-white dark:text-stone-900 rounded-full text-sm font-bold uppercase tracking-widest hover:bg-cyan-500 hover:text-stone-900 transition-all shadow-lg">
                            ${Icon('activity', 'text-lg')}
                            <span>Studio</span>
                        </button>
                         <button onclick="setView('jam')" class="flex items-center gap-2 px-3 py-1.5 bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-300 rounded-full text-sm font-medium hover:bg-orange-100 dark:hover:bg-orange-900/30 hover:text-orange-600 transition-all">
                            ${Icon('music-notes', 'text-lg')}
                            <span class="hidden md:inline">Jam Station</span>
                        </button>
                        <button onclick="setView('myshed')" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-300 rounded-full text-sm font-medium hover:bg-orange-100 dark:hover:bg-orange-900/30 hover:text-orange-600 transition-all">
                            ${Icon('star', 'text-lg')}
                            <span>My Shed</span>
                        </button>
                        <button onclick="toggleTheme()" class="p-2 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-full transition-colors text-stone-600 dark:text-stone-400">
                            ${isDark ? Icon('sun', 'text-xl') : Icon('moon', 'text-xl')}
                        </button>
                    </div>
                </header>
            `;
        }

        // --- TOOLBAR (METRONOME/DRONE) ---
        function renderToolbar() {
            const toolbar = document.getElementById('toolbar-container');
            if (!toolbar) return; // Should be in DOM

            // Don't show toolbar in Jam Station to avoid clutter/conflicts
            if (appState.view === 'jam') {
                 toolbar.innerHTML = `
                    <div class="max-w-4xl mx-auto px-4 h-full flex items-center justify-between text-stone-500 text-xs font-mono uppercase tracking-widest">
                        <span>Jam Station Active</span>
                        <button onclick="setView('home')" class="hover:text-white">Exit Jam</button>
                    </div>
                 `;
                 return;
            }

            const isMetronomeActive = audio.isPlayingMetronome;
            const isDroneActive = audio.isPlayingDrone;
            
            toolbar.innerHTML = `
                <div class="max-w-4xl mx-auto px-4 h-full flex items-center justify-between gap-4">
                    
                    <!-- Metronome Control -->
                    <div class="flex items-center gap-4 flex-1">
                        <button onclick="audio.toggleMetronome()" class="flex flex-col items-center gap-1 ${isMetronomeActive ? 'text-orange-500' : 'text-stone-400'}">
                            ${Icon('metronome', 'text-2xl')}
                            <span class="text-[10px] font-bold uppercase tracking-wide">BPM</span>
                        </button>
                        <div class="flex items-center gap-2 bg-stone-800 rounded-lg p-1.5">
                            <button onclick="audio.setTempo(audio.tempo - 5)" class="text-stone-400 hover:text-white px-2">-</button>
                            <span class="w-8 text-center font-mono font-bold text-white text-sm">${audio.tempo}</span>
                            <button onclick="audio.setTempo(audio.tempo + 5)" class="text-stone-400 hover:text-white px-2">+</button>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-stone-800"></div>

                    <!-- Drone Control -->
                    <div class="flex items-center gap-4 justify-end flex-1">
                         <div class="flex items-center gap-1 bg-stone-800 rounded-lg p-1">
                            ${['E2','A2','D2','G2'].map(note => `
                                <button onclick="audio.toggleDrone('${note}')" 
                                    class="w-8 h-8 rounded text-xs font-bold font-mono transition-colors ${isDroneActive && audio.droneNote === note ? 'bg-orange-600 text-white' : 'text-stone-400 hover:text-white'}">
                                    ${note.charAt(0)}
                                </button>
                            `).join('')}
                         </div>
                         <button onclick="audio.isPlayingDrone ? audio.stopDrone() : audio.startDrone()" class="flex flex-col items-center gap-1 ${isDroneActive ? 'text-orange-500' : 'text-stone-400'}">
                            ${Icon('wave-sine', 'text-2xl')}
                            <span class="text-[10px] font-bold uppercase tracking-wide">Drone</span>
                        </button>
                    </div>

                </div>
            `;
        }

        // --- JAM STATION VIEW ---
        function renderScaleRecommendationPanel() {
            const activeTrack = audio.activeTrack;

            if (!activeTrack) {
                return `
                    <div class="bg-stone-900 rounded-xl p-6 border border-stone-700">
                        <h3 class="text-sm font-bold text-stone-400 uppercase mb-4">Recommended Scales</h3>
                        <p class="text-stone-500 text-xs mb-4">Select a backing track to see scale recommendations</p>
                        <div class="mt-4 p-3 bg-stone-800 rounded-lg">
                            <div class="text-xs text-stone-400 mb-1">Current Scale:</div>
                            <div class="text-cyan-400 font-bold">${studio.rootKey} ${studio.scaleType.replace('_', ' ')}</div>
                        </div>
                    </div>
                `;
            }

            const currentChord = activeTrack.progression[audio.currentChordIndex];
            const overallScales = activeTrack.overallScales || [];

            return `
                <div class="bg-stone-900 rounded-xl p-6 border border-stone-700 h-full flex flex-col">
                    <h3 class="text-sm font-bold text-stone-400 uppercase mb-4">Scale Recommendations</h3>

                    <!-- Current Chord -->
                    <div class="mb-6 p-4 bg-stone-800 rounded-lg border-l-4 border-cyan-500">
                        <div class="text-xs text-stone-400 mb-1">Current Chord:</div>
                        <div class="text-white font-bold text-lg">${currentChord.name}</div>
                        <div class="text-xs text-stone-500 italic mt-1">${currentChord.theory}</div>
                    </div>

                    <!-- Per-Chord Scales -->
                    ${currentChord.recommendedScales && currentChord.recommendedScales.length > 0 ? `
                        <div class="mb-6">
                            <div class="text-xs font-bold text-stone-400 uppercase mb-2">For This Chord:</div>
                            <div class="space-y-2">
                                ${currentChord.recommendedScales.map((scale, idx) => `
                                    <button
                                        onclick="studio.rootKey = '${scale.root}'; studio.scaleType = '${scale.type}'; render()"
                                        class="w-full text-left p-3 rounded-lg transition-all ${
                                            studio.rootKey === scale.root && studio.scaleType === scale.type
                                                ? 'bg-cyan-500/20 border border-cyan-500 text-cyan-300'
                                                : 'bg-stone-800 hover:bg-stone-700 text-stone-300 border border-transparent'
                                        }">
                                        <div class="font-bold text-sm">${scale.root} ${scale.type.replace('_', ' ')}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Overall Song Scales -->
                    ${overallScales.length > 0 ? `
                        <div class="flex-1">
                            <div class="text-xs font-bold text-stone-400 uppercase mb-2">Entire Progression:</div>
                            <div class="space-y-2">
                                ${overallScales.map((scale, idx) => `
                                    <button
                                        onclick="studio.rootKey = '${scale.root}'; studio.scaleType = '${scale.type}'; render()"
                                        class="w-full text-left p-3 rounded-lg transition-all ${
                                            studio.rootKey === scale.root && studio.scaleType === scale.type
                                                ? 'bg-green-500/20 border border-green-500 text-green-300'
                                                : 'bg-stone-800 hover:bg-stone-700 text-stone-300 border border-transparent'
                                        }">
                                        <div class="font-bold text-xs leading-relaxed">${scale.label}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Chord Progression Timeline -->
                    <div class="mt-6 pt-4 border-t border-stone-700">
                        <div class="text-xs font-bold text-stone-400 uppercase mb-2">Progression:</div>
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            ${activeTrack.progression.map((chord, idx) => `
                                <div class="flex-shrink-0 px-3 py-2 rounded text-xs font-bold transition-all ${
                                    idx === audio.currentChordIndex
                                        ? 'bg-cyan-500 text-white shadow-lg'
                                        : 'bg-stone-800 text-stone-400'
                                }">
                                    ${chord.name.split(' ')[0]}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderJamStation() {
            const active = audio.activeTrack;

            return `
               <div class="min-h-screen bg-stone-900 text-white flex flex-col pt-20 pb-32">
                   <div class="max-w-6xl mx-auto w-full px-6 flex-1 flex flex-col">
        
                       <div class="text-center mb-10">
                           <h2 class="text-orange-500 text-xs font-bold uppercase tracking-[0.2em] mb-2">The Jam Station</h2>
                           <h1 class="text-4xl md:text-5xl font-serif font-black mb-4">Backing Tracks</h1>
                           <p class="text-stone-400 max-w-lg mx-auto mb-8">Select a style. Play the changes. Each track features a generated chord progression to help you practice soloing and rhythm.</p>
                           
                           <div class="flex justify-center">
                                <button onclick="studio.generateAndPlaySpark()" class="group flex items-center gap-3 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white px-8 py-3 rounded-full font-black uppercase tracking-widest shadow-xl transition-all active:scale-95">
                                    <span class="text-lg">${Icon('lightning-fill', 'group-hover:animate-pulse')}</span>
                                    <span>Creative Spark Mode</span>
                                </button>
                           </div>
                       </div>

                       <!-- Main Grid: Mixer + Scale Panel -->
                       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
                           <!-- Left: Mixer Section (2 cols on desktop) -->
                           <div class="lg:col-span-2 flex flex-col gap-6">
        
                               <!-- Controls Area (only show when track is active) -->
                               ${active ? `
                                   <div class="bg-stone-800 border border-stone-700 rounded-xl p-6">
                                       <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 border-b border-stone-700 pb-6">
                                            <div>
                                                <h3 class="text-xs font-bold uppercase text-orange-500 tracking-widest mb-1">Playing ${active.isSpark ? 'Creative Spark' : 'Backing Track'}</h3>
                                                <h2 class="text-2xl font-black font-serif text-white">${active.title}</h2>
                                                ${active.isSpark ? `<p class="text-xs text-stone-400 mt-1 font-mono">${active.sparkData.progression.pattern}</p>` : ''}
                                            </div>
                                            <div class="flex gap-2">
                                                ${active.isSpark ? `
                                                    <button onclick="studio.saveCurrentSpark()" class="flex items-center gap-2 px-4 py-2 bg-stone-900 border border-stone-700 hover:border-orange-500/50 text-stone-300 rounded-lg text-xs font-bold uppercase transition-all">
                                                        ${Icon('star', 'text-orange-500')} Save to Shed
                                                    </button>
                                                ` : ''}
                                                <button onclick="audio.stopBackingTrack()" class="px-4 py-2 bg-stone-700 hover:bg-stone-600 rounded-lg font-bold text-xs transition-colors uppercase tracking-widest border border-stone-600">Stop</button>
                                            </div>
                                       </div>

                                       <div class="flex flex-wrap items-end justify-between gap-6 mb-6">
                                           <div class="flex items-center gap-6">
                                               <div class="flex flex-col">
                                                   <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Tempo</label>
                                                   <div class="flex items-center gap-2">
                                                       <span class="font-mono text-orange-500 w-8 text-right font-bold">${audio.tempo}</span>
                                                       <input type="range" min="40" max="220" value="${audio.tempo}" 
                                                           oninput="audio.setTempo(this.value)" 
                                                           class="w-32 accent-orange-500 h-1 bg-stone-700 rounded-lg appearance-none"/>
                                                   </div>
                                               </div>
                                               <div class="h-8 w-px bg-stone-700 hidden md:block"></div>
                                               <div class="flex flex-col">
                                                   <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Instrument</label>
                                                   <select onchange="audio.setInstrument(this.value)" class="bg-stone-900 text-white text-sm font-bold rounded p-1.5 border border-stone-700 outline-none focus:border-orange-500 transition-colors">
                                                       <option value="triangle" ${audio.instrument === 'triangle' ? 'selected' : ''}>Synth (Triangle)</option>
                                                       <option value="sine" ${audio.instrument === 'sine' ? 'selected' : ''}>Soft (Sine)</option>
                                                       <option value="sawtooth" ${audio.instrument === 'sawtooth' ? 'selected' : ''}>Lead (Saw)</option>
                                                       <option value="square" ${audio.instrument === 'square' ? 'selected' : ''}>Retro (Square)</option>
                                                   </select>
                                               </div>
                                           </div>
                                       </div>
        
                                       <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                           <div class="flex flex-col">
                                               <div class="flex justify-between mb-1">
                                                   <label class="text-[10px] font-bold uppercase text-stone-500">Reverb</label>
                                                   <span class="text-[10px] font-mono text-orange-500">${(audio.reverbAmount * 100).toFixed(0)}%</span>
                                               </div>
                                               <input type="range" min="0" max="1" step="0.01" value="${audio.reverbAmount}" 
                                                   oninput="audio.setReverb(this.value); this.previousElementSibling.lastElementChild.innerText = (this.value * 100).toFixed(0) + '%'" 
                                                   class="w-full accent-orange-500 h-1 bg-stone-700 rounded-lg appearance-none"/>
                                           </div>
                                           <div class="flex flex-col">
                                               <div class="flex justify-between mb-1">
                                                   <label class="text-[10px] font-bold uppercase text-stone-500">Strum Speed</label>
                                                   <span class="text-[10px] font-mono text-orange-500">${(audio.strumSpeed * 1000).toFixed(0)}ms</span>
                                               </div>
                                               <input type="range" min="0" max="0.2" step="0.005" value="${audio.strumSpeed}" 
                                                   oninput="audio.setStrum(this.value); this.previousElementSibling.lastElementChild.innerText = (this.value * 1000).toFixed(0) + 'ms'" 
                                                   class="w-full accent-orange-500 h-1 bg-stone-700 rounded-lg appearance-none"/>
                                           </div>
                                           <div class="flex flex-col">
                                               <div class="flex justify-between mb-1">
                                                   <label class="text-[10px] font-bold uppercase text-stone-500">Brightness</label>
                                                   <span class="text-[10px] font-mono text-orange-500">${(audio.brightness / 1000).toFixed(1)}k</span>
                                               </div>
                                               <input type="range" min="500" max="10000" step="100" value="${audio.brightness}" 
                                                   oninput="audio.setBrightness(this.value); this.previousElementSibling.lastElementChild.innerText = (this.value / 1000).toFixed(1) + 'k'" 
                                                   class="w-full accent-orange-500 h-1 bg-stone-700 rounded-lg appearance-none"/>
                                           </div>
                                       </div>
                                   </div>
                               ` : ''}

                               <!-- Visualizer Area -->
                               <div class="grid md:grid-cols-2 gap-6">
                                    <!-- Chord Info -->
                                   <div class="bg-black/50 border-2 border-stone-800 rounded-2xl p-8 h-64 flex items-center justify-center relative overflow-hidden shadow-inner">
                                       ${active ? `
                                           <div id="jam-visualizer" class="w-full h-full flex items-center justify-center">
                                               ${(() => {
                                                   const chord = active.progression[audio.currentChordIndex];
                                                   return `
                                                        <div class="text-center animate-fade-in">
                                                            <div class="text-sm font-bold uppercase tracking-widest text-orange-500 mb-2">Current Chord</div>
                                                            <div class="text-6xl font-black font-serif text-white mb-2">${chord.name}</div>
                                                            <div class="text-xl text-stone-400 italic font-serif">${chord.theory}</div>
                                                        </div>
                                                   `;
                                               })()}
                                           </div>
                                           <div class="absolute bottom-4 right-4 flex items-center gap-2">
                                                <span class="text-xs font-bold uppercase text-stone-500">BPM</span>
                                                <span class="text-xl font-mono font-bold text-white">${audio.tempo}</span>
                                           </div>
                                       ` : `
                                           <div class="text-stone-600 font-bold uppercase tracking-widest flex flex-col items-center gap-2">
                                               ${Icon('music-notes', 'text-4xl')}
                                               Select a Track
                                           </div>
                                       `}
                                   </div>

                                   <!-- Instrument View (existing Live View section) -->
                                   <div class="bg-stone-800 border border-stone-700 rounded-2xl p-4 h-64 flex flex-col relative overflow-hidden shadow-inner">
                                       <div class="flex justify-between items-center mb-4">
                                            <div class="flex items-center gap-3">
                                                <h3 class="text-xs font-bold uppercase text-stone-500">Live View</h3>
                                                ${active ? `
                                                    <button onclick="audio.toggleScalePause()" class="px-2 py-1 rounded text-[10px] font-bold uppercase transition-all ${audio.isScaleDisplayPaused ? 'bg-orange-600 text-white' : 'bg-stone-700 text-stone-400 hover:text-white'}">
                                                        ${audio.isScaleDisplayPaused ? Icon('play', 'mr-1') + 'Resume Visuals' : Icon('pause', 'mr-1') + 'Pause Visuals'}
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div class="bg-stone-900 p-1 rounded-lg flex gap-1">
                                               <button onclick="appState.jamViewMode = 'guitar'; render()" class="p-1.5 rounded transition-all ${appState.jamViewMode === 'guitar' ? 'bg-stone-700 text-orange-400' : 'text-stone-500'}">
                                                   ${Icon('guitar', 'text-sm')}
                                               </button>
                                               <button onclick="appState.jamViewMode = 'piano'; render()" class="p-1.5 rounded transition-all ${appState.jamViewMode === 'piano' ? 'bg-stone-700 text-orange-400' : 'text-stone-500'}">
                                                   ${Icon('piano-keys', 'text-sm')}
                                               </button>
                                           </div>
                                       </div>
                                       <div id="jam-instrument-display" class="flex-1 flex items-center justify-center text-stone-600 text-xs overflow-hidden">
                                           ${active ? (
                                               audio.isScaleDisplayPaused 
                                               ? renderJamInstrument(studio.getScaleNotes(), appState.jamViewMode)
                                               : renderJamInstrument(active.progression[audio.currentChordIndex].notes, appState.jamViewMode)
                                           ) : '<div class="text-stone-600 text-sm">Select a track</div>'}
                                       </div>
                                   </div>
                               </div>

                               <!-- Mobile-only: Toggle for Scale Display -->
                               <div class="lg:hidden bg-stone-900 rounded-xl p-3 border border-stone-700">
                                   <button
                                       onclick="appState.scaleDisplayMode = appState.scaleDisplayMode === 'sidebar' ? 'hidden' : 'sidebar'; render()"
                                       class="w-full bg-cyan-500 hover:bg-cyan-400 text-white px-4 py-2 rounded font-bold transition-colors">
                                       ${appState.scaleDisplayMode === 'hidden' ? 'Show' : 'Hide'} Scale Recommendations
                                   </button>
                               </div>
                           </div>

                           <!-- Right: Scale Recommendations (1 column, hidden on mobile by default) -->
                           <div class="${appState.scaleDisplayMode === 'hidden' ? 'hidden lg:block' : ''}">
                               ${renderScaleRecommendationPanel()}
                           </div>
                       </div>

                       <!-- Track Selection Cards (existing code continues...) -->
                       <div class="grid md:grid-cols-2 gap-6">
                            <!-- Special Spark Card -->
                            <button onclick="studio.generateAndPlaySpark()" 
                                class="text-left p-6 rounded-xl border-2 border-dashed border-orange-500/30 bg-orange-500/5 hover:bg-orange-500/10 transition-all group relative overflow-hidden">
                                <div class="absolute -top-4 -right-4 text-orange-500/10 group-hover:scale-110 transition-transform">${Icon('lightning', 'text-9xl')}</div>
                                <div class="relative z-10">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold uppercase tracking-wider text-orange-500">New Idea</span>
                                        ${Icon('sparkle', 'text-orange-500 animate-spin-slow')}
                                    </div>
                                    <h3 class="text-xl font-bold font-serif mb-1 text-white">Generate Spark</h3>
                                    <p class="text-sm text-stone-400">Feeling stuck? Let the Shed generate a random progression and a mood for you to jam with.</p>
                                </div>
                            </button>

                           ${BACKING_TRACKS.map(track => {
                                const isActive = active && active.id === track.id;
                                return `
                                    <button onclick="audio.playBackingTrack(BACKING_TRACKS.find(t => t.id === '${track.id}'))" 
                                        class="text-left p-6 rounded-xl border transition-all duration-300 group
                                        ${isActive ? 'bg-orange-600 border-orange-500 shadow-lg scale-[1.02]' : 'bg-stone-800 border-stone-700 hover:border-orange-500/50 hover:bg-stone-800/80'}">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="text-xs font-bold uppercase tracking-wider ${isActive ? 'text-white/80' : 'text-stone-400 group-hover:text-orange-500'}">${track.genre}</span>
                                            ${isActive ? Icon('speaker-high', 'text-white animate-pulse') : ''}
                                        </div>
                                        <h3 class="text-xl font-bold font-serif mb-1 ${isActive ? 'text-white' : 'text-stone-200'}">${track.title}</h3>
                                        <p class="text-sm ${isActive ? 'text-white/90' : 'text-stone-400'} line-clamp-2">${track.description}</p>
                                    </button>
                                `;
                            }).join('')}
                       </div>

                       ${appState.savedSparks.length > 0 ? `
                           <div class="mt-12">
                                <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-stone-500 mb-6 flex items-center gap-2">
                                    ${Icon('star-fill', 'text-orange-500')} Saved Ideas
                                </h3>
                                <div class="grid md:grid-cols-3 gap-4">
                                    ${appState.savedSparks.map(spark => `
                                        <div class="bg-stone-800/50 border border-stone-700 rounded-xl p-4 flex flex-col justify-between group">
                                            <div class="mb-4">
                                                <div class="flex justify-between items-start">
                                                    <h4 class="font-bold text-white leading-tight">${spark.title}</h4>
                                                    <button onclick="studio.deleteSpark('${spark.id}')" class="text-stone-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                                        ${Icon('trash', 'text-sm')}
                                                    </button>
                                                </div>
                                                <p class="text-[10px] text-stone-500 uppercase mt-1">${spark.sparkData.progression.pattern}</p>
                                            </div>
                                            <button onclick="audio.playBackingTrack(appState.savedSparks.find(s => s.id === '${spark.id}'))" class="w-full py-2 bg-stone-700 hover:bg-orange-600 text-white rounded text-[10px] font-bold uppercase tracking-widest transition-colors">
                                                Load Idea
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                           </div>
                       ` : ''}

                       <div class="mt-12 flex justify-center">
                             <button onclick="audio.stopBackingTrack()" 
                                class="px-8 py-4 rounded-xl border-2 border-stone-700 text-stone-400 hover:text-white hover:border-stone-500 font-bold uppercase tracking-widest text-sm transition-colors ${!active ? 'opacity-50 cursor-not-allowed' : ''}" ${!active ? 'disabled' : ''}>
                                Stop All Playback
                            </button>
                       </div>

                   </div>
               </div>
            `;
        }

        // --- PRACTICE TIMER LOGIC ---
        function startRoutine() {
            if (appState.savedLessons.length === 0) {
                alert("Add some lessons to your Shed first!");
                return;
            }
            appState.isRoutineActive = true;
            appState.routineIndex = 0;
            setView('practice', appState.savedLessons[0]);
            startTimer();
        }

        function nextRoutineStep() {
            appState.routineIndex++;
            if (appState.routineIndex < appState.savedLessons.length) {
                setView('practice', appState.savedLessons[appState.routineIndex]);
                startTimer();
            } else {
                appState.isRoutineActive = false;
                appState.routineIndex = 0;
                alert("Routine Complete! Great work.");
                setView('myshed');
            }
        }

        function startTimer() {
            if (appState.timerActive) {
                stopTimer();
                return;
            }
            appState.timerActive = true;
            // Use existing timeLeft if paused, otherwise start fresh
            if (appState.timeLeft <= 0) {
                appState.timeLeft = (appState.data.duration || 10) * 60; 
            }
            
            render(); 

            appState.timer = setInterval(() => {
                appState.timeLeft--;
                if (appState.timeLeft <= 0) {
                    stopTimer();
                    if (appState.isRoutineActive) {
                        // Play a notification sound? (future improvement)
                        nextRoutineStep();
                    } else {
                        alert("Practice Complete!");
                    }
                }
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(appState.timer);
            appState.timerActive = false;
            render();
        }

        function updateTimerDisplay() {
            const el = document.getElementById('timer-display');
            if (el) {
                const mins = Math.floor(appState.timeLeft / 60);
                const secs = appState.timeLeft % 60;
                el.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        // --- VIEWS ---

        function renderSidebar() {
            const isOpen = appState.menuOpen;
            if (!isOpen) return '';

            return `
                <div class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 transition-opacity duration-300" onclick="toggleMenu()"></div>
                <div class="fixed top-0 left-0 bottom-0 w-80 bg-white dark:bg-stone-950 z-50 shadow-2xl transform transition-transform duration-300 overflow-y-auto no-scrollbar">
                    <div class="p-6 border-b border-stone-100 dark:border-stone-800 flex justify-between items-center">
                        <span class="font-serif font-bold text-2xl text-stone-900 dark:text-white">Contents</span>
                        <button onclick="toggleMenu()" class="p-2 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-full">
                            ${Icon('x', 'text-xl text-stone-500')}
                        </button>
                    </div>
                    <div class="p-6 space-y-8">
                        <button onclick="setView('home')" class="flex items-center gap-3 text-lg font-bold text-orange-600 hover:text-orange-700 w-full text-left">
                            ${Icon('book-open', 'text-xl')}
                            <span>Cover Page</span>
                        </button>
                        <button onclick="setView('studio')" class="flex items-center gap-3 text-lg font-bold text-cyan-600 hover:text-cyan-700 w-full text-left">
                            ${Icon('activity', 'text-xl')}
                            <span>Sonic Studio</span>
                        </button>
                         <button onclick="setView('myshed')" class="flex items-center gap-3 text-lg font-bold text-stone-800 dark:text-stone-200 hover:text-orange-600 w-full text-left">
                            ${Icon('star', 'text-xl')}
                            <span>My Shed</span>
                        </button>
                        <button onclick="setView('jam')" class="flex items-center gap-3 text-lg font-bold text-stone-800 dark:text-stone-200 hover:text-orange-600 w-full text-left">
                            ${Icon('music-notes', 'text-xl')}
                            <span>Jam Station</span>
                        </button>
                        <button onclick="setView('challenge')" class="flex items-center gap-3 text-lg font-bold text-stone-800 dark:text-stone-200 hover:text-orange-600 w-full text-left">
                            ${Icon('lightning', 'text-xl')}
                            <span>Master Workbook</span>
                        </button>

                        ${appState.mode === 'musician' ? `
                            <div class="pt-4 border-t border-stone-200 dark:border-stone-800">
                                <span class="text-xs font-bold uppercase tracking-widest text-stone-400 mb-4 block">The Musician's Shed</span>
                                ${VOLUMES.map(vol => `
                                    <div class="space-y-4 mb-6">
                                        <h3 class="text-xs uppercase tracking-widest font-bold text-stone-400 dark:text-stone-500">${vol.title}</h3>
                                        <div class="space-y-1">
                                            ${vol.musicians.map(m => `
                                                <button onclick="setView('musician', VOLUMES.find(v => v.id === '${vol.id}').musicians.find(mu => mu.id === '${m.id}'))" 
                                                    class="block w-full text-left py-2 px-3 rounded hover:bg-stone-100 dark:hover:bg-stone-900 text-stone-700 dark:text-stone-300 font-medium transition-colors">
                                                    ${m.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="pt-4 border-t border-stone-200 dark:border-stone-800">
                                <span class="text-xs font-bold uppercase tracking-widest text-cyan-500 mb-4 block">The Producer's Shed</span>
                                ${PRODUCER_VOLUMES.map(vol => `
                                    <div class="space-y-4 mb-6">
                                        <h3 class="text-xs uppercase tracking-widest font-bold text-stone-400 dark:text-stone-500">${vol.title}</h3>
                                        <div class="space-y-1">
                                            ${vol.musicians.map(m => `
                                                <button onclick="setView('musician', PRODUCER_VOLUMES.find(v => v.id === '${vol.id}').musicians.find(mu => mu.id === '${m.id}'))" 
                                                    class="block w-full text-left py-2 px-3 rounded hover:bg-stone-100 dark:hover:bg-stone-900 text-stone-700 dark:text-stone-300 font-medium transition-colors">
                                                    ${m.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // --- STUDIO VIEW ---
        function setStudioModule(mod) {
            appState.studioModule = mod;
            render();
        }

        function renderSparkGenerator() {
            const spark = studio.spark;
            return `
                <div class="h-full flex flex-col bg-stone-800 rounded-xl border border-stone-700 p-8 shadow-inner relative overflow-hidden">
                    <div class="absolute top-4 right-4 opacity-10 text-white">${Icon('lightning', 'text-6xl')}</div>
                    
                    <div class="text-center mb-10">
                        <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-cyan-500 mb-2">The Spark Generator</h2>
                        <h1 class="text-3xl font-black font-serif text-white">Instant Song Starters</h1>
                    </div>

                    <div class="grid gap-6 mb-10">
                        ${spark.progression ? `
                            <div class="grid md:grid-cols-3 gap-6 animate-fade-in">
                                <div class="bg-stone-900 rounded-xl p-6 border border-stone-700">
                                    <span class="text-[10px] font-bold uppercase text-stone-500 mb-2 block">Progression</span>
                                    <div class="text-2xl font-black text-cyan-400 mb-1">${spark.progression.pattern}</div>
                                    <p class="text-xs text-stone-500">${spark.progression.name}: ${spark.progression.desc}</p>
                                </div>
                                <div class="bg-stone-900 rounded-xl p-6 border border-stone-700">
                                    <span class="text-[10px] font-bold uppercase text-stone-500 mb-2 block">Vibe / Mood</span>
                                    <div class="text-2xl font-black text-orange-500">${spark.mood}</div>
                                </div>
                                <div class="bg-stone-900 rounded-xl p-6 border border-stone-700">
                                    <span class="text-[10px] font-bold uppercase text-stone-500 mb-2 block">Creative Constraint</span>
                                    <p class="text-lg font-bold text-white leading-tight">${spark.constraint}</p>
                                </div>
                            </div>
                        ` : `
                            <div class="py-20 border-2 border-dashed border-stone-700 rounded-2xl flex flex-col items-center justify-center text-stone-600">
                                ${Icon('magic-wand', 'text-4xl mb-4')}
                                <p class="font-bold uppercase tracking-widest text-sm">Nothing generated yet</p>
                            </div>
                        `}
                    </div>

                    <div class="flex flex-col md:flex-row justify-center gap-4">
                        <button onclick="studio.generateSpark()" class="bg-cyan-600 hover:bg-cyan-500 text-stone-900 px-10 py-4 rounded-full font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all flex items-center gap-3">
                            ${Icon('shuffle', 'text-xl')} ${spark.progression ? 'Generate New Spark' : 'Ignite My Inspiration'}
                        </button>
                        ${spark.progression ? `
                            <button onclick="studio.loadSparkToJam()" class="bg-stone-900 hover:bg-stone-800 border border-cyan-500/50 text-cyan-400 px-10 py-4 rounded-full font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all flex items-center gap-3">
                                ${Icon('faders', 'text-xl')} Open in Jam Mixer
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTuner() {
            // Check if active, if not start it? No, explicit button is better.
            const isActive = studio.tunerActive;
            const pitch = studio.currentPitch;
            const isInTune = Math.abs(pitch.cents) < 5 && pitch.note !== '-';

            return `
                <div class="h-full flex flex-col items-center justify-center relative overflow-hidden bg-stone-800 rounded-xl border border-stone-700 p-8 shadow-inner">
                    <div class="mb-8 relative">
                        <div id="tuner-ring" class="w-40 h-40 rounded-full border-8 flex items-center justify-center transition-colors duration-200 ${isInTune ? 'border-green-500 shadow-[0_0_30px_rgba(34,197,94,0.3)]' : 'border-stone-600'}">
                            <span id="tuner-note" class="text-6xl font-black text-white">${pitch.note}</span>
                        </div>
                        ${isActive ? `<div id="tuner-cents" class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-sm font-mono text-stone-400">${pitch.cents > 0 ? '+' : ''}${pitch.cents} ct</div>` : ''}
                    </div>
                    
                    <div class="w-full max-w-xs h-2 bg-stone-700 rounded-full mb-12 relative overflow-hidden">
                        <div class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white z-10"></div>
                        ${isActive && pitch.note !== '-' ? `
                            <div id="tuner-bar" class="absolute top-0 bottom-0 w-2 rounded-full transition-all duration-100 ${isInTune ? 'bg-green-500' : 'bg-red-500'}" 
                                 style="left: calc(50% + ${pitch.cents}px); transform: translateX(-50%)"></div>
                        ` : ''}
                    </div>
                    
                    <button onclick="${isActive ? 'studio.stopTuner()' : 'studio.startTuner()'}" 
                        class="flex items-center gap-3 px-8 py-4 rounded-full font-bold transition-all ${isActive ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-cyan-600 hover:bg-cyan-500 text-stone-900'}">
                        ${Icon('microphone', 'text-xl')} ${isActive ? 'Stop Mic' : 'Start Tuner'}
                    </button>
                </div>
            `;
        }

        function renderLooper() {
            const isRec = studio.isRecording;
            const loopCount = studio.loopBuffers.length;
            const hasLoop = loopCount > 0;

            return `
                <div class="h-full flex flex-col items-center justify-center bg-stone-800 rounded-xl border border-stone-700 p-8 shadow-inner relative overflow-hidden">
                    <div class="absolute top-4 right-4 opacity-10 text-white">${Icon('repeat', 'text-6xl')}</div>
                    
                    <!-- Progress Bar (Top) -->
                    ${hasLoop || isRec ? `
                        <div class="absolute top-0 left-0 right-0 h-1.5 bg-stone-900">
                            <div id="loop-progress-bar" class="h-full bg-cyan-500 shadow-[0_0_10px_rgba(34,211,238,0.8)] transition-all duration-75" style="width: 0%"></div>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-center gap-8 mb-6 mt-4">
                         <!-- Tape Reels Animation -->
                         <div class="w-24 h-24 md:w-32 md:h-32 rounded-full border-8 border-stone-700 bg-stone-900 flex items-center justify-center relative ${isRec || (hasLoop) ? 'animate-spin' : ''}" style="animation-duration: 3s;">
                            <div class="w-10 h-10 rounded-full bg-stone-800 border-2 border-stone-600"></div>
                            <div class="absolute w-full h-1 bg-transparent border-t-2 border-stone-600 top-1/2 -translate-y-1/2"></div>
                         </div>
                         <div class="w-24 h-24 md:w-32 md:h-32 rounded-full border-8 border-stone-700 bg-stone-900 flex items-center justify-center relative ${isRec || (hasLoop) ? 'animate-spin' : ''}" style="animation-duration: 3s;">
                            <div class="w-10 h-10 rounded-full bg-stone-800 border-2 border-stone-600"></div>
                            <div class="absolute w-full h-1 bg-transparent border-t-2 border-stone-600 top-1/2 -translate-y-1/2"></div>
                         </div>
                    </div>

                    <div class="text-center mb-6">
                        ${hasLoop ? `
                            <div class="text-cyan-400 font-bold uppercase tracking-widest text-xs mb-1">${loopCount} Layer${loopCount > 1 ? 's' : ''} Active</div>
                            <div class="text-stone-500 text-[10px] font-mono">${studio.loopDuration.toFixed(2)}s LOOP</div>
                        ` : `
                            <div class="text-stone-500 font-bold uppercase tracking-widest text-xs">Waiting for first take...</div>
                        `}
                    </div>

                    <!-- Main Controls -->
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        ${!isRec ? `
                            <button onclick="studio.startRecording()" class="bg-red-600 hover:bg-red-500 text-white px-8 py-4 rounded-full flex items-center gap-2 font-bold shadow-lg active:scale-95 transition-all">
                                ${Icon(hasLoop ? 'plus' : 'record', 'text-xl')} ${hasLoop ? 'OVERDUB' : 'START LOOP'}
                            </button>
                        ` : `
                            <button onclick="studio.stopRecording()" class="bg-stone-100 text-stone-900 px-8 py-4 rounded-full flex items-center gap-2 font-bold animate-pulse shadow-lg">
                                ${Icon('stop', 'text-xl')} FINISH
                            </button>
                        `}
                        
                        <div class="flex gap-2">
                            <button onclick="studio.undoLastLayer()" ${!hasLoop ? 'disabled' : ''} class="bg-stone-700 hover:bg-stone-600 text-white p-4 rounded-full font-bold disabled:opacity-30 transition-colors" title="Undo Last Layer">
                                ${Icon('arrow-u-up-left', 'text-xl')}
                            </button>
                            <button onclick="studio.clearLoop()" ${!hasLoop ? 'disabled' : ''} class="bg-stone-900 border border-stone-600 text-stone-300 p-4 rounded-full font-bold disabled:opacity-30 hover:bg-red-900/30 hover:text-red-400 hover:border-red-900 transition-all" title="Clear All">
                                ${Icon('trash', 'text-xl')}
                            </button>
                        </div>
                    </div>

                    <!-- Bottom Mixer & Settings -->
                    <div class="w-full max-w-sm grid grid-cols-2 gap-6 pt-6 border-t border-stone-700/50">
                        <div class="flex flex-col gap-2">
                             <div class="flex justify-between items-center">
                                <label class="text-[10px] font-bold uppercase text-stone-500">Loop Vol</label>
                                <span class="text-[10px] font-mono text-cyan-400">${Math.round(studio.loopVolume * 100)}%</span>
                             </div>
                             <input type="range" min="0" max="1" step="0.01" value="${studio.loopVolume}" 
                                oninput="studio.setLoopVolume(this.value); this.previousElementSibling.lastElementChild.innerText = Math.round(this.value * 100) + '%'" 
                                class="w-full accent-cyan-500 h-1 bg-stone-900 rounded-lg appearance-none cursor-pointer"/>
                        </div>
                        <div class="flex flex-col gap-2">
                             <label class="text-[10px] font-bold uppercase text-stone-500">Monitor</label>
                             <button onclick="studio.toggleMonitoring()" class="flex items-center justify-between px-3 py-1.5 rounded bg-stone-900 border border-stone-700 text-[10px] font-bold uppercase transition-all ${studio.isMonitoring ? 'text-green-400 border-green-900 bg-green-900/10' : 'text-stone-500'}">
                                <span>Input ${studio.isMonitoring ? 'On' : 'Off'}</span>
                                <div class="w-2 h-2 rounded-full ${studio.isMonitoring ? 'bg-green-500 animate-pulse' : 'bg-stone-700'}"></div>
                             </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVisualizer() {
            // Logic for dynamic scale/chord highlighting
            let scaleNotes = [];
            let currentRoot = studio.rootKey;
            
            // Check if we are in 'Chord Mode' and have an active track playing
            const isChordMode = studio.visualizerMode === 'chord';
            const isPlaying = audio.isPlayingTrack && audio.activeTrack;

            if (isChordMode && isPlaying) {
                const currentChord = audio.activeTrack.progression[audio.currentChordIndex];
                if (currentChord && currentChord.recommendedScales && currentChord.recommendedScales.length > 0) {
                    // Use the first recommended scale for the current chord
                    const rec = currentChord.recommendedScales[0];
                    scaleNotes = studio.getScaleNotes(rec.root, rec.type);
                    currentRoot = rec.root; // Highlight the root of the CHORD scale, not the global key
                } else {
                    // Fallback if no data
                    scaleNotes = studio.getScaleNotes();
                }
            } else {
                scaleNotes = studio.getScaleNotes();
            }

            const isNoteInScale = (n) => scaleNotes.includes(n);
            const isRoot = (n) => n === currentRoot;

            // Guitar Render Helper
            const renderString = (startNote, isCommonFn) => {
                const startIdx = NOTES.indexOf(startNote);
                const openNote = NOTES[startIdx];
                const inScaleOpen = isNoteInScale(openNote);
                const rootOpen = isRoot(openNote);
                const commonOpen = isCommonFn ? isCommonFn(openNote) : false;

                let html = `<div class="flex border-b border-stone-700/50 last:border-0 relative">
                    <!-- Open Note Area (Left of Nut) -->
                    <div class="w-10 bg-stone-900 flex items-center justify-center relative z-20 shrink-0">
                        ${commonOpen ? `<div class="absolute w-8 h-8 rounded-full border-2 border-red-500 bg-red-500/20 z-0 animate-pulse pointer-events-none"></div>` : ''}
                        
                        ${inScaleOpen ? `
                            <div class="z-10 w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-bold shadow-sm transition-all relative
                            ${rootOpen ? 'bg-cyan-500 text-stone-900 scale-125' : 'bg-stone-700 text-stone-200 border border-stone-500'}
                            ${commonOpen ? 'ring-2 ring-red-500 ring-offset-2 ring-offset-stone-800' : ''}">
                                ${openNote}
                            </div>
                        ` : (commonOpen ? `<div class="z-10 w-4 h-4 rounded-full bg-red-600 flex items-center justify-center text-[7px] font-bold text-white shadow-lg relative">${openNote}</div>` : `<span class="text-[10px] text-stone-500 font-bold">${startNote}</span>`)}
                    </div>
                    <!-- The Nut -->
                    <div class="w-2 border-r-4 border-stone-400 bg-stone-600 z-20 shrink-0"></div>`;
                
                // Loop through actual frets (1-12)
                for (let i = 1; i < 13; i++) {
                    const currentNote = NOTES[(startIdx + i) % 12];
                    const inScale = isNoteInScale(currentNote);
                    const root = isRoot(currentNote);
                    const common = isCommonFn ? isCommonFn(currentNote) : false;
                    
                    html += `
                        <div class="flex-1 border-r border-stone-600 relative h-8 flex items-center justify-center">
                            <div class="absolute w-full h-[1px] bg-stone-500 z-0 top-1/2"></div>
                            
                            ${common ? `
                                <!-- Outer Pulsing Ring (Larger and Higher Z-Index) -->
                                <div class="absolute w-10 h-10 rounded-full border-2 border-red-500 bg-red-500/20 z-0 animate-pulse pointer-events-none"></div>
                            ` : ''}

                            ${inScale ? `
                                <div class="z-10 w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-bold shadow-sm transition-all relative
                                ${root ? 'bg-cyan-500 text-stone-900 scale-125' : 'bg-stone-700 text-stone-200 border border-stone-500'}
                                ${common ? 'ring-2 ring-red-500 ring-offset-2 ring-offset-stone-800' : ''}">
                                    ${currentNote}
                                </div>
                            ` : (common ? `<div class="z-10 w-4 h-4 rounded-full bg-red-600 flex items-center justify-center text-[7px] font-bold text-white shadow-lg relative">${currentNote}</div>` : '')}
                        </div>
                    `;
                }
                html += `</div>`;
                return html;
            };

            // Piano Render Helper
            const getPianoKeyClasses = (note, isBlack, isCommon) => {
                const inScale = isNoteInScale(note);
                const root = isRoot(note);

                // Common Note Override/Overlay
                if (isCommon) {
                     if (inScale) return isBlack ? 'bg-red-900 border-b-4 border-red-600' : 'bg-red-100 border-b-4 border-red-500';
                     return isBlack ? 'bg-red-900 opacity-80' : 'bg-red-200 opacity-80';
                }

                if (studio.pianoDisplayMode === 'accent') {
                    // Accent Mode
                    if (isBlack) {
                        if (root) return 'bg-cyan-700 ring-4 ring-cyan-500/50';
                        if (inScale) return 'bg-cyan-600';
                        return 'bg-gray-700 opacity-40';
                    } else {
                        if (root) return 'bg-cyan-300 ring-4 ring-cyan-400/50';
                        if (inScale) return 'bg-cyan-100';
                        return 'bg-gray-200 opacity-40';
                    }
                } else {
                    // Gradient Mode
                    if (isBlack) {
                        if (root) return 'bg-cyan-700 shadow-lg';
                        if (inScale) return 'bg-cyan-500';
                        return 'bg-gray-700 opacity-20';
                    } else {
                        if (root) return 'bg-cyan-300 shadow-lg';
                        if (inScale) return 'bg-cyan-100';
                        return 'bg-gray-200 opacity-20';
                    }
                }
            };

            const renderPiano = (isCommonFn) => {
                const startOctave = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const fullRange = [...startOctave, ...startOctave.slice(0, 5)];
                let html = `<div class="flex justify-center relative h-48 pt-4 select-none overflow-x-auto">`;

                fullRange.forEach((note, idx) => {
                    const isBlack = note.includes('#');
                    const inScale = isNoteInScale(note);
                    const root = isRoot(note);
                    const common = isCommonFn ? isCommonFn(note) : false;
                    const nextIsBlack = fullRange[idx + 1] && fullRange[idx + 1].includes('#');

                    if (isBlack) return; 

                    const whiteKeyClasses = getPianoKeyClasses(note, false, common);

                    html += `
                        <div class="relative group shrink-0">
                            <div class="w-12 h-40 border border-stone-300 rounded-b-lg flex flex-col justify-end items-center pb-2 transition-all duration-300 ${whiteKeyClasses}">
                                ${inScale || common ? `<span class="text-xs font-bold ${root ? 'text-cyan-600' : (common ? 'text-red-600' : 'text-stone-400')}">${note}</span>` : ''}
                            </div>
                            ${nextIsBlack ? `
                                <div class="absolute top-0 -right-4 w-8 h-24 z-10 rounded-b border border-stone-900 transition-all duration-300 ${getPianoKeyClasses(fullRange[idx+1], true, isCommonFn ? isCommonFn(fullRange[idx+1]) : false)}">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
                return html;
            };

            return `
                <div class="h-full flex flex-col bg-stone-800 rounded-xl border border-stone-700 p-6 shadow-inner">
                    
                    <!-- Top Controls: Backing Track -->
                    <div class="mb-6 p-4 bg-stone-900 rounded-lg border border-stone-700 flex flex-col md:flex-row gap-4 items-center justify-between">
                         <div class="flex items-center gap-3 w-full md:w-auto">
                            <div class="flex flex-col flex-1">
                                <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Backing Track</label>
                                <select onchange="studio.visualizerTrackId = this.value; render()" class="bg-stone-800 text-cyan-400 font-bold rounded p-1.5 border border-stone-600 text-sm w-full md:w-48">
                                    <option value="">Select a Track...</option>
                                    ${BACKING_TRACKS.map(t => `<option value="${t.id}" ${studio.visualizerTrackId === t.id ? 'selected' : ''}>${t.title}</option>`).join('')}
                                </select>
                            </div>
                            <button 
                                onclick="const t = BACKING_TRACKS.find(tr => tr.id === studio.visualizerTrackId); if(t) { 
                                    if (audio.isPlayingTrack) { 
                                        audio.stopBackingTrack(); 
                                    } else { 
                                        // Transpose track to current Visualizer Key
                                        const transposed = getTransposedTrack(t, studio.rootKey);
                                        audio.playBackingTrack(transposed); 
                                    }
                                } else { alert('Select a track first'); }"
                                class="mt-4 md:mt-0 p-2 rounded-lg font-bold text-white transition-all ${audio.isPlayingTrack ? 'bg-red-500 hover:bg-red-400' : 'bg-green-600 hover:bg-green-500'} ${!studio.visualizerTrackId ? 'opacity-50 cursor-not-allowed' : ''}">
                                ${audio.isPlayingTrack ? Icon('stop', 'text-lg') : Icon('play', 'text-lg')}
                            </button>
                         </div>

                         <div class="flex items-center gap-4 border-l border-stone-700 pl-4 w-full md:w-auto justify-end">
                              <span class="text-xs font-bold text-stone-500 uppercase">Highlight:</span>
                              <div class="bg-stone-800 p-1 rounded-lg flex gap-1">
                                    <button onclick="studio.visualizerMode = 'key'; render()" 
                                        class="px-3 py-1.5 rounded text-xs font-bold transition-all ${studio.visualizerMode === 'key' ? 'bg-cyan-600 text-white' : 'text-stone-400 hover:text-white'}">
                                        Key Scale
                                    </button>
                                    <button onclick="studio.visualizerMode = 'chord'; render()" 
                                        class="px-3 py-1.5 rounded text-xs font-bold transition-all ${studio.visualizerMode === 'chord' ? 'bg-orange-500 text-white shadow-lg' : 'text-stone-400 hover:text-white'}">
                                        Current Chord
                                    </button>
                              </div>
                              
                              ${isChordMode && isPlaying ? `
                                  <div class="bg-stone-800 p-1 rounded-lg ml-2">
                                      <button onclick="studio.showCommonNotes = !studio.showCommonNotes; render()" 
                                          class="px-3 py-1.5 rounded text-xs font-bold transition-all ${studio.showCommonNotes ? 'bg-red-600 text-white shadow-[0_0_10px_rgba(220,38,38,0.5)]' : 'text-stone-400 hover:text-red-400'}">
                                          Common Notes
                                      </button>
                                  </div>
                              ` : ''}

                              <div class="h-8 w-px bg-stone-700 mx-2 hidden md:block"></div>

                              <!-- Note Hunt Toggle -->
                              <button onclick="studio.toggleNoteHunt()" 
                                  class="flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${studio.noteHuntActive ? 'bg-orange-600 text-white animate-pulse' : 'bg-stone-800 text-stone-400 hover:bg-stone-700'}">
                                  ${Icon('target', 'text-lg')}
                                  <span>${studio.noteHuntActive ? 'HUNT ACTIVE' : 'NOTE HUNT'}</span>
                              </button>
                         </div>
                    </div>

                    <!-- Note Hunt Game Dashboard -->
                    ${studio.noteHuntActive ? `
                        <div class="mb-6 p-4 bg-orange-600/10 border border-orange-500/30 rounded-xl flex items-center justify-between animate-fade-in">
                            <div class="flex items-center gap-6">
                                <div>
                                    <span class="text-[10px] font-bold uppercase text-orange-500 block mb-1">Target Note</span>
                                    <div class="text-4xl font-black text-white font-mono">${studio.targetNote}</div>
                                </div>
                                <div class="h-10 w-px bg-orange-500/30"></div>
                                <div>
                                    <span class="text-[10px] font-bold uppercase text-orange-500 block mb-1">Score</span>
                                    <div class="text-4xl font-black text-orange-500 font-mono">${studio.huntScore}</div>
                                </div>
                            </div>
                            <div class="text-right hidden md:block">
                                <p class="text-xs text-stone-400 max-w-[200px]">Play the target note anywhere on your instrument to score!</p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Scale Recommendations (Context Aware) -->
                    ${studio.visualizerTrackId ? (() => {
                        const originalTrack = BACKING_TRACKS.find(t => t.id === studio.visualizerTrackId);
                        const transposedTrack = getTransposedTrack(originalTrack, studio.rootKey);
                        const bestScale = transposedTrack.overallScales[0];
                        const altScales = transposedTrack.overallScales.slice(1);
                        
                        return `
                            <div class="mb-6 bg-stone-900/50 border border-stone-700/50 rounded-lg p-3">
                                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold uppercase text-green-500 bg-green-500/10 px-2 py-1 rounded">Best Match</span>
                                        <button onclick="studio.scaleType = '${bestScale.type}'; render()" 
                                            class="text-sm font-bold text-white hover:text-green-400 transition-colors flex items-center gap-1 ${studio.scaleType === bestScale.type ? 'underline decoration-green-500 decoration-2 underline-offset-4' : ''}">
                                            ${bestScale.root} ${bestScale.type.replace('_', ' ')}
                                            ${studio.scaleType === bestScale.type ? Icon('check', 'text-green-500') : ''}
                                        </button>
                                    </div>
                                    
                                    ${altScales.length > 0 ? `
                                        <div class="h-4 w-px bg-stone-700 hidden md:block"></div>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="text-[10px] font-bold uppercase text-stone-500">Try Also:</span>
                                            ${altScales.map(s => `
                                                <button onclick="studio.scaleType = '${s.type}'; render()" 
                                                    class="text-xs font-medium text-stone-400 hover:text-white transition-colors border border-stone-700 px-2 py-1 rounded hover:bg-stone-800 ${studio.scaleType === s.type ? 'bg-stone-700 text-white border-stone-600' : ''}">
                                                    ${s.root} ${s.type.replace('_', ' ')}
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    })() : ''}

                    <!-- Main Controls: Key & View -->
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-4 ${isChordMode && isPlaying ? 'opacity-50 pointer-events-none grayscale transition-all' : ''}">
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold uppercase text-stone-500">Key</label>
                                <select onchange="studio.rootKey = this.value; render()" class="bg-stone-900 text-cyan-400 font-bold rounded p-1 border border-stone-700">
                                    ${NOTES.map(n => `<option value="${n}" ${studio.rootKey === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-[10px] font-bold uppercase text-stone-500">Scale</label>
                                <select onchange="studio.scaleType = this.value; render()" class="bg-stone-900 text-cyan-400 font-bold rounded p-1 border border-stone-700">
                                    <option value="major" ${studio.scaleType === 'major' ? 'selected' : ''}>Major</option>
                                    <option value="minor" ${studio.scaleType === 'minor' ? 'selected' : ''}>Minor</option>
                                    <option value="pentatonic_maj" ${studio.scaleType === 'pentatonic_maj' ? 'selected' : ''}>Pent. Maj</option>
                                    <option value="pentatonic_min" ${studio.scaleType === 'pentatonic_min' ? 'selected' : ''}>Pent. Min</option>
                                </select>
                            </div>
                            ${isChordMode && isPlaying ? `<span class="text-xs text-orange-400 font-bold animate-pulse ml-2">Following Chord...</span>` : ''}
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="bg-stone-900 p-1 rounded-lg flex gap-1">
                                 <button onclick="studio.viewMode = 'guitar'; render()" class="p-2 rounded transition-all ${studio.viewMode === 'guitar' ? 'bg-stone-700 text-cyan-300' : 'text-stone-500'}">
                                    ${Icon('guitar', 'text-lg')}
                                 </button>
                                 <button onclick="studio.viewMode = 'piano'; render()" class="p-2 rounded transition-all ${studio.viewMode === 'piano' ? 'bg-stone-700 text-cyan-300' : 'text-stone-500'}">
                                    ${Icon('piano-keys', 'text-lg')}
                                 </button>
                            </div>
                            ${studio.viewMode === 'piano' ? `
                                <div class="h-6 w-px bg-stone-700"></div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-stone-400">Mode:</span>
                                    <div class="bg-stone-900 p-1 rounded-lg flex gap-1">
                                        <button
                                            onclick="studio.pianoDisplayMode = 'accent'; render()"
                                            class="px-3 py-1 text-xs rounded transition-all ${studio.pianoDisplayMode === 'accent' ? 'bg-cyan-500 text-white' : 'text-stone-500 hover:text-stone-300'}">
                                            Accent
                                        </button>
                                        <button
                                            onclick="studio.pianoDisplayMode = 'gradient'; render()"
                                            class="px-3 py-1 text-xs rounded transition-all ${studio.pianoDisplayMode === 'gradient' ? 'bg-cyan-500 text-white' : 'text-stone-500 hover:text-stone-300'}">
                                            Gradient
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="flex-1 bg-stone-900 rounded-xl border border-stone-700 p-4 overflow-x-auto shadow-inner flex items-center justify-center">
                         ${(() => {
                             // Calculate Common Notes if enabled
                             let commonNotes = [];
                             if (studio.showCommonNotes && audio.activeTrack && audio.isPlayingTrack) {
                                 // Use the transposed track to match the current Key context!
                                 const transposedForCommon = getTransposedTrack(audio.activeTrack, studio.rootKey);
                                 commonNotes = studio.getCommonNotes(transposedForCommon);
                             }
                             const isCommon = (n) => commonNotes.includes(n);

                             if (studio.viewMode === 'guitar') {
                                return `
                                    <div class="w-full min-w-[300px]">
                                        ${['E','B','G','D','A','E'].map(n => renderString(n, isCommon)).join('')}
                                        <div class="flex pl-10 pt-1">
                                            ${[0,1,2,3,4,5,6,7,8,9,10,11,12].map(n => `<div class="flex-1 text-center text-[8px] text-stone-600">${n}</div>`).join('')}
                                        </div>
                                    </div>
                                `;
                             } else {
                                return renderPiano(isCommon);
                             }
                         })()}
                    </div>
                </div>
            `;
        }

        function renderStudio() {
            const mod = appState.studioModule;
            
            return `
                <div class="min-h-screen bg-stone-950 text-white pt-20 pb-24 px-4">
                    <!-- Studio Header -->
                    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-end border-b border-stone-800 pb-4">
                        <div>
                            <h2 class="text-xs font-bold uppercase tracking-widest text-cyan-500 mb-1">Interactive Tools</h2>
                            <h1 class="text-4xl font-black font-serif bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">SONIC STUDIO</h1>
                        </div>
                        <div class="hidden md:block text-right">
                             <div class="text-xs text-stone-500 font-mono uppercase">Status: Active</div>
                        </div>
                    </div>

                    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">
                        <!-- Sidebar -->
                        <div class="bg-stone-900 rounded-2xl p-4 h-fit border border-stone-800 shadow-lg">
                            <h3 class="text-xs font-bold text-stone-500 uppercase tracking-widest mb-4">Modules</h3>
                            <div class="flex flex-col gap-2">
                                ${['jamstation', 'tuner', 'looper', 'visualizer', 'spark'].map(m => `
                                    <button onclick="setStudioModule('${m}')" 
                                        class="text-left p-3 rounded-xl font-medium capitalize flex items-center gap-3 transition-all 
                                        ${mod === m ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/30' : 'hover:bg-stone-800 text-stone-400'}">
                                        ${m === 'jamstation' ? Icon('faders', 'text-lg') : ''}
                                        ${m === 'tuner' ? Icon('microphone', 'text-lg') : ''}
                                        ${m === 'looper' ? Icon('repeat', 'text-lg') : ''}
                                        ${m === 'visualizer' ? Icon('sliders', 'text-lg') : ''}
                                        ${m === 'spark' ? Icon('lightning', 'text-lg') : ''}
                                        <span>${m === 'jamstation' ? 'Jam Mixer' : (m === 'spark' ? 'Spark' : m)}</span>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="mt-8 p-4 bg-stone-800/50 rounded-xl text-xs text-stone-500 leading-relaxed border border-stone-800">
                                <strong class="text-stone-400 block mb-2 uppercase">Quick Tips</strong>
                                ${mod === 'tuner' ? 'Use a quiet room for best results. The ring turns green when you are within 5 cents.' : ''}
                                ${mod === 'looper' ? 'Wear headphones to prevent the mic from recording the speaker output (feedback).' : ''}
                                ${mod === 'visualizer' ? 'Select a key and scale to visualize safe notes on the fretboard or piano.' : ''}
                                ${mod === 'jamstation' ? 'This mixer controls the "Jam Station" backing tracks found in the main menu.' : ''}
                                ${mod === 'spark' ? 'Use the generated constraints to force yourself out of your usual patterns.' : ''}
                            </div>
                        </div>

                        <!-- Main Module Area -->
                        <div class="md:col-span-3 min-h-[500px]">
                            ${mod === 'spark' ? renderSparkGenerator() : ''}
                            ${mod === 'jamstation' ? `
                                <div class="h-full flex flex-col bg-stone-800 rounded-xl border border-stone-700 p-8 shadow-2xl relative overflow-hidden">
                                    <div class="flex justify-between items-center mb-8">
                                        <div class="flex items-center gap-4">
                                            <h2 class="text-2xl font-bold text-white">Jam Mixer</h2>
                                            <button onclick="studio.togglePlay()" class="p-3 rounded-full transition-all ${studio.isPlaying ? 'bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]' : 'bg-green-500 hover:bg-green-400'}">
                                                ${studio.isPlaying ? Icon('stop', 'text-white text-lg') : Icon('play', 'text-white text-lg')}
                                            </button>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <div class="flex flex-col items-end">
                                                 <span class="text-[10px] text-stone-400 font-bold uppercase">BPM</span>
                                                 <div class="flex items-center gap-2">
                                                    <span class="font-mono text-cyan-400 w-8 text-right">${studio.bpm}</span>
                                                    <input type="range" min="40" max="220" value="${studio.bpm}" oninput="studio.bpm = this.value; this.previousElementSibling.innerText = this.value" class="w-20 accent-cyan-500 h-1 bg-stone-700 rounded-lg appearance-none"/>
                                                 </div>
                                            </div>
                                            <div class="flex gap-2 bg-stone-900 p-2 rounded-lg">
                                                ${[0,1,2,3].map(b => `<div class="beat-dot w-3 h-3 rounded-full bg-stone-700 transition-colors duration-75"></div>`).join('')}
                                            </div>
                                        </div>
                                    </div>

                                    ${studio.selectedProgression ? `
                                        <!-- Current Chord Display -->
                                        <div class="mb-6 text-center bg-stone-900/50 rounded-xl p-4 border border-cyan-500/20">
                                            <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-1">Current Chord</div>
                                            <div class="text-3xl font-black text-cyan-400">${studio.selectedProgression[studio.currentChordIndex].name}</div>
                                            <div class="text-sm text-stone-500 italic">${studio.selectedProgression[studio.currentChordIndex].theory}</div>
                                        </div>
                                    ` : ''}

                                    <!-- Volume Faders -->
                                    <div class="grid grid-cols-4 gap-4 mb-6">
                                        ${Object.entries(studio.volumes).map(([inst, vol]) => `
                                            <div class="bg-stone-900 rounded-xl p-3 flex flex-col items-center gap-2 border border-stone-800">
                                                <span class="font-bold uppercase text-xs text-stone-400">${inst}</span>
                                                <div class="h-20 w-6 bg-stone-800 rounded-full relative overflow-hidden border border-stone-700">
                                                    <div class="absolute bottom-0 w-full bg-cyan-500 transition-all" style="height: ${vol * 100}%"></div>
                                                    <input type="range" min="0" max="1" step="0.1" value="${vol}"
                                                        oninput="studio.volumes['${inst}'] = parseFloat(this.value); this.previousElementSibling.style.height = (this.value * 100) + '%'"
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical;"/>
                                                </div>
                                                <span class="text-[10px] text-cyan-400 font-mono">${Math.round(vol * 100)}%</span>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <!-- Detailed Controls -->
                                    <div class="space-y-4 overflow-y-auto max-h-[400px]">
                                        <!-- BASS CONTROLS -->
                                        <div class="bg-stone-900 rounded-xl p-4 border border-stone-800">
                                            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
                                                Bass Synth
                                            </h3>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                <!-- Chord Progression -->
                                                <div class="flex flex-col md:col-span-2">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Chord Progression ${studio.selectedProgression ? '<span class="text-green-400">●</span>' : ''}</label>
                                                    <select onchange="if(this.value === 'none') { studio.selectedProgression = null; } else { studio.selectedProgression = BACKING_TRACKS.find(t => t.id === this.value).progression; studio.currentChordIndex = 0; studio.beatsInCurrentChord = 0; } render()" class="bg-stone-800 text-cyan-400 font-bold rounded p-1 border border-stone-700 text-sm">
                                                        <option value="none" ${!studio.selectedProgression ? 'selected' : ''}>None (Manual Root)</option>
                                                        ${BACKING_TRACKS.map(t => `<option value="${t.id}" ${studio.selectedProgression && studio.selectedProgression === t.progression ? 'selected' : ''}>${t.title}</option>`).join('')}
                                                    </select>
                                                </div>
                                                <!-- Bass Note (Manual) -->
                                                <div class="flex flex-col ${studio.selectedProgression ? 'opacity-50' : ''}">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Root Note</label>
                                                    <select onchange="studio.bassNote = this.value; render()" class="bg-stone-800 text-cyan-400 font-bold rounded p-1 border border-stone-700 text-sm" ${studio.selectedProgression ? 'disabled' : ''}>
                                                        ${NOTES.map(n => `<option value="${n}" ${studio.bassNote === n ? 'selected' : ''}>${n}</option>`).join('')}
                                                    </select>
                                                </div>
                                                <!-- Waveform -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Wave</label>
                                                    <select onchange="studio.bassWaveform = this.value" class="bg-stone-800 text-cyan-400 font-bold rounded p-1 border border-stone-700 text-sm">
                                                        <option value="sawtooth" ${studio.bassWaveform === 'sawtooth' ? 'selected' : ''}>Saw</option>
                                                        <option value="square" ${studio.bassWaveform === 'square' ? 'selected' : ''}>Square</option>
                                                        <option value="triangle" ${studio.bassWaveform === 'triangle' ? 'selected' : ''}>Triangle</option>
                                                        <option value="sine" ${studio.bassWaveform === 'sine' ? 'selected' : ''}>Sine</option>
                                                    </select>
                                                </div>
                                                <!-- Bassline Pattern -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Pattern</label>
                                                    <select onchange="studio.bassPattern = this.value" class="bg-stone-800 text-cyan-400 font-bold rounded p-1 border border-stone-700 text-sm">
                                                        <option value="root" ${studio.bassPattern === 'root' ? 'selected' : ''}>Root Only</option>
                                                        <option value="octave" ${studio.bassPattern === 'octave' ? 'selected' : ''}>Octave Jump</option>
                                                        <option value="walking" ${studio.bassPattern === 'walking' ? 'selected' : ''}>Walking Bass</option>
                                                        <option value="arpeggio" ${studio.bassPattern === 'arpeggio' ? 'selected' : ''}>Arpeggio</option>
                                                        <option value="jazz" ${studio.bassPattern === 'jazz' ? 'selected' : ''}>Jazz Walk</option>
                                                    </select>
                                                </div>
                                                <!-- Attack -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Attack <span class="text-cyan-400">${(studio.bassAttack * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.001" max="0.5" step="0.001" value="${studio.bassAttack}"
                                                        oninput="studio.bassAttack = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Decay -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Decay <span class="text-cyan-400">${(studio.bassDecay * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.01" max="1" step="0.01" value="${studio.bassDecay}"
                                                        oninput="studio.bassDecay = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Sustain -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Sustain <span class="text-cyan-400">${Math.round(studio.bassSustain * 100)}%</span></label>
                                                    <input type="range" min="0" max="1" step="0.01" value="${studio.bassSustain}"
                                                        oninput="studio.bassSustain = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = Math.round(this.value * 100) + '%'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Release -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Release <span class="text-cyan-400">${(studio.bassRelease * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.01" max="2" step="0.01" value="${studio.bassRelease}"
                                                        oninput="studio.bassRelease = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Filter Cutoff -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Filter <span class="text-cyan-400">${studio.bassFilterCutoff}Hz</span></label>
                                                    <input type="range" min="50" max="5000" step="10" value="${studio.bassFilterCutoff}"
                                                        oninput="studio.bassFilterCutoff = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = this.value + 'Hz'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Filter Resonance -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Resonance <span class="text-cyan-400">${studio.bassFilterResonance.toFixed(1)}</span></label>
                                                    <input type="range" min="0" max="20" step="0.1" value="${studio.bassFilterResonance}"
                                                        oninput="studio.bassFilterResonance = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = parseFloat(this.value).toFixed(1)"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Distortion -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Distortion <span class="text-cyan-400">${Math.round(studio.bassDistortion * 100)}%</span></label>
                                                    <input type="range" min="0" max="1" step="0.01" value="${studio.bassDistortion}"
                                                        oninput="studio.bassDistortion = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = Math.round(this.value * 100) + '%'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <!-- Sub Oscillator -->
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Sub Osc <span class="text-cyan-400">${Math.round(studio.bassSubOscLevel * 100)}%</span></label>
                                                    <input type="range" min="0" max="1" step="0.01" value="${studio.bassSubOscLevel}"
                                                        oninput="studio.bassSubOscLevel = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = Math.round(this.value * 100) + '%'"
                                                        class="w-full accent-cyan-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- KICK CONTROLS -->
                                        <div class="bg-stone-900 rounded-xl p-4 border border-stone-800">
                                            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                                                Kick Drum
                                            </h3>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Pitch <span class="text-cyan-400">${studio.kickPitch}Hz</span></label>
                                                    <input type="range" min="30" max="300" step="1" value="${studio.kickPitch}"
                                                        oninput="studio.kickPitch = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = this.value + 'Hz'"
                                                        class="w-full accent-orange-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Decay <span class="text-cyan-400">${(studio.kickDecay * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.05" max="2" step="0.01" value="${studio.kickDecay}"
                                                        oninput="studio.kickDecay = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-orange-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- SNARE CONTROLS -->
                                        <div class="bg-stone-900 rounded-xl p-4 border border-stone-800">
                                            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                                Snare Drum
                                            </h3>
                                            <div class="grid grid-cols-3 gap-3">
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Pitch <span class="text-cyan-400">${studio.snarePitch}Hz</span></label>
                                                    <input type="range" min="100" max="400" step="1" value="${studio.snarePitch}"
                                                        oninput="studio.snarePitch = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = this.value + 'Hz'"
                                                        class="w-full accent-red-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Decay <span class="text-cyan-400">${(studio.snareDecay * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.05" max="1" step="0.01" value="${studio.snareDecay}"
                                                        oninput="studio.snareDecay = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-red-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Noise Mix <span class="text-cyan-400">${Math.round(studio.snareNoiseBalance * 100)}%</span></label>
                                                    <input type="range" min="0" max="1" step="0.01" value="${studio.snareNoiseBalance}"
                                                        oninput="studio.snareNoiseBalance = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = Math.round(this.value * 100) + '%'"
                                                        class="w-full accent-red-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- HIHAT CONTROLS -->
                                        <div class="bg-stone-900 rounded-xl p-4 border border-stone-800">
                                            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                                Hi-Hat
                                            </h3>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Pitch <span class="text-cyan-400">${studio.hihatPitch}Hz</span></label>
                                                    <input type="range" min="4000" max="12000" step="100" value="${studio.hihatPitch}"
                                                        oninput="studio.hihatPitch = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = this.value + 'Hz'"
                                                        class="w-full accent-yellow-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="text-[10px] font-bold uppercase text-stone-500 mb-1">Decay <span class="text-cyan-400">${(studio.hihatDecay * 1000).toFixed(0)}ms</span></label>
                                                    <input type="range" min="0.02" max="0.5" step="0.01" value="${studio.hihatDecay}"
                                                        oninput="studio.hihatDecay = parseFloat(this.value); this.previousElementSibling.querySelector('span').innerText = (this.value * 1000).toFixed(0) + 'ms'"
                                                        class="w-full accent-yellow-500 h-1 bg-stone-800 rounded-lg appearance-none"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            ${mod === 'tuner' ? renderTuner() : ''}
                            ${mod === 'looper' ? renderLooper() : ''}
                            ${mod === 'visualizer' ? renderVisualizer() : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            return `
                <div class="min-h-screen bg-[#f4f1ea] dark:bg-stone-950 pt-20 pb-12 px-4 flex flex-col items-center justify-center text-center transition-colors">
                    <div class="max-w-4xl w-full border-4 border-double border-stone-800 dark:border-stone-600 p-8 md:p-16 relative bg-white dark:bg-stone-900 shadow-xl transition-colors">
                        <div class="absolute top-4 left-4 right-4 flex justify-between border-b-2 border-stone-900 dark:border-stone-500 pb-2">
                            <span class="font-bold tracking-widest uppercase text-xs md:text-sm text-stone-500">Vol. I - VI</span>
                            <span class="font-bold tracking-widest uppercase text-xs md:text-sm text-stone-500">The Workstation Ed.</span>
                        </div>
                        
                        <div class="mt-12 mb-12">
                            <h1 class="text-6xl md:text-9xl font-black font-serif tracking-tighter text-stone-900 dark:text-stone-100 mb-4 leading-[0.8]">
                                THE<br/>SHED
                            </h1>
                            <div class="h-1 w-24 bg-orange-600 mx-auto my-6"></div>
                            <p class="text-xl md:text-3xl font-serif italic text-stone-600 dark:text-stone-300">
                                The Musician’s Workstation
                            </p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-8 text-left border-t-2 border-stone-900 dark:border-stone-500 pt-8">
                            <div>
                                <h3 class="font-bold uppercase tracking-wider mb-2 text-orange-600">Methodology</h3>
                                <p class="text-sm text-stone-600 dark:text-stone-400 leading-relaxed">
                                    Psychological tricks and physical techniques of history's greatest, now actionable.
                                </p>
                            </div>
                            <div>
                                <h3 class="font-bold uppercase tracking-wider mb-2 text-orange-600">Jam Station</h3>
                                <p class="text-sm text-stone-600 dark:text-stone-400 leading-relaxed">
                                    Integrated metronome, drone synth, and full backing tracks for practice.
                                </p>
                            </div>
                            <div>
                                <h3 class="font-bold uppercase tracking-wider mb-2 text-orange-600">Focus Mode</h3>
                                <p class="text-sm text-stone-600 dark:text-stone-400 leading-relaxed">
                                    Build your routine. Save your favorite drills. Use the focus timer to master them.
                                </p>
                            </div>
                        </div>

                        <button onclick="setView('musician', VOLUMES[0].musicians[0])" 
                            class="mt-12 bg-stone-900 dark:bg-white text-white dark:text-stone-900 px-8 py-4 rounded-full font-bold uppercase tracking-widest hover:scale-105 transition-transform shadow-lg cursor-pointer">
                            Start Practicing
                        </button>
                    </div>
                </div>
            `;
        }

        // ... (renderMusician, renderPractice, renderMyShed, renderChallenge, renderChallengeContent logic remains unchanged)
        function renderMusician() {
            const m = appState.data;
            const next = getNeighborMusician(m.id, 'next');
            const prev = getNeighborMusician(m.id, 'prev');
            const nextId = next ? next.id : null;
            const prevId = prev ? prev.id : null;

            // --- THEME LOGIC ---
            // Check for specific artist theme or default to orange
            const accentColor = m.theme === 'purple' ? 'text-purple-600' : 'text-orange-600';
            const borderColor = m.theme === 'purple' ? 'border-purple-500' : 'border-orange-500';
            const hoverBorder = m.theme === 'purple' ? 'hover:border-purple-200 dark:hover:border-purple-900' : 'hover:border-orange-200 dark:hover:border-orange-900';
            const hoverText = m.theme === 'purple' ? 'hover:text-purple-600' : 'hover:text-orange-600';

            return `
                <div class="min-h-screen bg-white dark:bg-stone-950 pt-20 pb-20 transition-colors">
                    <div class="relative px-4 md:px-12 mb-12">
                        <div class="max-w-4xl mx-auto">
                            <span class="block ${accentColor} font-bold tracking-[0.2em] text-sm uppercase mb-2">${m.archetype}</span>
                            <h1 class="text-5xl md:text-7xl font-black font-serif text-stone-900 dark:text-white mb-6 leading-none tracking-tight">
                                ${m.name}
                            </h1>
                            <div class="relative pl-8 md:pl-12 border-l-4 border-stone-300 dark:border-stone-700 py-2">
                                <p class="text-2xl md:text-3xl font-serif italic text-stone-500 dark:text-stone-400 leading-tight">
                                    "${m.quote}"
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 md:px-12 mb-16">
                        <div class="max-w-2xl mx-auto">
                            <p class="text-lg md:text-xl leading-relaxed text-stone-800 dark:text-stone-200 font-serif">
                                <span class="float-left text-6xl font-black font-serif mr-3 mt-[-8px] text-stone-900 dark:text-white">${m.origin.charAt(0)}</span>
                                ${m.origin.slice(1)}
                            </p>
                        </div>
                    </div>

                    <div class="px-4 md:px-12 bg-[#f8f7f4] dark:bg-[#1c1917] py-16 transition-colors">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-3xl font-black font-serif mb-8 text-center text-stone-900 dark:text-white">Techniques & Hacks</h2>
                            <div class="grid md:grid-cols-2 gap-6">
                                ${m.lessons.map((l, i) => {
                                    const saved = isSaved(l.id);
                                    // Use custom labels if provided, else default
                                    const theoryLabel = l.theoryLabel || "The Theory";
                                    const drillLabel = l.drillLabel || "The Drill";

                                    return `
                                    <div class="bg-stone-50 dark:bg-stone-800/50 border border-stone-200 dark:border-stone-700 p-6 rounded-lg mb-6 relative overflow-hidden group ${hoverBorder} transition-colors">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="text-xl font-bold font-serif pr-8 text-stone-900 dark:text-white">${l.title}</h3>
                                            <button onclick="const all = getAllMusicians(); const mus = all.find(x => x.id === '${m.id}'); toggleSaveLesson(mus.lessons[${i}])" class="text-stone-400 hover:${accentColor.split(' ')[0]} ${saved ? accentColor : ''}">
                                                ${Icon(saved ? 'star-fill' : 'star', 'text-xl')}
                                            </button>
                                        </div>
                                        <div class="mb-4">
                                            <span class="text-xs font-bold uppercase tracking-wider ${accentColor} mb-1 block">${theoryLabel}</span>
                                            <p class="text-stone-700 dark:text-stone-300 italic font-serif leading-relaxed">"${l.theory}"</p>
                                        </div>
                                        <div class="bg-white dark:bg-stone-900 p-4 rounded border-l-4 ${borderColor.replace('text', 'border')} mb-4">
                                            <span class="text-xs font-bold uppercase tracking-wider text-stone-400 mb-1 block flex items-center gap-2">
                                                ${Icon('lightning', 'text-sm')} ${drillLabel}
                                            </span>
                                            <p class="text-stone-800 dark:text-stone-200 text-sm font-medium leading-relaxed">${l.drill}</p>
                                        </div>
                                        <button onclick="const all = getAllMusicians(); const mus = all.find(x => x.id === '${m.id}'); setView('practice', mus.lessons[${i}])" 
                                            class="w-full flex items-center justify-center gap-2 bg-stone-900 dark:bg-white text-white dark:text-stone-900 py-3 rounded font-bold text-sm uppercase tracking-widest hover:opacity-90 transition-opacity">
                                            ${Icon('timer', 'text-lg')} Start Practice (${l.duration || 10}m)
                                        </button>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <!-- Artist Specific Challenge Section -->
                            ${m.artistChallenge ? `
                                <div class="mt-12 bg-stone-900 dark:bg-stone-800 p-8 rounded-xl border border-stone-800 dark:border-stone-700 text-center relative overflow-hidden">
                                    <div class="relative z-10">
                                        <span class="inline-block px-3 py-1 rounded-full bg-white/10 text-white/70 text-xs font-bold uppercase tracking-wider mb-4">Artist Challenge</span>
                                        <h3 class="text-2xl font-bold text-white mb-2">${m.artistChallenge.title}</h3>
                                        <p class="text-stone-300 max-w-lg mx-auto leading-relaxed mb-6">
                                            ${m.artistChallenge.description}
                                        </p>
                                    </div>
                                    <!-- Decorative bg element -->
                                    <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-${m.theme === 'purple' ? 'purple' : 'orange'}-600/20 rounded-full blur-3xl"></div>
                                </div>
                            ` : ''}

                        </div>
                    </div>

                    <div class="flex justify-between items-center px-4 md:px-12 py-8">
                         <button onclick="${prevId ? `setView('musician', getAllMusicians().find(m=>m.id==='${prevId}'))` : ''}" 
                            class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider ${!prevId ? 'opacity-30 cursor-not-allowed' : hoverText}">
                            ${Icon('caret-left', 'text-xl')}
                            <span class="hidden md:inline">Previous</span>
                        </button>
                        <button onclick="${nextId ? `setView('musician', getAllMusicians().find(m=>m.id==='${nextId}'))` : ''}" 
                            class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider ${!nextId ? 'opacity-30 cursor-not-allowed' : hoverText}">
                            <span class="hidden md:inline">Next Artist</span>
                            ${Icon('caret-right', 'text-xl')}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPractice() {
            const l = appState.data; // Lesson object
            const nextL = appState.isRoutineActive ? appState.savedLessons[appState.routineIndex + 1] : null;

            return `
                <div class="min-h-screen bg-stone-900 text-white flex flex-col pt-20 pb-32">
                    <div class="max-w-2xl mx-auto w-full px-6 flex-1 flex flex-col">
                        
                        <div class="mb-8 flex justify-between items-start">
                            <div>
                                <button onclick="setView('home')" class="text-stone-500 hover:text-white flex items-center gap-2 mb-4">
                                    ${Icon('arrow-left')} Exit Focus Mode
                                </button>
                                <h2 class="text-orange-500 text-xs font-bold uppercase tracking-[0.2em] mb-2">${appState.isRoutineActive ? `Routine: Step ${appState.routineIndex + 1} of ${appState.savedLessons.length}` : 'Current Session'}</h2>
                                <h1 class="text-3xl md:text-5xl font-serif font-black mb-4">${l.title}</h1>
                                <p class="text-stone-400 italic text-xl">"${l.theory}"</p>
                            </div>
                            ${appState.isRoutineActive ? `
                                <button onclick="nextRoutineStep()" class="bg-stone-800 hover:bg-stone-700 text-stone-300 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider border border-stone-700">
                                    Skip Step
                                </button>
                            ` : ''}
                        </div>

                        <div class="flex-1 flex flex-col items-center justify-center mb-8">
                            <!-- Timer Circle -->
                            <div class="relative w-64 h-64 flex items-center justify-center rounded-full border-4 ${appState.timerActive ? 'border-orange-500 animate-pulse' : 'border-stone-700'} bg-stone-800 shadow-2xl mb-8">
                                <div class="text-center">
                                    <span id="timer-display" class="block text-6xl font-mono font-bold">${appState.timeLeft > 0 ? Math.floor(appState.timeLeft/60) + ':' + (appState.timeLeft%60 < 10 ? '0' : '') + (appState.timeLeft%60) : (l.duration || 10) + ':00'}</span>
                                    <span class="text-xs uppercase text-stone-500 font-bold tracking-widest mt-1">Remaining</span>
                                </div>
                            </div>

                            <button onclick="startTimer()" class="bg-white text-black px-12 py-4 rounded-full font-bold text-lg uppercase tracking-widest hover:scale-105 transition-transform">
                                ${appState.timerActive ? 'Pause Session' : 'Start Timer'}
                            </button>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-stone-800 p-6 rounded-xl border border-stone-700">
                                 <h3 class="text-stone-400 text-xs font-bold uppercase mb-2 flex items-center gap-2">
                                    ${Icon('lightning')} The Assignment
                                 </h3>
                                 <p class="text-xl font-medium leading-relaxed">${l.drill}</p>
                            </div>
                            
                            ${nextL ? `
                                <div class="bg-stone-900/50 p-6 rounded-xl border border-stone-800 border-dashed flex flex-col justify-center">
                                     <h3 class="text-stone-600 text-xs font-bold uppercase mb-2">Next Up</h3>
                                     <p class="text-stone-400 font-bold">${nextL.title}</p>
                                     <p class="text-stone-500 text-sm line-clamp-2 mt-1">${nextL.drill}</p>
                                </div>
                            ` : (appState.isRoutineActive ? `
                                <div class="bg-green-900/20 p-6 rounded-xl border border-green-900/30 border-dashed flex items-center justify-center text-green-500/50 font-bold uppercase text-xs tracking-widest">
                                    Final Step
                                </div>
                            ` : '')}
                        </div>

                    </div>
                </div>
            `;
        }

        function renderMyShed() {
            return `
                <div class="min-h-screen bg-stone-50 dark:bg-stone-950 pt-24 pb-20 px-4">
                                    <div class="max-w-3xl mx-auto">
                                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
                                            <div>
                                                <h1 class="text-4xl font-serif font-black mb-2 dark:text-white">My Shed</h1>
                                                <p class="text-stone-500">Your curated list of essential drills.</p>
                                            </div>
                                            ${appState.savedLessons.length > 0 ? `
                                                <button onclick="startRoutine()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-full font-bold uppercase tracking-widest shadow-lg transition-all flex items-center gap-2">
                                                    ${Icon('play-circle', 'text-xl')} Start Routine
                                                </button>
                                            ` : ''}
                                        </div>
                    
                                        ${appState.savedLessons.length === 0 ? `                            <div class="text-center py-20 border-2 border-dashed border-stone-200 dark:border-stone-800 rounded-lg">
                                <p class="text-stone-400">No lessons saved yet. Go explore the volumes and click the star icon.</p>
                                <button onclick="setView('home')" class="mt-4 text-orange-600 font-bold hover:underline">Explore Volumes</button>
                            </div>
                        ` : `
                            <div class="grid gap-4">
                                ${appState.savedLessons.map((l, i) => `
                                    <div class="bg-white dark:bg-stone-900 p-6 rounded-lg shadow-sm border border-stone-200 dark:border-stone-800 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <div>
                                            <h3 class="font-bold font-serif text-lg dark:text-white">${l.title}</h3>
                                            <p class="text-sm text-stone-500 line-clamp-1">${l.drill}</p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button onclick="toggleSaveLesson(appState.savedLessons[${i}])" class="p-2 text-orange-500 hover:bg-orange-50 dark:hover:bg-stone-800 rounded">
                                                ${Icon('trash', 'text-lg')}
                                            </button>
                                            <button onclick="setView('practice', appState.savedLessons[${i}])" class="bg-stone-900 dark:bg-white text-white dark:text-stone-900 px-4 py-2 rounded font-bold text-xs uppercase tracking-wider hover:opacity-90">
                                                Start Practice
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    ${appState.savedSparks.length > 0 ? `
                        <div class="max-w-3xl mx-auto mt-16 pb-12">
                            <h2 class="text-2xl font-serif font-black mb-2 dark:text-white">Saved Ideas</h2>
                            <p class="text-stone-500 mb-8">Song starters from the Spark Generator.</p>
                            <div class="grid gap-4">
                                ${appState.savedSparks.map(spark => `
                                    <div class="bg-white dark:bg-stone-900 p-6 rounded-lg shadow-sm border border-stone-200 dark:border-stone-800 flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <h3 class="font-bold font-serif text-lg dark:text-white">${spark.title}</h3>
                                                <span class="text-[10px] bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-0.5 rounded-full font-bold uppercase tracking-widest">Spark</span>
                                            </div>
                                            <p class="text-xs text-stone-500 font-mono mt-1">${spark.sparkData.progression.pattern}</p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button onclick="studio.deleteSpark('${spark.id}')" class="p-2 text-stone-400 hover:text-red-500 rounded transition-colors">
                                                ${Icon('trash', 'text-lg')}
                                            </button>
                                            <button onclick="setView('jam'); audio.playBackingTrack(appState.savedSparks.find(s => s.id === '${spark.id}'))" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold text-xs uppercase tracking-wider transition-all">
                                                Load to Jam Station
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderChallenge() {
             return `
                <div class="min-h-screen bg-stone-900 text-stone-100 flex flex-col pt-20 pb-32 px-4">
                    <div class="max-w-2xl mx-auto w-full flex-1 flex flex-col justify-center">
                        <div class="text-center mb-8">
                            <h2 class="text-orange-500 font-bold tracking-widest uppercase text-sm mb-2">The Master Workbook</h2>
                            <h1 class="text-4xl md:text-5xl font-black font-serif mb-4">Daily Random Drill</h1>
                        </div>
                        <div id="challenge-container"></div>
                    </div>
                </div>
            `;
        }
        
        // Spin Logic for Challenge
        let spinInterval = null;
        function startSpin() {
             const container = document.getElementById('challenge-container');
             if(!container) return;
             
             const currentList = getCurrentChallenges();
             
             let counter = 0;
             spinInterval = setInterval(() => {
                const r = currentList[Math.floor(Math.random() * currentList.length)];
                container.innerHTML = `
                    <div class="bg-stone-800 border-2 border-stone-700 p-8 rounded-xl shadow-2xl opacity-50 blur-sm scale-95 transform transition-all">
                        <h3 class="text-2xl font-bold text-white">${r.title}</h3>
                    </div>
                `;
                counter++;
                if (counter > 10) {
                    clearInterval(spinInterval);
                    renderChallengeContent(r);
                }
             }, 80);
        }

        function renderChallengeContent(challenge) {
            const container = document.getElementById('challenge-container');
            container.innerHTML = `
                 <div class="bg-stone-800 border-2 border-stone-700 p-8 rounded-xl shadow-2xl">
                    <div class="flex justify-between items-start mb-6">
                        <span class="bg-stone-900 text-stone-400 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">#${challenge.id}</span>
                        <span class="text-orange-500 font-serif italic text-lg">${challenge.artist}</span>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-bold mb-6 text-white leading-tight">${challenge.title}</h3>
                    <p class="text-stone-300 leading-relaxed text-lg mb-8">${challenge.text}</p>
                    <div class="flex justify-center">
                        <button onclick="startSpin()" class="flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-full font-bold transition-colors">
                            ${Icon('shuffle', 'text-xl')} New Card
                        </button>
                    </div>
                </div>
            `;
        }

        // --- MAIN RENDER LOOP ---
        function render() {
            app.innerHTML = '';
            app.innerHTML += renderHeader();
            app.innerHTML += renderSidebar();
            
            let content = '';
            if (appState.view === 'home') content = renderHome();
            else if (appState.view === 'musician') content = renderMusician();
            else if (appState.view === 'practice') content = renderPractice();
            else if (appState.view === 'myshed') content = renderMyShed();
            else if (appState.view === 'challenge') content = renderChallenge();
            else if (appState.view === 'jam') content = renderJamStation();
            else if (appState.view === 'studio') content = renderStudio();
            
            const main = document.createElement('main');
            main.className = 'flex-grow';
            main.innerHTML = content;
            app.appendChild(main);

            // Add Toolbar Container
            const toolbar = document.createElement('div');
            toolbar.id = 'toolbar-container';
            toolbar.className = 'fixed bottom-0 left-0 right-0 h-16 bg-stone-950 border-t border-stone-800 z-50';
            app.appendChild(toolbar);
            renderToolbar();

            if (appState.view === 'challenge') startSpin();
        }

        render();
    </script> 
</body>
</html>
